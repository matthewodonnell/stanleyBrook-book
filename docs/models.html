<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Models | The West Brook Story</title>
  <meta name="description" content="This book describes accessing, cleaning, and analyzing data from the West Brook Study in western MA, USA" />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Models | The West Brook Story" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/images/westBrook.jpg" />
  <meta property="og:description" content="This book describes accessing, cleaning, and analyzing data from the West Brook Study in western MA, USA" />
  <meta name="github-repo" content="bletcher/westBrook-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Models | The West Brook Story" />
  
  <meta name="twitter:description" content="This book describes accessing, cleaning, and analyzing data from the West Brook Study in western MA, USA" />
  <meta name="twitter:image" content="/images/westBrook.jpg" />

<meta name="author" content="Ben Letcher" />


<meta name="date" content="2022-05-25" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
<link rel="prev" href="getData.html"/>
<link rel="next" href="final-words.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#the-west-brook"><i class="fa fa-check"></i><b>1.1</b> The West Brook</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="getData.html"><a href="getData.html"><i class="fa fa-check"></i><b>2</b> Get data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="getData.html"><a href="getData.html#getEnvData"><i class="fa fa-check"></i><b>2.1</b> Get environmental data</a></li>
<li class="chapter" data-level="2.2" data-path="getData.html"><a href="getData.html#dataElectro"><i class="fa fa-check"></i><b>2.2</b> Electrofishing data</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="getData.html"><a href="getData.html#get-data"><i class="fa fa-check"></i><b>2.2.1</b> Get data</a></li>
<li class="chapter" data-level="2.2.2" data-path="getData.html"><a href="getData.html#wrangle-data"><i class="fa fa-check"></i><b>2.2.2</b> Wrangle data</a></li>
<li class="chapter" data-level="2.2.3" data-path="getData.html"><a href="getData.html#explore-data"><i class="fa fa-check"></i><b>2.2.3</b> Explore data</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="getData.html"><a href="getData.html#dataCMR"><i class="fa fa-check"></i><b>2.3</b> Capture-recapture data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="getData.html"><a href="getData.html#temporary-home-for-updated-functions"><i class="fa fa-check"></i><b>2.3.1</b> Temporary home for updated functions</a></li>
<li class="chapter" data-level="2.3.2" data-path="getData.html"><a href="getData.html#get-data-1"><i class="fa fa-check"></i><b>2.3.2</b> Get data</a></li>
<li class="chapter" data-level="2.3.3" data-path="getData.html"><a href="getData.html#make-encounter-history-files"><i class="fa fa-check"></i><b>2.3.3</b> Make encounter history files</a></li>
<li class="chapter" data-level="2.3.4" data-path="getData.html"><a href="getData.html#wrangle-data-1"><i class="fa fa-check"></i><b>2.3.4</b> Wrangle data</a></li>
<li class="chapter" data-level="2.3.5" data-path="getData.html"><a href="getData.html#explore-data-1"><i class="fa fa-check"></i><b>2.3.5</b> Explore data</a></li>
<li class="chapter" data-level="2.3.6" data-path="getData.html"><a href="getData.html#cmr-metadata"><i class="fa fa-check"></i><b>2.3.6</b> CMR metadata</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="getData.html"><a href="getData.html#dataWanding"><i class="fa fa-check"></i><b>2.4</b> Wanding data</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="getData.html"><a href="getData.html#get-data-2"><i class="fa fa-check"></i><b>2.4.1</b> Get data</a></li>
<li class="chapter" data-level="2.4.2" data-path="getData.html"><a href="getData.html#wrangle-data-2"><i class="fa fa-check"></i><b>2.4.2</b> Wrangle data</a></li>
<li class="chapter" data-level="2.4.3" data-path="getData.html"><a href="getData.html#explore-data-2"><i class="fa fa-check"></i><b>2.4.3</b> Explore data</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="getData.html"><a href="getData.html#dataAntenna"><i class="fa fa-check"></i><b>2.5</b> Antenna data</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="getData.html"><a href="getData.html#get-data-3"><i class="fa fa-check"></i><b>2.5.1</b> Get data</a></li>
<li class="chapter" data-level="2.5.2" data-path="getData.html"><a href="getData.html#wrangle-data-3"><i class="fa fa-check"></i><b>2.5.2</b> Wrangle data</a></li>
<li class="chapter" data-level="2.5.3" data-path="getData.html"><a href="getData.html#explore-data-3"><i class="fa fa-check"></i><b>2.5.3</b> Explore data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="models.html"><a href="models.html"><i class="fa fa-check"></i><b>3</b> Models</a>
<ul>
<li class="chapter" data-level="3.1" data-path="models.html"><a href="models.html#modelYOY"><i class="fa fa-check"></i><b>3.1</b> Young-of-year size model</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="models.html"><a href="models.html#raw-data-for-yoy-model"><i class="fa fa-check"></i><b>3.1.1</b> Raw data for YOY model</a></li>
<li class="chapter" data-level="3.1.2" data-path="models.html"><a href="models.html#get-environmental-data"><i class="fa fa-check"></i><b>3.1.2</b> Get environmental data</a></li>
<li class="chapter" data-level="3.1.3" data-path="models.html"><a href="models.html#get-first-observations"><i class="fa fa-check"></i><b>3.1.3</b> Get first observations</a></li>
<li class="chapter" data-level="3.1.4" data-path="models.html"><a href="models.html#counts-of-captured-fish"><i class="fa fa-check"></i><b>3.1.4</b> Counts of captured fish</a></li>
<li class="chapter" data-level="3.1.5" data-path="models.html"><a href="models.html#raw-data-plots"><i class="fa fa-check"></i><b>3.1.5</b> Raw data plots</a></li>
<li class="chapter" data-level="3.1.6" data-path="models.html"><a href="models.html#models-based-on-yearly-means"><i class="fa fa-check"></i><b>3.1.6</b> Models based on yearly means</a></li>
<li class="chapter" data-level="3.1.7" data-path="models.html"><a href="models.html#models-with-extreme-flow-events-droughts"><i class="fa fa-check"></i><b>3.1.7</b> Models with extreme flow events (droughts)</a></li>
<li class="chapter" data-level="3.1.8" data-path="models.html"><a href="models.html#models-based-on-individual-observations"><i class="fa fa-check"></i><b>3.1.8</b> Models based on individual observations</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="models.html"><a href="models.html#modelFlow"><i class="fa fa-check"></i><b>3.2</b> Flow model</a></li>
<li class="chapter" data-level="3.3" data-path="models.html"><a href="models.html#modelCMR_Flow"><i class="fa fa-check"></i><b>3.3</b> Flow effects on survival (phi) models</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="models.html"><a href="models.html#model-phi_p"><i class="fa fa-check"></i><b>3.3.1</b> Model phi_p</a></li>
<li class="chapter" data-level="3.3.2" data-path="models.html"><a href="models.html#model-phit_pt"><i class="fa fa-check"></i><b>3.3.2</b> Model phiT_pT</a></li>
<li class="chapter" data-level="3.3.3" data-path="models.html"><a href="models.html#model-phit_pt_isyoy"><i class="fa fa-check"></i><b>3.3.3</b> Model phiT_pT_isYOY</a></li>
<li class="chapter" data-level="3.3.4" data-path="models.html"><a href="models.html#model-phit_pt_cohort"><i class="fa fa-check"></i><b>3.3.4</b> Model phiT_pT_cohort</a></li>
<li class="chapter" data-level="3.3.5" data-path="models.html"><a href="models.html#model-phit_pt_cohort_flow"><i class="fa fa-check"></i><b>3.3.5</b> Model phiT_pT_cohort_flow</a></li>
<li class="chapter" data-level="3.3.6" data-path="models.html"><a href="models.html#model-phit_pt_cohort_flowcohort"><i class="fa fa-check"></i><b>3.3.6</b> Model phiT_pT_cohort_flowCohort</a></li>
<li class="chapter" data-level="3.3.7" data-path="models.html"><a href="models.html#model-phit_pt_cohort_flowcohorthier"><i class="fa fa-check"></i><b>3.3.7</b> Model phiT_pT_cohort_flowCohortHier</a></li>
<li class="chapter" data-level="3.3.8" data-path="models.html"><a href="models.html#compare-models"><i class="fa fa-check"></i><b>3.3.8</b> Compare models</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="final-words.html"><a href="final-words.html"><i class="fa fa-check"></i><b>4</b> Final Words</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The West Brook Story</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="models" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Models<a href="models.html#models" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>List of models will go here</p>

<div id="modelYOY" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Young-of-year size model<a href="models.html#modelYOY" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The question here is what is driving <em>body size variation</em> across years in brook trout and brown trout in the WB?</p>
<p>We focus on ageInSamples == 1 (age-0 fish in the fall sample) fish for growth model. This is the first sampling occasion that most fish are big enough to tag. Not all fish are big enough, however, and there is a number of untagged fish each year. We need to include both tagged and untagged fish in our age-0 size model.</p>
<p>Factors to include in the model are<br />
1. Sample date<br />
2. Cumulative temperature prior to sampling<br />
3. Cumulative flow prior to sampling<br />
4. Extreme flow events?? Floods, droughts?<br />
5. Fish density, age-0 counts across all three salmonids</p>
<div id="raw-data-for-yoy-model" class="section level3 hasAnchor" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> Raw data for YOY model<a href="models.html#raw-data-for-yoy-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li>Environmental data (flow, temperature) are from 1, 3, or 5 months prior to date of individual capture. Also can used fixed dates: assumed spawning dates, assumed emergence dates and actual observation (sample) dates.</li>
<li>All fish data are from age-0 in autumn.</li>
<li>Abundance data.</li>
</ol>
</div>
<div id="get-environmental-data" class="section level3 hasAnchor" number="3.1.2">
<h3><span class="header-section-number">3.1.2</span> Get environmental data<a href="models.html#get-environmental-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>West Brook environmental data (flow and temperature)</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="models.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file =</span> <span class="st">&#39;./data/envDataWB.RData&#39;</span>)</span></code></pre></div>
</div>
<div id="get-first-observations" class="section level3 hasAnchor" number="3.1.3">
<h3><span class="header-section-number">3.1.3</span> Get first observations<a href="models.html#get-first-observations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li>Filter cdWB_electro for first observations in the autumn for age-0 fish (ageInsamples == 1). Including both tagged and untagged fish.</li>
</ol>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="models.html#cb29-1" aria-hidden="true" tabindex="-1"></a>selectedVariables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;tag&quot;</span>, <span class="st">&quot;species&quot;</span>, <span class="st">&quot;river&quot;</span>, <span class="st">&quot;detectionDate&quot;</span>, <span class="st">&quot;sampleNumber&quot;</span>, <span class="st">&quot;n&quot;</span>, <span class="st">&quot;proportionSampled&quot;</span>, <span class="st">&quot;observedLength&quot;</span>, <span class="st">&quot;observedWeight&quot;</span>, <span class="st">&quot;area&quot;</span>, <span class="st">&quot;section&quot;</span>, <span class="st">&quot;season&quot;</span>, <span class="st">&quot;isYOY&quot;</span>)</span>
<span id="cb29-2"><a href="models.html#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="models.html#cb29-3" aria-hidden="true" tabindex="-1"></a>firstObs_noTag <span class="ot">&lt;-</span> cdWB_electro <span class="sc">%&gt;%</span></span>
<span id="cb29-4"><a href="models.html#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(tag), ageInSamples <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-5"><a href="models.html#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-6"><a href="models.html#cb29-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span> <span class="fu">select</span>(<span class="fu">all_of</span>(selectedVariables)) </span>
<span id="cb29-7"><a href="models.html#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="models.html#cb29-8" aria-hidden="true" tabindex="-1"></a>firstObs_tag <span class="ot">&lt;-</span> cdWB_electro <span class="sc">%&gt;%</span></span>
<span id="cb29-9"><a href="models.html#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(tag) <span class="sc">%&gt;%</span></span>
<span id="cb29-10"><a href="models.html#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">isFirstObs =</span> detectionDate <span class="sc">==</span> <span class="fu">min</span>(detectionDate),</span>
<span id="cb29-11"><a href="models.html#cb29-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb29-12"><a href="models.html#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(isFirstObs, ageInSamples <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-13"><a href="models.html#cb29-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(selectedVariables)) <span class="sc">%&gt;%</span></span>
<span id="cb29-14"><a href="models.html#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb29-15"><a href="models.html#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="models.html#cb29-16" aria-hidden="true" tabindex="-1"></a>firstObs0 <span class="ot">&lt;-</span> <span class="fu">add_row</span>(firstObs_tag, firstObs_noTag) <span class="sc">%&gt;%</span></span>
<span id="cb29-17"><a href="models.html#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as_date</span>(detectionDate),</span>
<span id="cb29-18"><a href="models.html#cb29-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">yday =</span> <span class="fu">yday</span>(date),</span>
<span id="cb29-19"><a href="models.html#cb29-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">year</span>(date))</span></code></pre></div>
<p>For each date in firstObs0 that at least one fish was captured, calculate summary stats for flow and temperature for different time periods:<br />
1. Assumed spawning to capture<br />
2. Assumed spawning to assumed emergence<br />
3. Assumed emergence to capture<br />
4. One month preceding capture<br />
5. Three months preceding capture<br />
5. Five months preceding capture</p>
<p>Then merge results with firstObs0 to create firstObs.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="models.html#cb30-1" aria-hidden="true" tabindex="-1"></a>spawn_month <span class="ot">&lt;-</span> <span class="st">&quot;11&quot;</span> <span class="co"># spawning</span></span>
<span id="cb30-2"><a href="models.html#cb30-2" aria-hidden="true" tabindex="-1"></a>spawn_day <span class="ot">&lt;-</span> <span class="st">&quot;15&quot;</span></span>
<span id="cb30-3"><a href="models.html#cb30-3" aria-hidden="true" tabindex="-1"></a>emerge_month <span class="ot">&lt;-</span> <span class="st">&quot;03&quot;</span> <span class="co"># emergence</span></span>
<span id="cb30-4"><a href="models.html#cb30-4" aria-hidden="true" tabindex="-1"></a>emerge_day <span class="ot">&lt;-</span> <span class="st">&quot;01&quot;</span></span>
<span id="cb30-5"><a href="models.html#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="models.html#cb30-6" aria-hidden="true" tabindex="-1"></a>firstObsDates <span class="ot">&lt;-</span> firstObs0 <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(<span class="at">date =</span> <span class="fu">date</span>(detectionDate), river)</span>
<span id="cb30-7"><a href="models.html#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="models.html#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># move to getPrepareWBData</span></span>
<span id="cb30-9"><a href="models.html#cb30-9" aria-hidden="true" tabindex="-1"></a>getEnvMeans <span class="ot">&lt;-</span> <span class="cf">function</span>(riverIn, start, end) { </span>
<span id="cb30-10"><a href="models.html#cb30-10" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> envDataWB <span class="sc">%&gt;%</span> </span>
<span id="cb30-11"><a href="models.html#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(river <span class="sc">==</span> riverIn, dateDate <span class="sc">&gt;=</span> start, dateDate <span class="sc">&lt;=</span> end) <span class="sc">%&gt;%</span></span>
<span id="cb30-12"><a href="models.html#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb30-13"><a href="models.html#cb30-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">sumT =</span> <span class="fu">sum</span>(temperature, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-14"><a href="models.html#cb30-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">meanT =</span> <span class="fu">mean</span>(temperature, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-15"><a href="models.html#cb30-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">sdT =</span> <span class="fu">sd</span>(temperature, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb30-16"><a href="models.html#cb30-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">cvT =</span> sdT<span class="sc">/</span>meanT,</span>
<span id="cb30-17"><a href="models.html#cb30-17" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-18"><a href="models.html#cb30-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">sumF =</span> <span class="fu">sum</span>(flow, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-19"><a href="models.html#cb30-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">meanF =</span> <span class="fu">mean</span>(flow, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-20"><a href="models.html#cb30-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">sdF =</span> <span class="fu">sd</span>(flow, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-21"><a href="models.html#cb30-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">cvF =</span> sdF<span class="sc">/</span>meanF,</span>
<span id="cb30-22"><a href="models.html#cb30-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb30-23"><a href="models.html#cb30-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-24"><a href="models.html#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="models.html#cb30-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">#message(paste(river, start, end,tag))</span></span>
<span id="cb30-26"><a href="models.html#cb30-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb30-27"><a href="models.html#cb30-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-28"><a href="models.html#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-29"><a href="models.html#cb30-29" aria-hidden="true" tabindex="-1"></a>firstObs_Env <span class="ot">&lt;-</span> firstObsDates <span class="sc">%&gt;%</span></span>
<span id="cb30-30"><a href="models.html#cb30-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-31"><a href="models.html#cb30-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-32"><a href="models.html#cb30-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb30-33"><a href="models.html#cb30-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">spawnDate =</span> <span class="fu">ymd</span>(<span class="fu">paste0</span>(year,spawn_month,spawn_day)) <span class="sc">-</span> <span class="fu">years</span>(<span class="dv">1</span>),</span>
<span id="cb30-34"><a href="models.html#cb30-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">emergeDate =</span> <span class="fu">ymd</span>(<span class="fu">paste0</span>(year,emerge_month,emerge_day)),</span>
<span id="cb30-35"><a href="models.html#cb30-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">oneMonthDate =</span> date <span class="sc">-</span> <span class="fu">days</span>(<span class="fu">as.integer</span>(<span class="dv">1</span> <span class="sc">*</span> <span class="fl">30.5</span>)), <span class="co">#months(1), &#39;months gives error when prev month has 30 days and current has 31</span></span>
<span id="cb30-36"><a href="models.html#cb30-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">threeMonthDate =</span> date <span class="sc">-</span> <span class="fu">days</span>(<span class="fu">as.integer</span>(<span class="dv">3</span> <span class="sc">*</span> <span class="fl">30.5</span>)),</span>
<span id="cb30-37"><a href="models.html#cb30-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">fiveMonthDate =</span> date <span class="sc">-</span> <span class="fu">days</span>(<span class="fu">as.integer</span>(<span class="dv">5</span> <span class="sc">*</span> <span class="fl">30.5</span>)),</span>
<span id="cb30-38"><a href="models.html#cb30-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">spawn_emerge =</span> <span class="fu">list</span>(<span class="fu">getEnvMeans</span>(river, spawnDate, emergeDate)),</span>
<span id="cb30-39"><a href="models.html#cb30-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">emerge_detect =</span> <span class="fu">list</span>(<span class="fu">getEnvMeans</span>(river, emergeDate, date)),</span>
<span id="cb30-40"><a href="models.html#cb30-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">spawn_detect =</span> <span class="fu">list</span>(<span class="fu">getEnvMeans</span>(river, spawnDate, date)),</span>
<span id="cb30-41"><a href="models.html#cb30-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">oneMonth =</span> <span class="fu">list</span>(<span class="fu">getEnvMeans</span>(river, oneMonthDate, date)),</span>
<span id="cb30-42"><a href="models.html#cb30-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">threeMonth =</span> <span class="fu">list</span>(<span class="fu">getEnvMeans</span>(river, threeMonthDate, date)),</span>
<span id="cb30-43"><a href="models.html#cb30-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">fiveMonth =</span> <span class="fu">list</span>(<span class="fu">getEnvMeans</span>(river, fiveMonthDate, date))</span>
<span id="cb30-44"><a href="models.html#cb30-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-45"><a href="models.html#cb30-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-46"><a href="models.html#cb30-46" aria-hidden="true" tabindex="-1"></a><span class="co"># merge env data into firstObs0</span></span>
<span id="cb30-47"><a href="models.html#cb30-47" aria-hidden="true" tabindex="-1"></a>firstObs <span class="ot">&lt;-</span> firstObs0 <span class="sc">%&gt;%</span></span>
<span id="cb30-48"><a href="models.html#cb30-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(firstObs_Env)</span>
<span id="cb30-49"><a href="models.html#cb30-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-50"><a href="models.html#cb30-50" aria-hidden="true" tabindex="-1"></a><span class="co">#str(firstObs)</span></span></code></pre></div>
<p>Unnest firstObs so environmental summary stats are available as data frame with the name of the time interval as the prefix to the statisticVariable name</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="models.html#cb31-1" aria-hidden="true" tabindex="-1"></a>getScaled <span class="ot">&lt;-</span> <span class="cf">function</span>(d){</span>
<span id="cb31-2"><a href="models.html#cb31-2" aria-hidden="true" tabindex="-1"></a>  (d <span class="sc">-</span> <span class="fu">mean</span>(d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">/</span> <span class="fu">sd</span>(d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-3"><a href="models.html#cb31-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-4"><a href="models.html#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="models.html#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># this scales across all individuals - I think this is ok</span></span>
<span id="cb31-6"><a href="models.html#cb31-6" aria-hidden="true" tabindex="-1"></a>firstObsUnnested <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span> </span>
<span id="cb31-7"><a href="models.html#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(spawn_emerge, emerge_detect, spawn_detect, oneMonth, threeMonth, fiveMonth), <span class="at">names_sep =</span> <span class="st">&quot;_&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-8"><a href="models.html#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-9"><a href="models.html#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">emerge_detect_sumTScaled =</span> <span class="fu">getScaled</span>(emerge_detect_sumT),</span>
<span id="cb31-10"><a href="models.html#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">emerge_detect_sumFScaled =</span> <span class="fu">getScaled</span>(emerge_detect_sumF),</span>
<span id="cb31-11"><a href="models.html#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">oneMonth_sumTScaled =</span> <span class="fu">getScaled</span>(oneMonth_sumT),</span>
<span id="cb31-12"><a href="models.html#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">oneMonth_sumFScaled =</span> <span class="fu">getScaled</span>(oneMonth_sumF),</span>
<span id="cb31-13"><a href="models.html#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">threeMonth_sumTScaled =</span> <span class="fu">getScaled</span>(threeMonth_sumT),</span>
<span id="cb31-14"><a href="models.html#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">threeMonth_sumFScaled =</span> <span class="fu">getScaled</span>(threeMonth_sumF),</span>
<span id="cb31-15"><a href="models.html#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">fiveMonth_sumTScaled =</span> <span class="fu">getScaled</span>(fiveMonth_sumT),</span>
<span id="cb31-16"><a href="models.html#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">fiveMonth_sumFScaled =</span> <span class="fu">getScaled</span>(fiveMonth_sumF),</span>
<span id="cb31-17"><a href="models.html#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">ydayScaled =</span> <span class="fu">getScaled</span>(yday)</span>
<span id="cb31-18"><a href="models.html#cb31-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-19"><a href="models.html#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="models.html#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(firstObsUnnested)</span></code></pre></div>
<pre><code>## tibble [20,783 Ã— 84] (S3: tbl_df/tbl/data.frame)
##  $ tag                     : chr [1:20783] &quot;00088cbed7&quot; &quot;00088cbed8&quot; &quot;00088cbedb&quot; &quot;00088cbedd&quot; ...
##  $ species                 : chr [1:20783] &quot;bkt&quot; &quot;bnt&quot; &quot;bkt&quot; &quot;bkt&quot; ...
##  $ river                   : chr [1:20783] &quot;wb obear&quot; &quot;west brook&quot; &quot;west brook&quot; &quot;wb obear&quot; ...
##  $ detectionDate           : POSIXct[1:20783], format: &quot;2014-09-17 00:00:00&quot; &quot;2012-09-26 11:01:00&quot; &quot;2014-09-24 11:45:00&quot; &quot;2012-09-21 00:00:00&quot; ...
##  $ sampleNumber            : num [1:20783] 79 71 79 71 79 71 71 79 71 79 ...
##  $ n                       : num [1:20783] 2 3 1 3 1 1 4 2 1 1 ...
##  $ proportionSampled       : num [1:20783] 1 1 1 1 1 1 1 1 1 1 ...
##  $ observedLength          : num [1:20783] 70 86 89 61 60 64 70 62 87 73 ...
##  $ observedWeight          : num [1:20783] 3.5 6.7 8.3 2.4 2.4 2.8 4.6 2.3 7.5 4.2 ...
##  $ area                    : chr [1:20783] &quot;trib&quot; &quot;inside&quot; &quot;inside&quot; &quot;trib&quot; ...
##  $ section                 : num [1:20783] 3 23 30 8 42 20 5 11 27 3 ...
##  $ season                  : num [1:20783] 3 3 3 3 3 3 3 3 3 3 ...
##  $ isYOY                   : logi [1:20783] TRUE TRUE TRUE TRUE TRUE TRUE ...
##  $ date                    : Date[1:20783], format: &quot;2014-09-17&quot; &quot;2012-09-26&quot; &quot;2014-09-24&quot; &quot;2012-09-21&quot; ...
##  $ yday                    : int [1:20783] 260 270 267 265 269 270 264 260 270 258 ...
##  $ year                    : int [1:20783] 2014 2012 2014 2012 2014 2012 2012 2014 2012 2014 ...
##  $ spawnDate               : Date[1:20783], format: &quot;2013-11-15&quot; &quot;2011-11-15&quot; &quot;2013-11-15&quot; &quot;2011-11-15&quot; ...
##  $ emergeDate              : Date[1:20783], format: &quot;2014-03-01&quot; &quot;2012-03-01&quot; &quot;2014-03-01&quot; &quot;2012-03-01&quot; ...
##  $ oneMonthDate            : Date[1:20783], format: &quot;2014-08-18&quot; &quot;2012-08-27&quot; &quot;2014-08-25&quot; &quot;2012-08-22&quot; ...
##  $ threeMonthDate          : Date[1:20783], format: &quot;2014-06-18&quot; &quot;2012-06-27&quot; &quot;2014-06-25&quot; &quot;2012-06-22&quot; ...
##  $ fiveMonthDate           : Date[1:20783], format: &quot;2014-04-18&quot; &quot;2012-04-27&quot; &quot;2014-04-25&quot; &quot;2012-04-22&quot; ...
##  $ spawn_emerge_sumT       : num [1:20783] 110 358 131 313 131 ...
##  $ spawn_emerge_meanT      : num [1:20783] 1.03 3.32 1.22 2.9 1.22 ...
##  $ spawn_emerge_sdT        : num [1:20783] 1.36 2.3 1.56 2.43 1.56 ...
##  $ spawn_emerge_cvT        : num [1:20783] 1.321 0.695 1.274 0.838 1.274 ...
##  $ spawn_emerge_sumF       : num [1:20783] 0 48.7 25.7 0 25.7 ...
##  $ spawn_emerge_meanF      : num [1:20783] NaN 0.451 0.24 NaN 0.24 ...
##  $ spawn_emerge_sdF        : num [1:20783] NA 0.457 0.352 NA 0.352 ...
##  $ spawn_emerge_cvF        : num [1:20783] NA 1.01 1.47 NA 1.47 ...
##  $ spawn_emerge_n          : int [1:20783] 107 108 107 108 107 108 108 107 108 107 ...
##  $ emerge_detect_sumT      : num [1:20783] 2191 2791 2597 2602 2622 ...
##  $ emerge_detect_meanT     : num [1:20783] 10.9 13.3 12.5 12.7 12.5 ...
##  $ emerge_detect_sdT       : num [1:20783] 5.74 4.82 6.36 5 6.33 ...
##  $ emerge_detect_cvT       : num [1:20783] 0.527 0.362 0.51 0.394 0.507 ...
##  $ emerge_detect_sumF      : num [1:20783] 0 28.6 71.6 0 71.6 ...
##  $ emerge_detect_meanF     : num [1:20783] NaN 0.136 0.344 NaN 0.341 ...
##  $ emerge_detect_sdF       : num [1:20783] NA 0.246 0.533 NA 0.532 ...
##  $ emerge_detect_cvF       : num [1:20783] NA 1.81 1.55 NA 1.56 ...
##  $ emerge_detect_n         : int [1:20783] 201 210 208 205 210 210 204 201 210 199 ...
##  $ spawn_detect_sumT       : num [1:20783] 2301 3149 2728 2915 2753 ...
##  $ spawn_detect_meanT      : num [1:20783] 7.5 9.93 8.69 9.34 8.71 ...
##  $ spawn_detect_sdT        : num [1:20783] 6.65 6.27 7.48 6.32 7.46 ...
##  $ spawn_detect_cvT        : num [1:20783] 0.887 0.631 0.861 0.677 0.857 ...
##  $ spawn_detect_sumF       : num [1:20783] 0 77.1 97.2 0 97.2 ...
##  $ spawn_detect_meanF      : num [1:20783] NaN 0.243 0.31 NaN 0.307 ...
##  $ spawn_detect_sdF        : num [1:20783] NA 0.365 0.482 NA 0.481 ...
##  $ spawn_detect_cvF        : num [1:20783] NA 1.5 1.56 NA 1.57 ...
##  $ spawn_detect_n          : int [1:20783] 307 317 314 312 316 317 311 307 317 305 ...
##  $ oneMonth_sumT           : num [1:20783] 470 461 454 489 445 ...
##  $ oneMonth_meanT          : num [1:20783] 15.2 14.9 14.6 15.8 14.4 ...
##  $ oneMonth_sdT            : num [1:20783] 1.69 1.89 2.45 1.7 2.44 ...
##  $ oneMonth_cvT            : num [1:20783] 0.112 0.127 0.167 0.108 0.17 ...
##  $ oneMonth_sumF           : num [1:20783] 0 2.1101 -0.0766 0 -0.2195 ...
##  $ oneMonth_meanF          : num [1:20783] NaN 0.06807 -0.00247 NaN -0.00708 ...
##  $ oneMonth_sdF            : num [1:20783] NA 0.3031 0.0204 NA 0.0176 ...
##  $ oneMonth_cvF            : num [1:20783] NA 4.45 -8.24 NA -2.48 ...
##  $ oneMonth_n              : int [1:20783] 31 31 31 31 31 31 31 31 31 31 ...
##  $ threeMonth_sumT         : num [1:20783] 1445 1523 1571 1559 1561 ...
##  $ threeMonth_meanT        : num [1:20783] 15.7 16.6 17.1 16.9 17 ...
##  $ threeMonth_sdT          : num [1:20783] 1.35 1.8 2.5 1.59 2.59 ...
##  $ threeMonth_cvT          : num [1:20783] 0.0859 0.1085 0.1463 0.0936 0.1526 ...
##  $ threeMonth_sumF         : num [1:20783] 0 1.17 12.25 0 11.8 ...
##  $ threeMonth_meanF        : num [1:20783] NaN 0.0127 0.1331 NaN 0.1283 ...
##  $ threeMonth_sdF          : num [1:20783] NA 0.184 0.298 NA 0.298 ...
##  $ threeMonth_cvF          : num [1:20783] NA 14.52 2.24 NA 2.32 ...
##  $ threeMonth_n            : int [1:20783] 92 92 92 92 92 92 92 92 92 92 ...
##  $ fiveMonth_sumT          : num [1:20783] 2086 2400 2425 2281 2432 ...
##  $ fiveMonth_meanT         : num [1:20783] 13.6 15.7 15.8 14.9 15.9 ...
##  $ fiveMonth_sdT           : num [1:20783] 3.16 2.54 3.07 3.2 2.98 ...
##  $ fiveMonth_cvT           : num [1:20783] 0.232 0.162 0.194 0.215 0.188 ...
##  $ fiveMonth_sumF          : num [1:20783] 0 16.9 39.3 0 38.3 ...
##  $ fiveMonth_meanF         : num [1:20783] NaN 0.111 0.257 NaN 0.251 ...
##  $ fiveMonth_sdF           : num [1:20783] NA 0.246 0.427 NA 0.427 ...
##  $ fiveMonth_cvF           : num [1:20783] NA 2.23 1.66 NA 1.7 ...
##  $ fiveMonth_n             : int [1:20783] 153 153 153 153 153 153 153 153 153 153 ...
##  $ emerge_detect_sumTScaled: num [1:20783] -0.261 1.215 0.738 0.751 0.799 ...
##  $ emerge_detect_sumFScaled: num [1:20783] -1.346 -0.518 0.727 -1.346 0.725 ...
##  $ oneMonth_sumTScaled     : num [1:20783] 0.3199 0.1864 0.085 0.5805 -0.0332 ...
##  $ oneMonth_sumFScaled     : num [1:20783] -0.329 0.206 -0.348 -0.329 -0.384 ...
##  $ threeMonth_sumTScaled   : num [1:20783] 0.275 0.523 0.676 0.638 0.644 ...
##  $ threeMonth_sumFScaled   : num [1:20783] -0.798 -0.671 0.536 -0.798 0.488 ...
##  $ fiveMonth_sumTScaled    : num [1:20783] -0.0187 0.8552 0.9245 0.5252 0.9456 ...
##  $ fiveMonth_sumFScaled    : num [1:20783] -1.261 -0.376 0.796 -1.261 0.745 ...
##  $ ydayScaled              : num [1:20783] -0.6678 0.3131 0.0189 -0.1773 0.215 ...</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="models.html#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#ggplot(firstObsUnnested, aes(oneMonth_sumTScaled, fiveMonth_sumTScaled)) +</span></span>
<span id="cb33-2"><a href="models.html#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  geom_point() +</span></span>
<span id="cb33-3"><a href="models.html#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  facet_wrap(~river)</span></span></code></pre></div>
</div>
<div id="counts-of-captured-fish" class="section level3 hasAnchor" number="3.1.4">
<h3><span class="header-section-number">3.1.4</span> Counts of captured fish<a href="models.html#counts-of-captured-fish" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Min and max years (inclusive) for standardizing counts</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="models.html#cb34-1" aria-hidden="true" tabindex="-1"></a>minYear <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb34-2"><a href="models.html#cb34-2" aria-hidden="true" tabindex="-1"></a>maxYear <span class="ot">&lt;-</span> <span class="dv">2015</span></span></code></pre></div>
<p>Counts by river and species</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="models.html#cb35-1" aria-hidden="true" tabindex="-1"></a>countsRSY <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="models.html#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear) <span class="sc">%&gt;%</span></span>
<span id="cb35-3"><a href="models.html#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(river, species, year) <span class="sc">%&gt;%</span></span>
<span id="cb35-4"><a href="models.html#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb35-5"><a href="models.html#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">count =</span> <span class="fu">n</span>(),</span>
<span id="cb35-6"><a href="models.html#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">meanPropSampled =</span> <span class="fu">mean</span>(proportionSampled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-7"><a href="models.html#cb35-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb35-8"><a href="models.html#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">countAdj =</span> count <span class="sc">/</span> meanPropSampled) <span class="sc">%&gt;%</span></span>
<span id="cb35-9"><a href="models.html#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb35-10"><a href="models.html#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(river, species) <span class="sc">%&gt;%</span></span>
<span id="cb35-11"><a href="models.html#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">meanCountRS =</span> <span class="fu">mean</span>(count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb35-12"><a href="models.html#cb35-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">sdCountRS =</span> <span class="fu">sd</span>(count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb35-13"><a href="models.html#cb35-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">countRS_Scaled =</span> (count <span class="sc">-</span> meanCountRS) <span class="sc">/</span> sdCountRS) <span class="sc">%&gt;%</span></span>
<span id="cb35-14"><a href="models.html#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb35-15"><a href="models.html#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="models.html#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(countsRSY, <span class="fu">aes</span>(year, countRS_Scaled, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb35-17"><a href="models.html#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb35-18"><a href="models.html#cb35-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb35-19"><a href="models.html#cb35-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> river)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/rawCounts-1.png" width="672" /></p>
<p>Counts by river</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="models.html#cb36-1" aria-hidden="true" tabindex="-1"></a>countsRY <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="models.html#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear) <span class="sc">%&gt;%</span></span>
<span id="cb36-3"><a href="models.html#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(river, year) <span class="sc">%&gt;%</span></span>
<span id="cb36-4"><a href="models.html#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb36-5"><a href="models.html#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">count =</span> <span class="fu">n</span>(),</span>
<span id="cb36-6"><a href="models.html#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">meanPropSampled =</span> <span class="fu">mean</span>(proportionSampled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb36-7"><a href="models.html#cb36-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb36-8"><a href="models.html#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">countAdj =</span> count <span class="sc">/</span> meanPropSampled) <span class="sc">%&gt;%</span></span>
<span id="cb36-9"><a href="models.html#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb36-10"><a href="models.html#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(river) <span class="sc">%&gt;%</span></span>
<span id="cb36-11"><a href="models.html#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">meanCountR =</span> <span class="fu">mean</span>(count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb36-12"><a href="models.html#cb36-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">sdCountR =</span> <span class="fu">sd</span>(count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb36-13"><a href="models.html#cb36-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">countR_Scaled =</span> (count <span class="sc">-</span> meanCountR) <span class="sc">/</span> sdCountR) <span class="sc">%&gt;%</span></span>
<span id="cb36-14"><a href="models.html#cb36-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb36-15"><a href="models.html#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="models.html#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(countsRY, <span class="fu">aes</span>(year, countR_Scaled, <span class="at">color =</span> river)) <span class="sc">+</span></span>
<span id="cb36-17"><a href="models.html#cb36-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb36-18"><a href="models.html#cb36-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/countsRY-1.png" width="672" /></p>
<p>Counts for the metaPopulation (WB, Jimmy, Mitchell)<br />
Use these for modelling.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="models.html#cb37-1" aria-hidden="true" tabindex="-1"></a>countsMetaY <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="models.html#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(river <span class="sc">!=</span> <span class="st">&quot;wb obear&quot;</span>, year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear) <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="models.html#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="models.html#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb37-5"><a href="models.html#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">count =</span> <span class="fu">n</span>(),</span>
<span id="cb37-6"><a href="models.html#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">meanPropSampled =</span> <span class="fu">mean</span>(proportionSampled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-7"><a href="models.html#cb37-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb37-8"><a href="models.html#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">countAdj =</span> count <span class="sc">/</span> meanPropSampled) <span class="sc">%&gt;%</span></span>
<span id="cb37-9"><a href="models.html#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb37-10"><a href="models.html#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">meanCount =</span> <span class="fu">mean</span>(count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-11"><a href="models.html#cb37-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">sdCount =</span> <span class="fu">sd</span>(count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-12"><a href="models.html#cb37-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">count_Scaled =</span> (count <span class="sc">-</span> meanCount) <span class="sc">/</span> sdCount)</span>
<span id="cb37-13"><a href="models.html#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># missing data for tribs in 2000, 2001 - may skew scaled count a bit low - should fix</span></span>
<span id="cb37-14"><a href="models.html#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="models.html#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(countsMetaY, <span class="fu">aes</span>(year, count_Scaled)) <span class="sc">+</span></span>
<span id="cb37-16"><a href="models.html#cb37-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb37-17"><a href="models.html#cb37-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/countsMeta-1.png" width="672" /></p>
<p>Merge metapopulation scaled counts into firstObsUnnested</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="models.html#cb38-1" aria-hidden="true" tabindex="-1"></a>firstObsUnnested <span class="ot">&lt;-</span> firstObsUnnested <span class="sc">%&gt;%</span></span>
<span id="cb38-2"><a href="models.html#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(countsMetaY <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(year, count_Scaled))</span>
<span id="cb38-3"><a href="models.html#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="models.html#cb38-4" aria-hidden="true" tabindex="-1"></a>firstObsUnnestedWB <span class="ot">&lt;-</span> firstObsUnnested <span class="sc">%&gt;%</span> <span class="fu">filter</span>(river <span class="sc">==</span> <span class="st">&quot;west brook&quot;</span>)</span></code></pre></div>
</div>
<div id="raw-data-plots" class="section level3 hasAnchor" number="3.1.5">
<h3><span class="header-section-number">3.1.5</span> Raw data plots<a href="models.html#raw-data-plots" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="frequency-plots-by-species-and-river" class="section level4 hasAnchor" number="3.1.5.1">
<h4><span class="header-section-number">3.1.5.1</span> Frequency plots by species and river<a href="models.html#frequency-plots-by-species-and-river" class="anchor-section" aria-label="Anchor link to header"></a></h4>
</div>
<div id="brook-trout-west-brook" class="section level4 hasAnchor" number="3.1.5.2">
<h4><span class="header-section-number">3.1.5.2</span> Brook Trout, West brook<a href="models.html#brook-trout-west-brook" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="models.html#cb39-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#cd1 &lt;- cdWB_electro %&gt;% filter(ageInSamples == 1, species != &#39;ats&#39;)</span></span>
<span id="cb39-2"><a href="models.html#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="models.html#cb39-3" aria-hidden="true" tabindex="-1"></a>  plotSppRiv <span class="ot">=</span> <span class="cf">function</span>(s, r) { </span>
<span id="cb39-4"><a href="models.html#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(firstObs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">==</span> s, river <span class="sc">==</span> r), <span class="fu">aes</span>(observedLength, <span class="at">color =</span> <span class="fu">is.na</span>(tag))) <span class="sc">+</span></span>
<span id="cb39-5"><a href="models.html#cb39-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb39-6"><a href="models.html#cb39-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>) <span class="sc">+</span></span>
<span id="cb39-7"><a href="models.html#cb39-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggtitle</span>(<span class="fu">paste</span>(s, r, <span class="at">sep =</span> <span class="st">&#39;, &#39;</span>)) <span class="sc">+</span></span>
<span id="cb39-8"><a href="models.html#cb39-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">30</span>,<span class="dv">125</span>)) <span class="sc">+</span></span>
<span id="cb39-9"><a href="models.html#cb39-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(<span class="sc">~</span> year, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>)</span>
<span id="cb39-10"><a href="models.html#cb39-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-11"><a href="models.html#cb39-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-12"><a href="models.html#cb39-12" aria-hidden="true" tabindex="-1"></a>  species <span class="ot">=</span> <span class="st">&#39;bkt&#39;</span></span>
<span id="cb39-13"><a href="models.html#cb39-13" aria-hidden="true" tabindex="-1"></a>  riverOrdered <span class="ot">=</span> <span class="st">&quot;west brook&quot;</span></span>
<span id="cb39-14"><a href="models.html#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="models.html#cb39-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plotSppRiv</span>(species, riverOrdered)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots1-1.png" width="672" /></p>
</div>
<div id="brook-trout-wb-jimmy" class="section level4 hasAnchor" number="3.1.5.3">
<h4><span class="header-section-number">3.1.5.3</span> Brook Trout, wb jimmy<a href="models.html#brook-trout-wb-jimmy" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots2-1.png" width="672" /></p>
</div>
<div id="brook-trout-wb-mitchell" class="section level4 hasAnchor" number="3.1.5.4">
<h4><span class="header-section-number">3.1.5.4</span> Brook Trout, wb mitchell<a href="models.html#brook-trout-wb-mitchell" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots3-1.png" width="672" /></p>
</div>
<div id="brook-trout-wb-obear" class="section level4 hasAnchor" number="3.1.5.5">
<h4><span class="header-section-number">3.1.5.5</span> Brook Trout, wb obear<a href="models.html#brook-trout-wb-obear" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots4-1.png" width="672" /></p>
</div>
<div id="brown-trout-west-brook" class="section level4 hasAnchor" number="3.1.5.6">
<h4><span class="header-section-number">3.1.5.6</span> Brown Trout, West brook<a href="models.html#brown-trout-west-brook" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots5-1.png" width="672" /></p>
</div>
<div id="brown-trout-wb-jimmy" class="section level4 hasAnchor" number="3.1.5.7">
<h4><span class="header-section-number">3.1.5.7</span> Brown Trout, wb jimmy<a href="models.html#brown-trout-wb-jimmy" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots6-1.png" width="672" /></p>
</div>
<div id="brown-trout-wb-mitchell" class="section level4 hasAnchor" number="3.1.5.8">
<h4><span class="header-section-number">3.1.5.8</span> Brown Trout, wb mitchell<a href="models.html#brown-trout-wb-mitchell" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots7-1.png" width="672" /></p>
</div>
<div id="brown-trout-wb-obear---there-are-no-brown-trout-in-obear" class="section level4 hasAnchor" number="3.1.5.9">
<h4><span class="header-section-number">3.1.5.9</span> Brown Trout, wb obear - there are no Brown trout in Oâ€™Bear<a href="models.html#brown-trout-wb-obear---there-are-no-brown-trout-in-obear" class="anchor-section" aria-label="Anchor link to header"></a></h4>
</div>
<div id="trout-in-the-wb-mainstem-only" class="section level4 hasAnchor" number="3.1.5.10">
<h4><span class="header-section-number">3.1.5.10</span> Trout, in the WB mainstem only<a href="models.html#trout-in-the-wb-mainstem-only" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="models.html#cb40-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(firstObs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">!=</span> <span class="st">&quot;ats&quot;</span>), <span class="fu">aes</span>(observedLength)) <span class="sc">+</span></span>
<span id="cb40-2"><a href="models.html#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb40-3"><a href="models.html#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>, <span class="at">color =</span> <span class="st">&#39;orange&#39;</span>) <span class="sc">+</span></span>
<span id="cb40-4"><a href="models.html#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(species <span class="sc">~</span> year)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/troutWB-1.png" width="672" /></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="models.html#cb41-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(firstObs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">!=</span> <span class="st">&quot;ats&quot;</span>), <span class="fu">aes</span>(observedLength, <span class="at">color =</span> <span class="fu">is.na</span>(tag))) <span class="sc">+</span></span>
<span id="cb41-2"><a href="models.html#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb41-3"><a href="models.html#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>, <span class="at">color =</span> <span class="st">&#39;orange&#39;</span>) <span class="sc">+</span></span>
<span id="cb41-4"><a href="models.html#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(species <span class="sc">~</span> year)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/troutWB-2.png" width="672" /></p>
</div>
<div id="why-are-there-untagged-fish-bigger-than-60mm" class="section level4 hasAnchor" number="3.1.5.11">
<h4><span class="header-section-number">3.1.5.11</span> Why are there untagged fish bigger than 60mm?<a href="models.html#why-are-there-untagged-fish-bigger-than-60mm" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Check 2002/bkt/WB, as an example
Answer: because they are outside the study area (area = â€˜aboveâ€™ or â€˜belowâ€™) or were tagging mortalities</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="models.html#cb42-1" aria-hidden="true" tabindex="-1"></a>  firstObs2002BKT <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2002</span>, species <span class="sc">==</span> <span class="st">&quot;bkt&quot;</span>)</span>
<span id="cb42-2"><a href="models.html#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>(<span class="fu">is.na</span>(firstObs2002BKT<span class="sc">$</span>tag))</span></code></pre></div>
<pre><code>## 
## FALSE  TRUE 
##   295   253</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="models.html#cb44-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(firstObs2002BKT, <span class="fu">aes</span>(observedLength, <span class="at">color =</span> <span class="fu">is.na</span>(tag))) <span class="sc">+</span></span>
<span id="cb44-2"><a href="models.html#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb44-3"><a href="models.html#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/2002%20untagged-1.png" width="672" /></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="models.html#cb45-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># looks like untagged area=inside fish wee morts, the rest were above or below</span></span>
<span id="cb45-2"><a href="models.html#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(firstObs2002BKT, <span class="fu">aes</span>(observedLength, <span class="at">color =</span> <span class="fu">is.na</span>(tag))) <span class="sc">+</span></span>
<span id="cb45-3"><a href="models.html#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb45-4"><a href="models.html#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>) <span class="sc">+</span></span>
<span id="cb45-5"><a href="models.html#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span>area)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/2002%20untagged-2.png" width="672" /></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="models.html#cb46-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check 2003</span></span>
<span id="cb46-2"><a href="models.html#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(firstObs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2003</span>, species <span class="sc">==</span> <span class="st">&quot;bkt&quot;</span>), <span class="fu">aes</span>(observedLength, <span class="at">color =</span> <span class="fu">is.na</span>(tag))) <span class="sc">+</span></span>
<span id="cb46-3"><a href="models.html#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb46-4"><a href="models.html#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>) <span class="sc">+</span></span>
<span id="cb46-5"><a href="models.html#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span>area)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/2002%20untagged-3.png" width="672" /></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="models.html#cb47-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># same story as 2002</span></span></code></pre></div>
</div>
<div id="why-no-untagged-fish-for-2000-and-2001" class="section level4 hasAnchor" number="3.1.5.12">
<h4><span class="header-section-number">3.1.5.12</span> Why no untagged fish for 2000 and 2001?<a href="models.html#why-no-untagged-fish-for-2000-and-2001" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Check data logs to see if we were not recording untagged fish in 2000, 2001</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="models.html#cb48-1" aria-hidden="true" tabindex="-1"></a>  cfirstObs2000_2001BKT <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="dv">2000</span><span class="sc">:</span><span class="dv">2001</span>, species <span class="sc">==</span> <span class="st">&quot;bkt&quot;</span>)</span>
<span id="cb48-2"><a href="models.html#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>(<span class="fu">is.na</span>(cfirstObs2000_2001BKT<span class="sc">$</span>tag))</span></code></pre></div>
<pre><code>## 
## FALSE 
##   343</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="models.html#cb50-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>(cfirstObs2000_2001BKT<span class="sc">$</span>observedLength)</span></code></pre></div>
<pre><code>## 
## 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 85 90 
## 18 23 23 26 20 28 19 14 28 23 20 21  9 14  8 11  3  8  4  5  6  5  1  3  2  1</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="models.html#cb52-1" aria-hidden="true" tabindex="-1"></a>  cfirstObs2000_2001BKT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(observedLength <span class="sc">&lt;</span> <span class="dv">60</span>)</span></code></pre></div>
<pre><code>## # A tibble: 64 Ã— 27
##    tag        species river detectionDate       sampleNumber     n proportionSamplâ€¦ observedLength observedWeight area 
##    &lt;chr&gt;      &lt;chr&gt;   &lt;chr&gt; &lt;dttm&gt;                     &lt;dbl&gt; &lt;dbl&gt;            &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt; &lt;chr&gt;
##  1 1bf0fc3a19 bkt     westâ€¦ 2001-09-10 12:00:00           27     2                1             58            1.9 insiâ€¦
##  2 1bf0fc46b1 bkt     westâ€¦ 2001-09-07 12:00:00           27     2                1             57            1.9 insiâ€¦
##  3 1bf0fe50cb bkt     westâ€¦ 2001-09-07 12:00:00           27     1                1             59            2.1 insiâ€¦
##  4 1bf0fe76f1 bkt     westâ€¦ 2001-09-07 12:00:00           27     6                1             59            2.1 insiâ€¦
##  5 1bf0fe845b bkt     westâ€¦ 2001-09-06 12:00:00           27     1                1             59            2.2 insiâ€¦
##  6 1bf0fe84ed bkt     westâ€¦ 2001-09-10 12:00:00           27     1                1             57            1.9 insiâ€¦
##  7 1bf0fe8846 bkt     westâ€¦ 2001-09-07 12:00:00           27     3                1             58            2   insiâ€¦
##  8 1bf0fe88d8 bkt     westâ€¦ 2001-09-10 12:00:00           27     2                1             58            2.1 insiâ€¦
##  9 1bf0fe8b79 bkt     westâ€¦ 2001-09-06 12:00:00           27     4                1             58            2   insiâ€¦
## 10 1bf0fe9504 bkt     westâ€¦ 2001-09-07 12:00:00           27     3                1             58            1.8 insiâ€¦
## # â€¦ with 54 more rows, and 17 more variables: section &lt;dbl&gt;, season &lt;dbl&gt;, isYOY &lt;lgl&gt;, date &lt;date&gt;, yday &lt;int&gt;,
## #   year &lt;int&gt;, spawnDate &lt;date&gt;, emergeDate &lt;date&gt;, oneMonthDate &lt;date&gt;, threeMonthDate &lt;date&gt;, fiveMonthDate &lt;date&gt;,
## #   spawn_emerge &lt;list&gt;, emerge_detect &lt;list&gt;, spawn_detect &lt;list&gt;, oneMonth &lt;list&gt;, threeMonth &lt;list&gt;,
## #   fiveMonth &lt;list&gt;</code></pre>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="models.html#cb54-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(cfirstObs2000_2001BKT, <span class="fu">aes</span>(observedLength, <span class="at">color =</span> <span class="fu">is.na</span>(tag))) <span class="sc">+</span></span>
<span id="cb54-2"><a href="models.html#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb54-3"><a href="models.html#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/untagged%202000,%202001-1.png" width="672" /></p>
</div>
</div>
<div id="models-based-on-yearly-means" class="section level3 hasAnchor" number="3.1.6">
<h3><span class="header-section-number">3.1.6</span> Models based on yearly means<a href="models.html#models-based-on-yearly-means" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Filter firstObsUnnestedWB for bkt, bnt and min/maxYear</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="models.html#cb55-1" aria-hidden="true" tabindex="-1"></a>d_WB_BKT_BNT <span class="ot">&lt;-</span> firstObsUnnestedWB <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">!=</span> <span class="st">&quot;ats&quot;</span>, year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear) <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="models.html#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">species01 =</span> <span class="fu">ifelse</span>(species <span class="sc">==</span> <span class="st">&quot;bkt&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb55-3"><a href="models.html#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="models.html#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(d_WB_BKT_BNT<span class="sc">$</span>detectionDate, <span class="at">breaks =</span> <span class="dv">250</span>)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/filter%20firstObsUnnestedWB-1.png" width="672" /></p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="models.html#cb56-1" aria-hidden="true" tabindex="-1"></a>d_BKT_BNT <span class="ot">&lt;-</span> firstObsUnnested <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">!=</span> <span class="st">&quot;ats&quot;</span>, year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear) <span class="sc">%&gt;%</span></span>
<span id="cb56-2"><a href="models.html#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">species01 =</span> <span class="fu">ifelse</span>(species <span class="sc">==</span> <span class="st">&quot;bkt&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span></code></pre></div>
<p>Mean model functions</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="models.html#cb57-1" aria-hidden="true" tabindex="-1"></a>getMeansData <span class="ot">&lt;-</span> <span class="cf">function</span>(d, t, f) {</span>
<span id="cb57-2"><a href="models.html#cb57-2" aria-hidden="true" tabindex="-1"></a>  means <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb57-3"><a href="models.html#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(species, year) <span class="sc">%&gt;%</span> </span>
<span id="cb57-4"><a href="models.html#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">meanLength =</span> <span class="fu">mean</span>(observedLength, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb57-5"><a href="models.html#cb57-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanEmerge_detect_sumTScaled =</span> <span class="fu">mean</span>(emerge_detect_sumTScaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-6"><a href="models.html#cb57-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanEmerge_detect_sumFScaled =</span> <span class="fu">mean</span>(emerge_detect_sumTScaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-7"><a href="models.html#cb57-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanTTime_sumTScaled =</span> <span class="fu">mean</span>(<span class="fu">get</span>(t), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-8"><a href="models.html#cb57-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanFTime_sumFScaled =</span> <span class="fu">mean</span>(<span class="fu">get</span>(f), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-9"><a href="models.html#cb57-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanYdayScaled =</span> <span class="fu">mean</span>(ydayScaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-10"><a href="models.html#cb57-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanCount_Scaled =</span> <span class="fu">mean</span>(count_Scaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb57-11"><a href="models.html#cb57-11" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb57-12"><a href="models.html#cb57-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(means)</span>
<span id="cb57-13"><a href="models.html#cb57-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-14"><a href="models.html#cb57-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-15"><a href="models.html#cb57-15" aria-hidden="true" tabindex="-1"></a>getMeansDataByRiver <span class="ot">&lt;-</span> <span class="cf">function</span>(d, t, f) {</span>
<span id="cb57-16"><a href="models.html#cb57-16" aria-hidden="true" tabindex="-1"></a>  means <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb57-17"><a href="models.html#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(species, year, river) <span class="sc">%&gt;%</span> </span>
<span id="cb57-18"><a href="models.html#cb57-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">meanLength =</span> <span class="fu">mean</span>(observedLength, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb57-19"><a href="models.html#cb57-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanEmerge_detect_sumTScaled =</span> <span class="fu">mean</span>(emerge_detect_sumTScaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-20"><a href="models.html#cb57-20" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanEmerge_detect_sumFScaled =</span> <span class="fu">mean</span>(emerge_detect_sumTScaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-21"><a href="models.html#cb57-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanTTime_sumTScaled =</span> <span class="fu">mean</span>(<span class="fu">get</span>(t), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-22"><a href="models.html#cb57-22" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanFTime_sumFScaled =</span> <span class="fu">mean</span>(<span class="fu">get</span>(f), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-23"><a href="models.html#cb57-23" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanYdayScaled =</span> <span class="fu">mean</span>(ydayScaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-24"><a href="models.html#cb57-24" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanCount_Scaled =</span> <span class="fu">mean</span>(count_Scaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb57-25"><a href="models.html#cb57-25" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb57-26"><a href="models.html#cb57-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(means)</span>
<span id="cb57-27"><a href="models.html#cb57-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-28"><a href="models.html#cb57-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-29"><a href="models.html#cb57-29" aria-hidden="true" tabindex="-1"></a>plotMeans <span class="ot">&lt;-</span> <span class="cf">function</span>(means){</span>
<span id="cb57-30"><a href="models.html#cb57-30" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb57-31"><a href="models.html#cb57-31" aria-hidden="true" tabindex="-1"></a>  out[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(means, <span class="fu">aes</span>(meanTTime_sumTScaled, meanLength, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb57-32"><a href="models.html#cb57-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb57-33"><a href="models.html#cb57-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-34"><a href="models.html#cb57-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-35"><a href="models.html#cb57-35" aria-hidden="true" tabindex="-1"></a>  out[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(means, <span class="fu">aes</span>(meanFTime_sumFScaled, meanLength, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb57-36"><a href="models.html#cb57-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb57-37"><a href="models.html#cb57-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-38"><a href="models.html#cb57-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-39"><a href="models.html#cb57-39" aria-hidden="true" tabindex="-1"></a>  out[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(means, <span class="fu">aes</span>(meanTTime_sumTScaled, meanFTime_sumFScaled, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb57-40"><a href="models.html#cb57-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb57-41"><a href="models.html#cb57-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-42"><a href="models.html#cb57-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb57-43"><a href="models.html#cb57-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-44"><a href="models.html#cb57-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-45"><a href="models.html#cb57-45" aria-hidden="true" tabindex="-1"></a>runMeanModels <span class="ot">&lt;-</span> <span class="cf">function</span>(means) {</span>
<span id="cb57-46"><a href="models.html#cb57-46" aria-hidden="true" tabindex="-1"></a>  modLMMeans1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(meanLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> meanFTime_sumFScaled <span class="sc">+</span> meanTTime_sumTScaled <span class="sc">+</span> meanYdayScaled <span class="sc">+</span> meanCount_Scaled), <span class="at">data =</span> means)</span>
<span id="cb57-47"><a href="models.html#cb57-47" aria-hidden="true" tabindex="-1"></a>  modLMMeans2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(meanLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> meanFTime_sumFScaled <span class="sc">+</span> meanTTime_sumTScaled <span class="sc">+</span> meanYdayScaled <span class="sc">+</span> meanCount_Scaled)<span class="sc">^</span><span class="dv">2</span>, <span class="at">data =</span> means)</span>
<span id="cb57-48"><a href="models.html#cb57-48" aria-hidden="true" tabindex="-1"></a>  modLMMeans3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(meanLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> meanFTime_sumFScaled <span class="sc">+</span> meanTTime_sumTScaled <span class="sc">+</span> meanYdayScaled <span class="sc">+</span> meanCount_Scaled)<span class="sc">^</span><span class="dv">3</span>, <span class="at">data =</span> means)</span>
<span id="cb57-49"><a href="models.html#cb57-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(modLMMeans1, modLMMeans2, modLMMeans3))</span>
<span id="cb57-50"><a href="models.html#cb57-50" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Mean lengths by river. This is information only. Using the WB data only shown here and in the next graph for the models.
<img src="westBrook-book_files/figure-html/meanLengthsR-1.png" width="672" /></p>
<p>Mean lengths for the mean length model.
<img src="westBrook-book_files/figure-html/meanLengths-1.png" width="672" /></p>
<p>Graphs for variables that do not depend on number of months
<img src="westBrook-book_files/figure-html/staticGraphs-1.png" width="672" /><img src="westBrook-book_files/figure-html/staticGraphs-2.png" width="672" /></p>
<div id="models-with-flow-and-temperature-from-previous-one-month" class="section level4 hasAnchor" number="3.1.6.1">
<h4><span class="header-section-number">3.1.6.1</span> Models with flow and temperature from previous <em>one</em> month<a href="models.html#models-with-flow-and-temperature-from-previous-one-month" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<pre><code>## [[1]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means1Month-1.png" width="672" /></p>
<pre><code>## 
## [[2]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means1Month-2.png" width="672" /></p>
<pre><code>## 
## [[3]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means1Month-3.png" width="672" /></p>
<pre><code>##           df      AIC
## mod1[[2]] 17 176.2075
## mod1[[3]] 27 181.7035
## mod1[[1]]  7 181.8187</code></pre>
<pre><code>## 
## Call:
## lm(formula = meanLength ~ (factor(species) + meanFTime_sumFScaled + 
##     meanTTime_sumTScaled + meanYdayScaled + meanCount_Scaled), 
##     data = means)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -6.2779 -1.9839 -0.8754  1.0981 10.5908 
## 
## Coefficients:
##                      Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)           72.4359     1.0722  67.558  &lt; 2e-16 ***
## factor(species)bnt     0.6550     1.3128   0.499 0.622039    
## meanFTime_sumFScaled   1.6769     0.3849   4.356 0.000184 ***
## meanTTime_sumTScaled -10.3842     2.3734  -4.375 0.000175 ***
## meanYdayScaled        -3.4856     1.7314  -2.013 0.054554 .  
## meanCount_Scaled      -2.5187     0.7068  -3.564 0.001443 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 3.695 on 26 degrees of freedom
## Multiple R-squared:  0.6966, Adjusted R-squared:  0.6383 
## F-statistic: 11.94 on 5 and 26 DF,  p-value: 4.544e-06</code></pre>
<p>Relative importance for main effects model</p>
<pre><code>##      factor(species) meanFTime_sumFScaled meanTTime_sumTScaled       meanYdayScaled     meanCount_Scaled 
##           0.00395522           0.24940595           0.19990058           0.06280977           0.18053989</code></pre>
</div>
<div id="models-with-flow-and-temperature-from-previous-three-months" class="section level4 hasAnchor" number="3.1.6.2">
<h4><span class="header-section-number">3.1.6.2</span> Models with flow and temperature from previous <em>three</em> months<a href="models.html#models-with-flow-and-temperature-from-previous-three-months" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<pre><code>## [[1]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means3Month-1.png" width="672" /></p>
<pre><code>## 
## [[2]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means3Month-2.png" width="672" /></p>
<pre><code>## 
## [[3]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means3Month-3.png" width="672" /></p>
<pre><code>##           df      AIC
## mod3[[3]] 27 177.0683
## mod3[[2]] 17 181.7547
## mod3[[1]]  7 187.3979</code></pre>
<pre><code>## 
## Call:
## lm(formula = meanLength ~ (factor(species) + meanFTime_sumFScaled + 
##     meanTTime_sumTScaled + meanYdayScaled + meanCount_Scaled), 
##     data = means)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -6.3569 -2.8523  0.3445  1.8018  9.2951 
## 
## Coefficients:
##                      Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)           73.4882     1.8809  39.070  &lt; 2e-16 ***
## factor(species)bnt     0.8334     1.4312   0.582 0.565351    
## meanFTime_sumFScaled   2.2450     0.5866   3.827 0.000732 ***
## meanTTime_sumTScaled  -8.8499     3.6769  -2.407 0.023489 *  
## meanYdayScaled         0.7120     1.4287   0.498 0.622411    
## meanCount_Scaled      -3.1604     0.7937  -3.982 0.000490 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 4.032 on 26 degrees of freedom
## Multiple R-squared:  0.6388, Adjusted R-squared:  0.5694 
## F-statistic: 9.197 on 5 and 26 DF,  p-value: 3.902e-05</code></pre>
<p>Relative importance for main effects model</p>
<pre><code>##      factor(species) meanFTime_sumFScaled meanTTime_sumTScaled       meanYdayScaled     meanCount_Scaled 
##          0.004325792          0.281631981          0.060776249          0.066333713          0.225756051</code></pre>
</div>
<div id="models-with-flow-and-temperature-from-previous-five-months" class="section level4 hasAnchor" number="3.1.6.3">
<h4><span class="header-section-number">3.1.6.3</span> Models with flow and temperature from previous <em>five</em> months<a href="models.html#models-with-flow-and-temperature-from-previous-five-months" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<pre><code>## [[1]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means5Month-1.png" width="672" /></p>
<pre><code>## 
## [[2]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means5Month-2.png" width="672" /></p>
<pre><code>## 
## [[3]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means5Month-3.png" width="672" /></p>
<pre><code>##           df      AIC
## mod5[[3]] 27 167.4034
## mod5[[1]]  7 193.2144
## mod5[[2]] 17 208.3847</code></pre>
<pre><code>## 
## Call:
## lm(formula = meanLength ~ (factor(species) + meanFTime_sumFScaled + 
##     meanTTime_sumTScaled + meanYdayScaled + meanCount_Scaled), 
##     data = means)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -5.9186 -3.3732  0.3856  2.4470 11.8564 
## 
## Coefficients:
##                      Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)           71.1144     1.9342  36.767  &lt; 2e-16 ***
## factor(species)bnt     0.8911     1.5671   0.569  0.57450    
## meanFTime_sumFScaled   2.6934     0.8705   3.094  0.00468 ** 
## meanTTime_sumTScaled  -3.5748     2.9746  -1.202  0.24029    
## meanYdayScaled         3.2403     1.5506   2.090  0.04657 *  
## meanCount_Scaled      -2.8957     0.8613  -3.362  0.00240 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 4.415 on 26 degrees of freedom
## Multiple R-squared:  0.5668, Adjusted R-squared:  0.4835 
## F-statistic: 6.805 on 5 and 26 DF,  p-value: 0.0003537</code></pre>
<p>Relative importance for main effects model</p>
<pre><code>##      factor(species) meanFTime_sumFScaled meanTTime_sumTScaled       meanYdayScaled     meanCount_Scaled 
##          0.004330339          0.226812955          0.017322018          0.107186866          0.211177826</code></pre>
r-squared values and AICs for 1st, 2nd (2-way interactions) and 3rd (3-way interactions) order models
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
Order
</th>
<th style="text-align:right;">
r2
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.697
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.864
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.913
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
Order
</th>
<th style="text-align:right;">
r2
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.639
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.838
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.925
</td>
<td style="text-align:right;">
3
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
Order
</th>
<th style="text-align:right;">
r2
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.567
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.628
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.945
</td>
<td style="text-align:right;">
5
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:right;">
AIC
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
mod1[[2]]
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
176.207
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
mod1[[3]]
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:right;">
181.703
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
mod1[[1]]
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
181.819
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:right;">
AIC
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
mod3[[3]]
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:right;">
177.068
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
mod3[[2]]
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
181.755
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
mod3[[1]]
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
187.398
</td>
<td style="text-align:right;">
3
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:right;">
AIC
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
mod5[[3]]
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:right;">
167.403
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
mod5[[1]]
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
193.214
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
mod5[[2]]
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
208.385
</td>
<td style="text-align:right;">
5
</td>
</tr>
</tbody>
</table>
Relative importance of main effects models (repeat of above, but all in one place here)
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
var
</th>
<th style="text-align:right;">
relImp
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
factor(species)
</td>
<td style="text-align:right;">
0.004
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
meanFTime_sumFScaled
</td>
<td style="text-align:right;">
0.249
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
meanTTime_sumTScaled
</td>
<td style="text-align:right;">
0.200
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
meanYdayScaled
</td>
<td style="text-align:right;">
0.063
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
meanCount_Scaled
</td>
<td style="text-align:right;">
0.181
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
var
</th>
<th style="text-align:right;">
relImp
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
factor(species)
</td>
<td style="text-align:right;">
0.004
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
meanFTime_sumFScaled
</td>
<td style="text-align:right;">
0.282
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
meanTTime_sumTScaled
</td>
<td style="text-align:right;">
0.061
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
meanYdayScaled
</td>
<td style="text-align:right;">
0.066
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
meanCount_Scaled
</td>
<td style="text-align:right;">
0.226
</td>
<td style="text-align:right;">
3
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
var
</th>
<th style="text-align:right;">
relImp
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
factor(species)
</td>
<td style="text-align:right;">
0.004
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
meanFTime_sumFScaled
</td>
<td style="text-align:right;">
0.227
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
meanTTime_sumTScaled
</td>
<td style="text-align:right;">
0.017
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
meanYdayScaled
</td>
<td style="text-align:right;">
0.107
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
meanCount_Scaled
</td>
<td style="text-align:right;">
0.211
</td>
<td style="text-align:right;">
5
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="models-with-extreme-flow-events-droughts" class="section level3 hasAnchor" number="3.1.7">
<h3><span class="header-section-number">3.1.7</span> Models with extreme flow events (droughts)<a href="models.html#models-with-extreme-flow-events-droughts" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We get negative cumulFlows because we have some negative flows from the flow extension model</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="models.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># put some of these calculations into envDataWB</span></span>
<span id="cb76-2"><a href="models.html#cb76-2" aria-hidden="true" tabindex="-1"></a>envDataWBFlow <span class="ot">=</span> envDataWB <span class="sc">%&gt;%</span></span>
<span id="cb76-3"><a href="models.html#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(dateDate),</span>
<span id="cb76-4"><a href="models.html#cb76-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">yday =</span> <span class="fu">yday</span>(dateDate),</span>
<span id="cb76-5"><a href="models.html#cb76-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">flowNoNAs =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(flow), <span class="dv">0</span>, flow),</span>
<span id="cb76-6"><a href="models.html#cb76-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">tempNoNAs =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(temperature), <span class="dv">0</span>, temperature)) <span class="sc">%&gt;%</span></span>
<span id="cb76-7"><a href="models.html#cb76-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear, </span>
<span id="cb76-8"><a href="models.html#cb76-8" aria-hidden="true" tabindex="-1"></a>         yday <span class="sc">&gt;</span> <span class="dv">100</span>, yday <span class="sc">&lt;</span> <span class="dv">300</span>,</span>
<span id="cb76-9"><a href="models.html#cb76-9" aria-hidden="true" tabindex="-1"></a>         river <span class="sc">==</span> <span class="st">&quot;west brook&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb76-10"><a href="models.html#cb76-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb76-11"><a href="models.html#cb76-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cumulFlow =</span> <span class="fu">cumsum</span>(flowNoNAs),</span>
<span id="cb76-12"><a href="models.html#cb76-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">cumulFlow01 =</span> cumulFlow <span class="sc">/</span> <span class="fu">max</span>(cumulFlow),</span>
<span id="cb76-13"><a href="models.html#cb76-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">cumulTemp =</span> <span class="fu">cumsum</span>(tempNoNAs)) <span class="sc">%&gt;%</span></span>
<span id="cb76-14"><a href="models.html#cb76-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb76-15"><a href="models.html#cb76-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-16"><a href="models.html#cb76-16" aria-hidden="true" tabindex="-1"></a>firstObsYears <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span></span>
<span id="cb76-17"><a href="models.html#cb76-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear, </span>
<span id="cb76-18"><a href="models.html#cb76-18" aria-hidden="true" tabindex="-1"></a>           yday <span class="sc">&gt;</span> <span class="dv">100</span>, yday <span class="sc">&lt;</span> <span class="dv">300</span>)</span>
<span id="cb76-19"><a href="models.html#cb76-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-20"><a href="models.html#cb76-20" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(envDataWBFlow, <span class="fu">aes</span>(yday, flow)) <span class="sc">+</span></span>
<span id="cb76-21"><a href="models.html#cb76-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(yday, observedLength<span class="sc">/</span><span class="dv">20</span>), <span class="at">size =</span> <span class="fl">0.75</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="st">&#39;lightblue&#39;</span>, <span class="at">data =</span> firstObsYears) <span class="sc">+</span></span>
<span id="cb76-22"><a href="models.html#cb76-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb76-23"><a href="models.html#cb76-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">300</span>, <span class="dv">30</span>)) <span class="sc">+</span></span>
<span id="cb76-24"><a href="models.html#cb76-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>year)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/drought-1.png" width="672" /></p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="models.html#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(envDataWBFlow, <span class="fu">aes</span>(yday, cumulFlow <span class="sc">/</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb77-2"><a href="models.html#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(yday, observedLength <span class="sc">/</span> <span class="dv">20</span>), <span class="at">size =</span> <span class="fl">0.75</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="st">&#39;lightblue&#39;</span>, <span class="at">data =</span> firstObsYears) <span class="sc">+</span></span>
<span id="cb77-3"><a href="models.html#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">&#39;darkgrey&#39;</span>) <span class="sc">+</span></span>
<span id="cb77-4"><a href="models.html#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(yday, cumulTemp <span class="sc">/</span> <span class="dv">800</span>), <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">&quot;orange&quot;</span>, <span class="at">data =</span> envDataWBFlow) <span class="sc">+</span></span>
<span id="cb77-5"><a href="models.html#cb77-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(yday, flow), <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">data =</span> envDataWBFlow) <span class="sc">+</span></span>
<span id="cb77-6"><a href="models.html#cb77-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">300</span>, <span class="dv">30</span>)) <span class="sc">+</span></span>
<span id="cb77-7"><a href="models.html#cb77-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#theme_publication() +</span></span>
<span id="cb77-8"><a href="models.html#cb77-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>year)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/drought-2.png" width="672" /></p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="models.html#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(envDataWBFlow, <span class="fu">aes</span>(yday, cumulFlow, <span class="at">color =</span> (year))) <span class="sc">+</span></span>
<span id="cb78-2"><a href="models.html#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb78-3"><a href="models.html#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">300</span>, <span class="dv">30</span>)) </span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/drought-3.png" width="672" /></p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="models.html#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(envDataWBFlow, <span class="fu">aes</span>(yday, cumulTemp, <span class="at">color =</span> (year))) <span class="sc">+</span></span>
<span id="cb79-2"><a href="models.html#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb79-3"><a href="models.html#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_point(aes(yday, cumulTemp / 800, color = factor(year)), data = tmp) +</span></span>
<span id="cb79-4"><a href="models.html#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">300</span>, <span class="dv">30</span>))</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/drought-4.png" width="672" /></p>
<p>Is there a sampling section effect?</p>
<p>Note: there are fish in sections &gt; 50 for years 2002 and 2003, need to filter out early</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="models.html#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_WB_BKT_BNT <span class="sc">%&gt;%</span> <span class="fu">filter</span>( section <span class="sc">&lt;=</span> <span class="dv">47</span>), <span class="fu">aes</span>(<span class="fu">factor</span>(section), observedLength)) <span class="sc">+</span></span>
<span id="cb80-2"><a href="models.html#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb80-3"><a href="models.html#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb80-4"><a href="models.html#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>year)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="models.html#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_WB_BKT_BNT <span class="sc">%&gt;%</span> <span class="fu">filter</span>( section <span class="sc">&lt;=</span> <span class="dv">47</span>), <span class="fu">aes</span>(<span class="fu">factor</span>(year), observedLength)) <span class="sc">+</span></span>
<span id="cb81-2"><a href="models.html#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb81-3"><a href="models.html#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb81-4"><a href="models.html#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>section)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-8-2.png" width="672" /></p>
</div>
<div id="models-based-on-individual-observations" class="section level3 hasAnchor" number="3.1.8">
<h3><span class="header-section-number">3.1.8</span> Models based on individual observations<a href="models.html#models-based-on-individual-observations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Probably not use these, too much individual variation</p>
<div id="are-flow-and-temperature-correlated-for-individual-observations" class="section level4 hasAnchor" number="3.1.8.1">
<h4><span class="header-section-number">3.1.8.1</span> Are flow and temperature correlated for individual observations?<a href="models.html#are-flow-and-temperature-correlated-for-individual-observations" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="models.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(firstObsUnnestedWB, <span class="fu">aes</span>(oneMonth_sumTScaled, oneMonth_sumFScaled)) <span class="sc">+</span></span>
<span id="cb82-2"><a href="models.html#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> (year))) <span class="sc">+</span></span>
<span id="cb82-3"><a href="models.html#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb82-4"><a href="models.html#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowTempCor-1.png" width="672" /></p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="models.html#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(firstObsUnnestedWB, <span class="fu">aes</span>(threeMonth_sumTScaled, threeMonth_sumFScaled)) <span class="sc">+</span></span>
<span id="cb83-2"><a href="models.html#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> (year))) <span class="sc">+</span></span>
<span id="cb83-3"><a href="models.html#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb83-4"><a href="models.html#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowTempCor-2.png" width="672" /></p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="models.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(firstObsUnnestedWB, <span class="fu">aes</span>(fiveMonth_sumTScaled, fiveMonth_sumFScaled)) <span class="sc">+</span></span>
<span id="cb84-2"><a href="models.html#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> (year))) <span class="sc">+</span></span>
<span id="cb84-3"><a href="models.html#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb84-4"><a href="models.html#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowTempCor-3.png" width="672" /></p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="models.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># water getting warmer during a sample</span></span>
<span id="cb85-2"><a href="models.html#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(firstObsUnnestedWB, <span class="fu">aes</span>(fiveMonth_sumTScaled, fiveMonth_sumFScaled)) <span class="sc">+</span></span>
<span id="cb85-3"><a href="models.html#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> (yday))) <span class="sc">+</span></span>
<span id="cb85-4"><a href="models.html#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb85-5"><a href="models.html#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowTempCor-4.png" width="672" /></p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="models.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB<span class="sc">$</span>oneMonth_sumTScaled, firstObsUnnestedWB<span class="sc">$</span>oneMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.1778785</code></pre>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="models.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB<span class="sc">$</span>threeMonth_sumTScaled, firstObsUnnestedWB<span class="sc">$</span>threeMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.01625096</code></pre>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="models.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB<span class="sc">$</span>fiveMonth_sumTScaled, firstObsUnnestedWB<span class="sc">$</span>fiveMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.09445786</code></pre>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="models.html#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># brook trout</span></span>
<span id="cb92-2"><a href="models.html#cb92-2" aria-hidden="true" tabindex="-1"></a>firstObsUnnestedWB_BKT <span class="ot">&lt;-</span> firstObsUnnestedWB <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">==</span> <span class="st">&quot;bkt&quot;</span>)</span>
<span id="cb92-3"><a href="models.html#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB_BKT<span class="sc">$</span>oneMonth_sumTScaled, firstObsUnnestedWB_BKT<span class="sc">$</span>oneMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] 0.05756251</code></pre>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="models.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB_BKT<span class="sc">$</span>threeMonth_sumTScaled, firstObsUnnestedWB_BKT<span class="sc">$</span>threeMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.008944376</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="models.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB_BKT<span class="sc">$</span>fiveMonth_sumTScaled, firstObsUnnestedWB_BKT<span class="sc">$</span>fiveMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.1172725</code></pre>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="models.html#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># brown trout</span></span>
<span id="cb98-2"><a href="models.html#cb98-2" aria-hidden="true" tabindex="-1"></a>firstObsUnnestedWB_BNT <span class="ot">&lt;-</span> firstObsUnnestedWB <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">==</span> <span class="st">&quot;bnt&quot;</span>)</span>
<span id="cb98-3"><a href="models.html#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB_BNT<span class="sc">$</span>oneMonth_sumTScaled, firstObsUnnestedWB_BNT<span class="sc">$</span>oneMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] 0.1403489</code></pre>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="models.html#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB_BNT<span class="sc">$</span>threeMonth_sumTScaled, firstObsUnnestedWB_BNT<span class="sc">$</span>threeMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.103418</code></pre>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="models.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB_BNT<span class="sc">$</span>fiveMonth_sumTScaled, firstObsUnnestedWB_BNT<span class="sc">$</span>fiveMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.009179518</code></pre>
<p>Do fish from long samples get bigger over time?<br />
No clear evidence.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="models.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(firstObsUnnestedWB, <span class="fu">aes</span>(yday, observedLength)) <span class="sc">+</span></span>
<span id="cb104-2"><a href="models.html#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb104-3"><a href="models.html#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb104-4"><a href="models.html#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>year)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>Assign the month interval (one, three, five) for flow and temperature variables. The variable will be accessed using e.g.Â <code>get(tTime)</code> in formulas and filters</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="models.html#cb105-1" aria-hidden="true" tabindex="-1"></a>tTime <span class="ot">&lt;-</span> <span class="st">&quot;threeMonth_sumTScaled&quot;</span></span>
<span id="cb105-2"><a href="models.html#cb105-2" aria-hidden="true" tabindex="-1"></a>fTime <span class="ot">&lt;-</span> <span class="st">&quot;threeMonth_sumFScaled&quot;</span> <span class="co">#&quot;fiveMonth_sumFScaled&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="models.html#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb106-2"><a href="models.html#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(relaimpo)</span>
<span id="cb106-3"><a href="models.html#cb106-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-4"><a href="models.html#cb106-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-5"><a href="models.html#cb106-5" aria-hidden="true" tabindex="-1"></a>modLM1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> <span class="fu">get</span>(tTime) <span class="sc">*</span> <span class="fu">get</span>(fTime) <span class="sc">*</span> ydayScaled <span class="sc">*</span> count_Scaled), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb106-6"><a href="models.html#cb106-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-7"><a href="models.html#cb106-7" aria-hidden="true" tabindex="-1"></a>modLM2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> <span class="fu">get</span>(tTime) <span class="sc">+</span> <span class="fu">get</span>(fTime) <span class="sc">+</span> ydayScaled <span class="sc">+</span> count_Scaled), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb106-8"><a href="models.html#cb106-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-9"><a href="models.html#cb106-9" aria-hidden="true" tabindex="-1"></a>modLM3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> <span class="fu">get</span>(tTime) <span class="sc">+</span> <span class="fu">get</span>(fTime) <span class="sc">+</span> ydayScaled <span class="sc">+</span> count_Scaled)<span class="sc">^</span><span class="dv">2</span>, <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb106-10"><a href="models.html#cb106-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-11"><a href="models.html#cb106-11" aria-hidden="true" tabindex="-1"></a>modLM1a <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species)), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb106-12"><a href="models.html#cb106-12" aria-hidden="true" tabindex="-1"></a>modLM1b <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> <span class="fu">get</span>(tTime)), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb106-13"><a href="models.html#cb106-13" aria-hidden="true" tabindex="-1"></a>modLM1c <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> <span class="fu">get</span>(fTime)), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb106-14"><a href="models.html#cb106-14" aria-hidden="true" tabindex="-1"></a>modLM1d <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> ydayScaled), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb106-15"><a href="models.html#cb106-15" aria-hidden="true" tabindex="-1"></a>modLM1e <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> count_Scaled), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb106-16"><a href="models.html#cb106-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-17"><a href="models.html#cb106-17" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(modLM1, modLM2, modLM3, modLM1a, modLM1b, modLM1c, modLM1d, modLM1e) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(AIC)</span></code></pre></div>
<pre><code>##         df      AIC
## modLM1  33 61643.33
## modLM3  17 61807.67
## modLM2   7 62669.02
## modLM1c  5 63224.10
## modLM1e  5 63624.09
## modLM1d  5 63755.95
## modLM1b  5 63777.11
## modLM1a  3 63918.49</code></pre>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="models.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co">#relaimpo::calc.relimp(modLM2) # slow for bigger models</span></span>
<span id="cb108-2"><a href="models.html#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="models.html#cb108-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-4"><a href="models.html#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="co"># get &#39;boundary (singular)&#39; error with model without 2-way interaction</span></span>
<span id="cb108-5"><a href="models.html#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="co">#modLMER2 &lt;- lmer(observedLength ~ (factor(species) + emerge_detect_sumTScaled + emerge_detect_sumFScaled + ydayScaled +count_Scaled)^2 + 1|year, data = d_WB_BKT_BNT)</span></span></code></pre></div>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="models.html#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co">#https://gist.github.com/BERENZ/e9b581a4b7160357934e</span></span>
<span id="cb109-2"><a href="models.html#cb109-2" aria-hidden="true" tabindex="-1"></a>calc.relip.mm <span class="ot">&lt;-</span> <span class="cf">function</span>(model,<span class="at">type=</span><span class="st">&#39;lmg&#39;</span>) {</span>
<span id="cb109-3"><a href="models.html#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">isLMM</span>(model) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">isGLMM</span>(model)) {</span>
<span id="cb109-4"><a href="models.html#cb109-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&#39;Currently supports only lmer/glmer objects&#39;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb109-5"><a href="models.html#cb109-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb109-6"><a href="models.html#cb109-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">require</span>(lme4)</span>
<span id="cb109-7"><a href="models.html#cb109-7" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">getME</span>(model,<span class="st">&#39;X&#39;</span>)</span>
<span id="cb109-8"><a href="models.html#cb109-8" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> X[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb109-9"><a href="models.html#cb109-9" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">getME</span>(model,<span class="st">&#39;y&#39;</span>)</span>
<span id="cb109-10"><a href="models.html#cb109-10" aria-hidden="true" tabindex="-1"></a>  s_resid <span class="ot">&lt;-</span> <span class="fu">sigma</span>(model)</span>
<span id="cb109-11"><a href="models.html#cb109-11" aria-hidden="true" tabindex="-1"></a>  s_effect <span class="ot">&lt;-</span> <span class="fu">getME</span>(model,<span class="st">&#39;theta&#39;</span>)<span class="sc">*</span>s_resid</span>
<span id="cb109-12"><a href="models.html#cb109-12" aria-hidden="true" tabindex="-1"></a>  s2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(s_resid<span class="sc">^</span><span class="dv">2</span>,s_effect<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb109-13"><a href="models.html#cb109-13" aria-hidden="true" tabindex="-1"></a>  V <span class="ot">&lt;-</span> <span class="fu">Diagonal</span>(<span class="at">x =</span> s2,<span class="at">n=</span><span class="fu">nrow</span>(X))</span>
<span id="cb109-14"><a href="models.html#cb109-14" aria-hidden="true" tabindex="-1"></a>  YX <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Y,X)</span>
<span id="cb109-15"><a href="models.html#cb109-15" aria-hidden="true" tabindex="-1"></a>  cov_XY <span class="ot">&lt;-</span> <span class="fu">solve</span>( <span class="fu">t</span>(YX) <span class="sc">%*%</span> <span class="fu">solve</span>(V) <span class="sc">%*%</span> <span class="fu">as.matrix</span>(YX))</span>
<span id="cb109-16"><a href="models.html#cb109-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(cov_XY) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(cov_XY) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(YX)</span>
<span id="cb109-17"><a href="models.html#cb109-17" aria-hidden="true" tabindex="-1"></a>  importances <span class="ot">&lt;-</span> <span class="fu">calc.relimp</span>(<span class="fu">as.matrix</span>(cov_XY),<span class="at">rela=</span>T,<span class="at">type=</span>type)</span>
<span id="cb109-18"><a href="models.html#cb109-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(importances)</span>
<span id="cb109-19"><a href="models.html#cb109-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="models.html#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co">#modLMER1 &lt;- lmer(observedLength ~ (factor(species) + get(tTime)|year + get(fTime)|year + ydayScaled|year + count_Scaled|year), data = d_WB_BKT_BNT)</span></span>
<span id="cb110-2"><a href="models.html#cb110-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-3"><a href="models.html#cb110-3" aria-hidden="true" tabindex="-1"></a>modLMER1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> <span class="fu">get</span>(tTime) <span class="sc">*</span> <span class="fu">get</span>(fTime) <span class="sc">*</span> ydayScaled <span class="sc">*</span> count_Scaled) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb110-4"><a href="models.html#cb110-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-5"><a href="models.html#cb110-5" aria-hidden="true" tabindex="-1"></a>modLMER2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> <span class="fu">get</span>(tTime) <span class="sc">+</span> <span class="fu">get</span>(fTime) <span class="sc">+</span> ydayScaled <span class="sc">+</span> count_Scaled) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb110-6"><a href="models.html#cb110-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-7"><a href="models.html#cb110-7" aria-hidden="true" tabindex="-1"></a>modLMER3 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> <span class="fu">get</span>(tTime) <span class="sc">+</span> <span class="fu">get</span>(fTime) <span class="sc">+</span> ydayScaled <span class="sc">+</span> count_Scaled)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb110-8"><a href="models.html#cb110-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-9"><a href="models.html#cb110-9" aria-hidden="true" tabindex="-1"></a><span class="co"># one-by-one</span></span>
<span id="cb110-10"><a href="models.html#cb110-10" aria-hidden="true" tabindex="-1"></a>modLMER1a <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species))  <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb110-11"><a href="models.html#cb110-11" aria-hidden="true" tabindex="-1"></a>modLMER1b <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> <span class="fu">get</span>(tTime))  <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb110-12"><a href="models.html#cb110-12" aria-hidden="true" tabindex="-1"></a>modLMER1c <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> <span class="fu">get</span>(fTime)) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb110-13"><a href="models.html#cb110-13" aria-hidden="true" tabindex="-1"></a>modLMER1d <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> ydayScaled) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb110-14"><a href="models.html#cb110-14" aria-hidden="true" tabindex="-1"></a>modLMER1e <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> count_Scaled) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb110-15"><a href="models.html#cb110-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-16"><a href="models.html#cb110-16" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(modLMER1, modLMER2, modLMER3, modLMER1a, modLMER1b, modLMER1c, modLMER1d, modLMER1e) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(AIC)</span></code></pre></div>
<pre><code>##           df      AIC
## modLMER1  34 61236.76
## modLMER3  18 61411.21
## modLMER1d  6 61466.63
## modLMER2   8 61470.46
## modLMER1e  6 61471.21
## modLMER1c  6 61472.64
## modLMER1b  6 61473.34
## modLMER1a  4 61475.77</code></pre>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="models.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">calc.relip.mm</span>(modLMER3)</span></code></pre></div>
<pre><code>## Response variable: Y 
## Total response variance: 3.893283e-05 
## 
## 15 Regressors: 
## factor(species)bnt get(tTime) get(fTime) ydayScaled count_Scaled factor(species)bnt:get(tTime) factor(species)bnt:get(fTime) factor(species)bnt:ydayScaled factor(species)bnt:count_Scaled get(tTime):get(fTime) get(tTime):ydayScaled get(tTime):count_Scaled get(fTime):ydayScaled get(fTime):count_Scaled ydayScaled:count_Scaled 
## Proportion of variance explained by model: 94.15%
## Metrics are normalized to sum to 100% (rela=TRUE). 
## 
## Relative importance metrics: 
## 
##                                         lmg
## factor(species)bnt              0.097760307
## get(tTime)                      0.419878608
## get(fTime)                      0.092676088
## ydayScaled                      0.033569860
## count_Scaled                    0.078624107
## factor(species)bnt:get(tTime)   0.065441939
## factor(species)bnt:get(fTime)   0.012771321
## factor(species)bnt:ydayScaled   0.001781329
## factor(species)bnt:count_Scaled 0.019728183
## get(tTime):get(fTime)           0.071941193
## get(tTime):ydayScaled           0.029205652
## get(tTime):count_Scaled         0.041529196
## get(fTime):ydayScaled           0.011797805
## get(fTime):count_Scaled         0.012243731
## ydayScaled:count_Scaled         0.011050681
## 
## Average coefficients for different model sizes: 
## 
##                                            1X           2Xs           3Xs           4Xs           5Xs           6Xs
## factor(species)bnt              -0.0054984017 -0.0050704814 -0.0047545824 -0.0045389793 -0.0044124337 -4.364877e-03
## get(tTime)                      -0.0065705658 -0.0064807310 -0.0063924113 -0.0063084199 -0.0062305836 -6.159911e-03
## get(fTime)                      -0.0086478481 -0.0078930543 -0.0071804983 -0.0065359969 -0.0059811793 -5.531536e-03
## ydayScaled                       0.0031793857  0.0027052187  0.0022831959  0.0019197886  0.0016131058  1.358765e-03
## count_Scaled                    -0.0083583700 -0.0078052106 -0.0072775852 -0.0068141491 -0.0064372666 -6.153114e-03
## factor(species)bnt:get(tTime)    0.0025119506  0.0020567879  0.0016471742  0.0012672530  0.0009056673  5.550952e-04
## factor(species)bnt:get(fTime)    0.0060183654  0.0047218822  0.0036288022  0.0027025061  0.0019065191  1.208199e-03
## factor(species)bnt:ydayScaled   -0.0002196817 -0.0002660699 -0.0003114297 -0.0003574487 -0.0004026767 -4.443192e-04
## factor(species)bnt:count_Scaled  0.0067855005  0.0051864389  0.0038694571  0.0027807734  0.0018716941  1.101015e-03
## get(tTime):get(fTime)            0.0032931088  0.0027736154  0.0023758016  0.0020597885  0.0017908497  1.540839e-03
## get(tTime):ydayScaled           -0.0013525912 -0.0010122936 -0.0007224178 -0.0004705386 -0.0002496660 -5.582531e-05
## get(tTime):count_Scaled          0.0023356306  0.0018431949  0.0014769807  0.0011882760  0.0009424538  7.171659e-04
## get(fTime):ydayScaled           -0.0024680341 -0.0027398874 -0.0028756456 -0.0029246083 -0.0029130457 -2.855016e-03
## get(fTime):count_Scaled          0.0011703243 -0.0002162869 -0.0012391144 -0.0020246858 -0.0026437455 -3.130556e-03
## ydayScaled:count_Scaled         -0.0060601403 -0.0042294345 -0.0028505144 -0.0018549978 -0.0011694592 -7.240908e-04
##                                           7Xs           8Xs           9Xs          10Xs          11Xs          12Xs
## factor(species)bnt              -0.0043881071 -4.475745e-03 -0.0046223344 -0.0048218598 -5.066310e-03 -5.345099e-03
## get(tTime)                      -0.0060966732 -6.040385e-03 -0.0059898316 -0.0059432666 -5.898799e-03 -5.854907e-03
## get(fTime)                      -0.0051950013 -4.970278e-03 -0.0048458768 -0.0048005235 -4.804691e-03 -4.822743e-03
## ydayScaled                       0.0011534566  9.968974e-04  0.0008927463  0.0008487173  8.757443e-04  9.858444e-04
## count_Scaled                    -0.0059544293 -5.824393e-03 -0.0057402718 -0.0056771394 -5.612643e-03 -5.533014e-03
## factor(species)bnt:get(tTime)    0.0002111539 -1.287035e-04 -0.0004659555 -0.0008012831 -1.134412e-03 -1.463815e-03
## factor(species)bnt:get(fTime)    0.0005806889  3.882144e-06 -0.0005343247 -0.0010365233 -1.495172e-03 -1.894321e-03
## factor(species)bnt:ydayScaled   -0.0004787153 -5.010271e-04 -0.0005046357 -0.0004807007 -4.185323e-04 -3.073680e-04
## factor(species)bnt:count_Scaled  0.0004359225 -1.482176e-04 -0.0006682334 -0.0011336990 -1.548402e-03 -1.913621e-03
## get(tTime):get(fTime)            0.0012890129  1.022548e-03  0.0007363939  0.0004323806  1.179063e-04 -1.953488e-04
## get(tTime):ydayScaled            0.0001139192  2.627106e-04  0.0003945425  0.0005145068  6.287198e-04  7.438227e-04
## get(tTime):count_Scaled          0.0005002465  2.873275e-04  0.0000795192 -0.0001188814 -3.028894e-04 -4.695265e-04
## get(fTime):ydayScaled           -0.0027585842 -2.629436e-03 -0.0024725885 -0.0022926181 -2.093092e-03 -1.875890e-03
## get(fTime):count_Scaled         -0.0034980296 -3.748389e-03 -0.0038800558 -0.0038917388 -3.784748e-03 -3.564784e-03
## ydayScaled:count_Scaled         -0.0004553432 -3.058715e-04 -0.0002237541 -0.0001619201 -7.825575e-05  6.336058e-05
##                                          13Xs          14Xs          15Xs
## factor(species)bnt              -0.0056461457 -5.959040e-03 -0.0062796744
## get(tTime)                      -0.0058109959 -5.767910e-03 -0.0057282815
## get(fTime)                      -0.0048158521 -4.746171e-03 -0.0045799533
## ydayScaled                       0.0011888137  1.489186e-03  0.0018864288
## count_Scaled                    -0.0054389891 -5.349606e-03 -0.0053039170
## factor(species)bnt:get(tTime)   -0.0017867916 -2.100436e-03 -0.0024036120
## factor(species)bnt:get(fTime)   -0.0022142922 -2.438114e-03 -0.0025565105
## factor(species)bnt:ydayScaled   -0.0001392003  8.910015e-05  0.0003764257
## factor(species)bnt:count_Scaled -0.0022331996 -2.519186e-03 -0.0027966124
## get(tTime):get(fTime)           -0.0004927221 -7.584234e-04 -0.0009773304
## get(tTime):ydayScaled            0.0008660298  1.000118e-03  0.0011493099
## get(tTime):count_Scaled         -0.0006202278 -7.623248e-04 -0.0009098491
## get(fTime):ydayScaled           -0.0016406077 -1.384448e-03 -0.0011021992
## get(fTime):count_Scaled         -0.0032439647 -2.841580e-03 -0.0023829029
## ydayScaled:count_Scaled          0.0002913468  6.252846e-04  0.0010782461</code></pre>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="models.html#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MuMIn)</span>
<span id="cb114-2"><a href="models.html#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">r.squaredGLMM</span>(modLMER1)</span></code></pre></div>
<pre><code>##            R2m       R2c
## [1,] 0.2001733 0.6185189</code></pre>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="models.html#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modLMER1)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: observedLength ~ (factor(species) * get(tTime) * get(fTime) *      ydayScaled * count_Scaled) + (1 | year)
##    Data: d_WB_BKT_BNT
## 
## REML criterion at convergence: 61168.8
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -3.4018 -0.6876 -0.0288  0.6436  6.6810 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  year     (Intercept) 85.83    9.264   
##  Residual             78.27    8.847   
## Number of obs: 8499, groups:  year, 16
## 
## Fixed effects:
##                                                                  Estimate Std. Error t value
## (Intercept)                                                       80.8481     4.1701  19.388
## factor(species)bnt                                                -4.9284     1.4042  -3.510
## get(tTime)                                                       -21.6554     7.2622  -2.982
## get(fTime)                                                         9.4220     4.0516   2.325
## ydayScaled                                                        -4.0731     2.7473  -1.483
## count_Scaled                                                      -6.0394     4.2307  -1.427
## factor(species)bnt:get(tTime)                                     12.0455     2.5799   4.669
## factor(species)bnt:get(fTime)                                      0.3451     1.5233   0.227
## get(tTime):get(fTime)                                            -16.8596     7.6738  -2.197
## factor(species)bnt:ydayScaled                                      0.6682     3.0523   0.219
## get(tTime):ydayScaled                                              1.0575     5.4994   0.192
## get(fTime):ydayScaled                                             -9.3848     2.6598  -3.528
## factor(species)bnt:count_Scaled                                    0.8883     1.0017   0.887
## get(tTime):count_Scaled                                           13.6476     9.5497   1.429
## get(fTime):count_Scaled                                          -15.7569     3.8771  -4.064
## ydayScaled:count_Scaled                                            9.2820     2.0254   4.583
## factor(species)bnt:get(tTime):get(fTime)                          -7.3923     3.1937  -2.315
## factor(species)bnt:get(tTime):ydayScaled                           2.1106     6.5449   0.322
## factor(species)bnt:get(fTime):ydayScaled                          -0.9930     2.7942  -0.355
## get(tTime):get(fTime):ydayScaled                                  10.3113     5.9959   1.720
## factor(species)bnt:get(tTime):count_Scaled                        -2.1328     2.5544  -0.835
## factor(species)bnt:get(fTime):count_Scaled                         6.4230     1.8794   3.418
## get(tTime):get(fTime):count_Scaled                                18.3310     9.7834   1.874
## factor(species)bnt:ydayScaled:count_Scaled                        -5.4154     2.0331  -2.664
## get(tTime):ydayScaled:count_Scaled                               -18.1465     5.1346  -3.534
## get(fTime):ydayScaled:count_Scaled                                 5.0809     2.7461   1.850
## factor(species)bnt:get(tTime):get(fTime):ydayScaled                6.9942     7.1420   0.979
## factor(species)bnt:get(tTime):get(fTime):count_Scaled            -16.6416     4.1143  -4.045
## factor(species)bnt:get(tTime):ydayScaled:count_Scaled             12.3811     5.7403   2.157
## factor(species)bnt:get(fTime):ydayScaled:count_Scaled              0.8281     3.2880   0.252
## get(tTime):get(fTime):ydayScaled:count_Scaled                    -15.0936     7.8332  -1.927
## factor(species)bnt:get(tTime):get(fTime):ydayScaled:count_Scaled   0.3270     9.4661   0.035</code></pre>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="models.html#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ranef</span>(modLMER1)</span></code></pre></div>
<pre><code>## $year
##      (Intercept)
## 2000   8.8500565
## 2001  -8.4985347
## 2002  -7.3323965
## 2003  -1.5660312
## 2004  -5.1466870
## 2005  -1.0172900
## 2006   3.5989690
## 2007  10.3090430
## 2008  -0.7230606
## 2009   6.7853759
## 2010   5.6472890
## 2011 -21.6975629
## 2012  -3.4055069
## 2013   9.6487802
## 2014   4.0152310
## 2015   0.5323252
## 
## with conditional variances for &quot;year&quot;</code></pre>
<p>Raw data exploration following the models</p>
<p>relaimpo::calc.relimp(modLM2) - other models are too big
lmg
factor(species) 0.005339423
emerge_detect_sumTScaled 0.006883496
emerge_detect_sumFScaled 0.063450197
ydayScaled 0.012116064
count_Scaled 0.028031531</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="models.html#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_WB_BKT_BNT, <span class="fu">aes</span>(<span class="fu">get</span>(fTime), observedLength)) <span class="sc">+</span></span>
<span id="cb120-2"><a href="models.html#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb120-3"><a href="models.html#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb120-4"><a href="models.html#cb120-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/plotRawInd-1.png" width="672" /></p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="models.html#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_WB_BKT_BNT, <span class="fu">aes</span>(count_Scaled, observedLength)) <span class="sc">+</span></span>
<span id="cb121-2"><a href="models.html#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb121-3"><a href="models.html#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb121-4"><a href="models.html#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/plotRawInd-2.png" width="672" /></p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="models.html#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_WB_BKT_BNT, <span class="fu">aes</span>(ydayScaled, observedLength)) <span class="sc">+</span></span>
<span id="cb122-2"><a href="models.html#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb122-3"><a href="models.html#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb122-4"><a href="models.html#cb122-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/plotRawInd-3.png" width="672" /></p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="models.html#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_WB_BKT_BNT, <span class="fu">aes</span>(<span class="fu">get</span>(tTime), observedLength)) <span class="sc">+</span></span>
<span id="cb123-2"><a href="models.html#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb123-3"><a href="models.html#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb123-4"><a href="models.html#cb123-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/plotRawInd-4.png" width="672" /></p>

</div>
</div>
</div>
<div id="modelFlow" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Flow model<a href="models.html#modelFlow" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="models.html#cb124-1" aria-hidden="true" tabindex="-1"></a>dataFlow <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;./dataIn/wbFlow/EcoDrought_Continuous_MA.csv&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="models.html#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(dataFlow)</span></code></pre></div>
<pre><code>## # A tibble: 582,388 Ã— 9
##    Station_No Site_Name   DateTime_EST   GageHeight_Hobo_ft Discharge_Hobo_cfs WaterTemperature_HOBO_Dâ€¦ AirPressure_PSI
##         &lt;int&gt; &lt;chr&gt;       &lt;chr&gt;                       &lt;dbl&gt;              &lt;dbl&gt;                    &lt;dbl&gt;           &lt;dbl&gt;
##  1    1171000 Avery Brook 2/20/2020 0:00               4.17               5.37                     32.0              NA
##  2    1171000 Avery Brook 2/20/2020 0:15               4.17               5.3                      32.0              NA
##  3    1171000 Avery Brook 2/20/2020 0:30               4.16               5.17                     32.0              NA
##  4    1171000 Avery Brook 2/20/2020 0:45               4.17               5.27                     32.0              NA
##  5    1171000 Avery Brook 2/20/2020 1:00               4.17               5.3                      32.0              NA
##  6    1171000 Avery Brook 2/20/2020 1:15               4.15               4.94                     31.9              NA
##  7    1171000 Avery Brook 2/20/2020 1:30               4.13               4.56                     31.9              NA
##  8    1171000 Avery Brook 2/20/2020 1:45               4.1                4.14                     31.9              NA
##  9    1171000 Avery Brook 2/20/2020 2:00               4.08               3.84                     31.9              NA
## 10    1171000 Avery Brook 2/20/2020 2:15               4.09               4.02                     31.9              NA
## # â€¦ with 582,378 more rows, and 2 more variables: AirTemperature_HOBO_degF &lt;dbl&gt;, X &lt;lgl&gt;</code></pre>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="models.html#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dataFlow<span class="sc">$</span>Site_Name)</span></code></pre></div>
<pre><code>## 
##          Avery Brook          Jimmy Brook       Mitchell Brook    Obear Brook Lower      Sanderson Brook 
##                56536                57849                56978                60392                55336 
##         West Brook 0     West Brook Lower West Brook Reservoir     West Brook Upper   West Whately Brook 
##                58548                61279                61059                57301                57110</code></pre>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="models.html#cb129-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> dataFlow <span class="sc">%&gt;%</span></span>
<span id="cb129-2"><a href="models.html#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Site_Name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Jimmy Brook&quot;</span>, <span class="st">&quot;Mitchell Brook&quot;</span>, <span class="st">&quot;Obear Brook Lower&quot;</span>, <span class="st">&quot;West Brook 0&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb129-3"><a href="models.html#cb129-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">mdy_hm</span>(DateTime_EST),</span>
<span id="cb129-4"><a href="models.html#cb129-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">site =</span> <span class="fu">recode</span>(Site_Name, <span class="st">&quot;Jimmy Brook&quot;</span> <span class="ot">=</span> <span class="st">&quot;OL&quot;</span>, <span class="st">&quot;Mitchell Brook&quot;</span> <span class="ot">=</span> <span class="st">&quot;OS&quot;</span>, <span class="st">&quot;Obear Brook Lower&quot;</span> <span class="ot">=</span> <span class="st">&quot;IS&quot;</span>, <span class="st">&quot;West Brook 0&quot;</span> <span class="ot">=</span> <span class="st">&quot;WB&quot;</span>),</span>
<span id="cb129-5"><a href="models.html#cb129-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">dischargeLog =</span> <span class="fu">log</span>(Discharge_Hobo_cfs <span class="sc">+</span> <span class="fl">0.01</span>))</span>
<span id="cb129-6"><a href="models.html#cb129-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-7"><a href="models.html#cb129-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb129-8"><a href="models.html#cb129-8" aria-hidden="true" tabindex="-1"></a>d <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">is.infinite</span>(dischargeLog))</span></code></pre></div>
<pre><code>##  [1] Station_No                 Site_Name                  DateTime_EST               GageHeight_Hobo_ft        
##  [5] Discharge_Hobo_cfs         WaterTemperature_HOBO_DegF AirPressure_PSI            AirTemperature_HOBO_degF  
##  [9] X                          date                       site                       dischargeLog              
## &lt;0 rows&gt; (or 0-length row.names)</code></pre>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="models.html#cb131-1" aria-hidden="true" tabindex="-1"></a>scaleCol <span class="ot">&lt;-</span> <span class="cf">function</span>(d){</span>
<span id="cb131-2"><a href="models.html#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (d <span class="sc">-</span> <span class="fu">mean</span>(d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">/</span> <span class="fu">sd</span>(d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb131-3"><a href="models.html#cb131-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb131-4"><a href="models.html#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="co"># hard-coded for now</span></span>
<span id="cb131-5"><a href="models.html#cb131-5" aria-hidden="true" tabindex="-1"></a>dWide <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb131-6"><a href="models.html#cb131-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> date, </span>
<span id="cb131-7"><a href="models.html#cb131-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> dischargeLog, </span>
<span id="cb131-8"><a href="models.html#cb131-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_from =</span> site</span>
<span id="cb131-9"><a href="models.html#cb131-9" aria-hidden="true" tabindex="-1"></a>             ) <span class="sc">%&gt;%</span></span>
<span id="cb131-10"><a href="models.html#cb131-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb131-11"><a href="models.html#cb131-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">OLScaled =</span> <span class="fu">scaleCol</span>(OL),</span>
<span id="cb131-12"><a href="models.html#cb131-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">ISScaled =</span> <span class="fu">scaleCol</span>(IS),</span>
<span id="cb131-13"><a href="models.html#cb131-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">OSScaled =</span> <span class="fu">scaleCol</span>(OS),</span>
<span id="cb131-14"><a href="models.html#cb131-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">WBScaled =</span> <span class="fu">scaleCol</span>(WB),</span>
<span id="cb131-15"><a href="models.html#cb131-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">yday =</span> <span class="fu">yday</span>(date),</span>
<span id="cb131-16"><a href="models.html#cb131-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">year</span>(date)</span>
<span id="cb131-17"><a href="models.html#cb131-17" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="models.html#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d, <span class="fu">aes</span>(date, dischargeLog, <span class="at">color =</span> Site_Name)) <span class="sc">+</span></span>
<span id="cb132-2"><a href="models.html#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.02</span>) <span class="sc">+</span></span>
<span id="cb132-3"><a href="models.html#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Site_Name)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowPlots-1.png" width="672" /></p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="models.html#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(dWide,</span>
<span id="cb133-2"><a href="models.html#cb133-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">columns =</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">9</span>,</span>
<span id="cb133-3"><a href="models.html#cb133-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.factor</span>(year), <span class="at">alpha =</span> <span class="fl">0.7</span>),</span>
<span id="cb133-4"><a href="models.html#cb133-4" aria-hidden="true" tabindex="-1"></a>          <span class="co">#diag = list(continuous = myDens),</span></span>
<span id="cb133-5"><a href="models.html#cb133-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">lower =</span> <span class="fu">list</span>(<span class="at">continuous =</span> <span class="fu">wrap</span>(<span class="st">&quot;points&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size=</span><span class="fl">0.1</span>), </span>
<span id="cb133-6"><a href="models.html#cb133-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">combo =</span> <span class="fu">wrap</span>(<span class="st">&quot;dot&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size=</span><span class="fl">0.2</span>))</span>
<span id="cb133-7"><a href="models.html#cb133-7" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowPlots-2.png" width="672" /></p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="models.html#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(dWide <span class="sc">%&gt;%</span> <span class="fu">filter</span>(yday <span class="sc">&gt;</span> <span class="dv">90</span>, yday <span class="sc">&lt;</span> <span class="dv">300</span>),</span>
<span id="cb134-2"><a href="models.html#cb134-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">columns =</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">9</span>,</span>
<span id="cb134-3"><a href="models.html#cb134-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.factor</span>(year)),</span>
<span id="cb134-4"><a href="models.html#cb134-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">lower =</span> <span class="fu">list</span>(<span class="at">continuous =</span> <span class="fu">wrap</span>(<span class="st">&quot;points&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size=</span><span class="fl">0.1</span>), </span>
<span id="cb134-5"><a href="models.html#cb134-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">combo =</span> <span class="fu">wrap</span>(<span class="st">&quot;dot&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size=</span><span class="fl">0.2</span>))</span>
<span id="cb134-6"><a href="models.html#cb134-6" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowPlots-3.png" width="672" /></p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="models.html#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(dWide <span class="sc">%&gt;%</span> <span class="fu">filter</span>(yday <span class="sc">==</span> <span class="dv">110</span>),</span>
<span id="cb135-2"><a href="models.html#cb135-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">columns =</span> <span class="dv">8</span><span class="sc">:</span><span class="dv">11</span>,</span>
<span id="cb135-3"><a href="models.html#cb135-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.factor</span>(year)),</span>
<span id="cb135-4"><a href="models.html#cb135-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">lower =</span> <span class="fu">list</span>(<span class="at">continuous =</span> <span class="fu">wrap</span>(<span class="st">&quot;points&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size=</span><span class="fl">0.2</span>), </span>
<span id="cb135-5"><a href="models.html#cb135-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">combo =</span> <span class="fu">wrap</span>(<span class="st">&quot;dot&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size=</span><span class="fl">0.2</span>))</span>
<span id="cb135-6"><a href="models.html#cb135-6" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowPlots-4.png" width="672" /></p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="models.html#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co">#mod0 &lt;- lmer(OL ~ WB * yday + as.factor(year) + 1|yday, data = dWide)</span></span></code></pre></div>

</div>
<div id="modelCMR_Flow" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Flow effects on survival (phi) models<a href="models.html#modelCMR_Flow" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The goal of this modelling exercise is to evaluate the effect of new tributary-specific stream flow estimates on survival of brook trout and brown trout. We will compare survival across the WB and tributaries with flow input data as 1) single flow estimate for all locations (historical approach) and 2) hindcasted flows for each tributary based on new tributary-specific flows which are available since 2000.</p>
<p>The goal is to find the best structure for the survival model, then compare survival estimates with tributary-specific flow to estimates with common flow across locations.</p>
<p>Structure options include
[species, cohort, season, isYOY, flow, flow^2]</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="models.html#cb137-1" aria-hidden="true" tabindex="-1"></a>rerunSurivalModels <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb137-2"><a href="models.html#cb137-2" aria-hidden="true" tabindex="-1"></a>plotMCMCOutput <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="models.html#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowWB/dataOut/eh_2002200320042005200620072008200920102011201220132014_wb obear.RData&#39;</span>)</span></code></pre></div>
<div id="model-phi_p" class="section level3 hasAnchor" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> Model phi_p<a href="models.html#model-phi_p" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Single estimates of phi and p (across, time, cohorts, flow)
#### Set up and run model</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="models.html#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html</span></span>
<span id="cb139-2"><a href="models.html#cb139-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-3"><a href="models.html#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb139-4"><a href="models.html#cb139-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb139-5"><a href="models.html#cb139-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-6"><a href="models.html#cb139-6" aria-hidden="true" tabindex="-1"></a>  nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons))</span>
<span id="cb139-7"><a href="models.html#cb139-7" aria-hidden="true" tabindex="-1"></a>  nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts))</span>
<span id="cb139-8"><a href="models.html#cb139-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-9"><a href="models.html#cb139-9" aria-hidden="true" tabindex="-1"></a>  hmm.phi_p <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb139-10"><a href="models.html#cb139-10" aria-hidden="true" tabindex="-1"></a>    phi <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># prior survival</span></span>
<span id="cb139-11"><a href="models.html#cb139-11" aria-hidden="true" tabindex="-1"></a>    p <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># prior detection</span></span>
<span id="cb139-12"><a href="models.html#cb139-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood</span></span>
<span id="cb139-13"><a href="models.html#cb139-13" aria-hidden="true" tabindex="-1"></a>    gamma[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phi      <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb139-14"><a href="models.html#cb139-14" aria-hidden="true" tabindex="-1"></a>    gamma[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi  <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb139-15"><a href="models.html#cb139-15" aria-hidden="true" tabindex="-1"></a>    gamma[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>        <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb139-16"><a href="models.html#cb139-16" aria-hidden="true" tabindex="-1"></a>    gamma[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>        <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb139-17"><a href="models.html#cb139-17" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>          <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb139-18"><a href="models.html#cb139-18" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb139-19"><a href="models.html#cb139-19" aria-hidden="true" tabindex="-1"></a>    omega[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p    <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb139-20"><a href="models.html#cb139-20" aria-hidden="true" tabindex="-1"></a>    omega[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> p        <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb139-21"><a href="models.html#cb139-21" aria-hidden="true" tabindex="-1"></a>    omega[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>        <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb139-22"><a href="models.html#cb139-22" aria-hidden="true" tabindex="-1"></a>    omega[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>        <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb139-23"><a href="models.html#cb139-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-24"><a href="models.html#cb139-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb139-25"><a href="models.html#cb139-25" aria-hidden="true" tabindex="-1"></a>      z[i,first[i]] <span class="sc">~</span> <span class="fu">dcat</span>(delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb139-26"><a href="models.html#cb139-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>last[i]){</span>
<span id="cb139-27"><a href="models.html#cb139-27" aria-hidden="true" tabindex="-1"></a>        z[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(gamma[z[i,j<span class="dv">-1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb139-28"><a href="models.html#cb139-28" aria-hidden="true" tabindex="-1"></a>        y[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(omega[z[i,j], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb139-29"><a href="models.html#cb139-29" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb139-30"><a href="models.html#cb139-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb139-31"><a href="models.html#cb139-31" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb139-32"><a href="models.html#cb139-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-33"><a href="models.html#cb139-33" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb139-34"><a href="models.html#cb139-34" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb139-35"><a href="models.html#cb139-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-36"><a href="models.html#cb139-36" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb139-37"><a href="models.html#cb139-37" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb139-38"><a href="models.html#cb139-38" aria-hidden="true" tabindex="-1"></a>                       <span class="at">first =</span> first,</span>
<span id="cb139-39"><a href="models.html#cb139-39" aria-hidden="true" tabindex="-1"></a>                       <span class="at">last =</span> last)</span>
<span id="cb139-40"><a href="models.html#cb139-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-41"><a href="models.html#cb139-41" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb139-42"><a href="models.html#cb139-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-43"><a href="models.html#cb139-43" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb139-44"><a href="models.html#cb139-44" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb139-45"><a href="models.html#cb139-45" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(<span class="at">phi =</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb139-46"><a href="models.html#cb139-46" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">p =</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb139-47"><a href="models.html#cb139-47" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">z =</span> zinits</span>
<span id="cb139-48"><a href="models.html#cb139-48" aria-hidden="true" tabindex="-1"></a>                                    )</span>
<span id="cb139-49"><a href="models.html#cb139-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-50"><a href="models.html#cb139-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-51"><a href="models.html#cb139-51" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>, <span class="st">&quot;p&quot;</span>)  </span>
<span id="cb139-52"><a href="models.html#cb139-52" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb139-53"><a href="models.html#cb139-53" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb139-54"><a href="models.html#cb139-54" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb139-55"><a href="models.html#cb139-55" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb139-56"><a href="models.html#cb139-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-57"><a href="models.html#cb139-57" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb139-58"><a href="models.html#cb139-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-59"><a href="models.html#cb139-59" aria-hidden="true" tabindex="-1"></a>  Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb139-60"><a href="models.html#cb139-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> hmm.phi_p, </span>
<span id="cb139-61"><a href="models.html#cb139-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> myConstants,</span>
<span id="cb139-62"><a href="models.html#cb139-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> myData,              </span>
<span id="cb139-63"><a href="models.html#cb139-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb139-64"><a href="models.html#cb139-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb139-65"><a href="models.html#cb139-65" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb139-66"><a href="models.html#cb139-66" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb139-67"><a href="models.html#cb139-67" aria-hidden="true" tabindex="-1"></a>    Rmodel,</span>
<span id="cb139-68"><a href="models.html#cb139-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">monitors =</span> parametersToSave</span>
<span id="cb139-69"><a href="models.html#cb139-69" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb139-70"><a href="models.html#cb139-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-71"><a href="models.html#cb139-71" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb139-72"><a href="models.html#cb139-72" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb139-73"><a href="models.html#cb139-73" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb139-74"><a href="models.html#cb139-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-75"><a href="models.html#cb139-75" aria-hidden="true" tabindex="-1"></a>  mcmc.phi_p <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb139-76"><a href="models.html#cb139-76" aria-hidden="true" tabindex="-1"></a>    Cmcmc, </span>
<span id="cb139-77"><a href="models.html#cb139-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> nIter, </span>
<span id="cb139-78"><a href="models.html#cb139-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb139-79"><a href="models.html#cb139-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> thinRate, </span>
<span id="cb139-80"><a href="models.html#cb139-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nChains</span>
<span id="cb139-81"><a href="models.html#cb139-81" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb139-82"><a href="models.html#cb139-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-83"><a href="models.html#cb139-83" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb139-84"><a href="models.html#cb139-84" aria-hidden="true" tabindex="-1"></a>  elapsed_phi_p <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb139-85"><a href="models.html#cb139-85" aria-hidden="true" tabindex="-1"></a>  toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb139-86"><a href="models.html#cb139-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">mcmc =</span> mcmc.phi_p, </span>
<span id="cb139-87"><a href="models.html#cb139-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">elapsed =</span> elapsed_phi_p,</span>
<span id="cb139-88"><a href="models.html#cb139-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;phi_p&quot;</span>,</span>
<span id="cb139-89"><a href="models.html#cb139-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">myConstants =</span> myConstants, </span>
<span id="cb139-90"><a href="models.html#cb139-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">nIter =</span> nIter, </span>
<span id="cb139-91"><a href="models.html#cb139-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb139-92"><a href="models.html#cb139-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">thinRate =</span> thinRate, </span>
<span id="cb139-93"><a href="models.html#cb139-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb139-94"><a href="models.html#cb139-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb139-95"><a href="models.html#cb139-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">nChains =</span> nChains</span>
<span id="cb139-96"><a href="models.html#cb139-96" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb139-97"><a href="models.html#cb139-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phi_p_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb139-98"><a href="models.html#cb139-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phi_p_mostRecent.RData&#39;</span>)</span>
<span id="cb139-99"><a href="models.html#cb139-99" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb139-100"><a href="models.html#cb139-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phi_p_mostRecent.RData&#39;</span>)</span>
<span id="cb139-101"><a href="models.html#cb139-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb139-102"><a href="models.html#cb139-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-103"><a href="models.html#cb139-103" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) {</span>
<span id="cb139-104"><a href="models.html#cb139-104" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCsummary(object = mcmc.phi_p, round = 2)</span></span>
<span id="cb139-105"><a href="models.html#cb139-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc)</span>
<span id="cb139-106"><a href="models.html#cb139-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb139-107"><a href="models.html#cb139-107" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb139-108"><a href="models.html#cb139-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb139-109"><a href="models.html#cb139-109" aria-hidden="true" tabindex="-1"></a>            <span class="at">ISB =</span> <span class="cn">FALSE</span>,</span>
<span id="cb139-110"><a href="models.html#cb139-110" aria-hidden="true" tabindex="-1"></a>            <span class="at">exact =</span> <span class="cn">TRUE</span>, </span>
<span id="cb139-111"><a href="models.html#cb139-111" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>, <span class="st">&quot;p&quot;</span>),</span>
<span id="cb139-112"><a href="models.html#cb139-112" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb139-113"><a href="models.html#cb139-113" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb139-114"><a href="models.html#cb139-114" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phi_p-1.png" width="672" /><img src="westBrook-book_files/figure-html/phi_p-2.png" width="672" /></p>
</div>
<div id="model-phit_pt" class="section level3 hasAnchor" number="3.3.2">
<h3><span class="header-section-number">3.3.2</span> Model phiT_pT<a href="models.html#model-phit_pt" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Phi and p vary by sampling occasion (time)
#### Set up and run model</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="models.html#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html</span></span>
<span id="cb140-2"><a href="models.html#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb140-3"><a href="models.html#cb140-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-4"><a href="models.html#cb140-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb140-5"><a href="models.html#cb140-5" aria-hidden="true" tabindex="-1"></a>  nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons))</span>
<span id="cb140-6"><a href="models.html#cb140-6" aria-hidden="true" tabindex="-1"></a>  nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts))</span>
<span id="cb140-7"><a href="models.html#cb140-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-8"><a href="models.html#cb140-8" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb140-9"><a href="models.html#cb140-9" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>                    <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb140-10"><a href="models.html#cb140-10" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                    <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb140-11"><a href="models.html#cb140-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb140-12"><a href="models.html#cb140-12" aria-hidden="true" tabindex="-1"></a>      phi[t] <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)           <span class="co"># prior survival</span></span>
<span id="cb140-13"><a href="models.html#cb140-13" aria-hidden="true" tabindex="-1"></a>      gamma[<span class="dv">1</span>,<span class="dv">1</span>,t] <span class="ot">&lt;-</span> phi[t]         <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb140-14"><a href="models.html#cb140-14" aria-hidden="true" tabindex="-1"></a>      gamma[<span class="dv">1</span>,<span class="dv">2</span>,t] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi[t]     <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb140-15"><a href="models.html#cb140-15" aria-hidden="true" tabindex="-1"></a>      gamma[<span class="dv">2</span>,<span class="dv">1</span>,t] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb140-16"><a href="models.html#cb140-16" aria-hidden="true" tabindex="-1"></a>      gamma[<span class="dv">2</span>,<span class="dv">2</span>,t] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb140-17"><a href="models.html#cb140-17" aria-hidden="true" tabindex="-1"></a>      p[t] <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)             <span class="co"># prior detection</span></span>
<span id="cb140-18"><a href="models.html#cb140-18" aria-hidden="true" tabindex="-1"></a>      omega[<span class="dv">1</span>,<span class="dv">1</span>,t] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p[t]       <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb140-19"><a href="models.html#cb140-19" aria-hidden="true" tabindex="-1"></a>      omega[<span class="dv">1</span>,<span class="dv">2</span>,t] <span class="ot">&lt;-</span> p[t]           <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb140-20"><a href="models.html#cb140-20" aria-hidden="true" tabindex="-1"></a>      omega[<span class="dv">2</span>,<span class="dv">1</span>,t] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb140-21"><a href="models.html#cb140-21" aria-hidden="true" tabindex="-1"></a>      omega[<span class="dv">2</span>,<span class="dv">2</span>,t] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb140-22"><a href="models.html#cb140-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb140-23"><a href="models.html#cb140-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood</span></span>
<span id="cb140-24"><a href="models.html#cb140-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb140-25"><a href="models.html#cb140-25" aria-hidden="true" tabindex="-1"></a>      z[i,first[i]] <span class="sc">~</span> <span class="fu">dcat</span>(delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb140-26"><a href="models.html#cb140-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>last[i]){</span>
<span id="cb140-27"><a href="models.html#cb140-27" aria-hidden="true" tabindex="-1"></a>        z[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(gamma[z[i,j<span class="dv">-1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>])</span>
<span id="cb140-28"><a href="models.html#cb140-28" aria-hidden="true" tabindex="-1"></a>        y[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(omega[z[i,j], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>])</span>
<span id="cb140-29"><a href="models.html#cb140-29" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb140-30"><a href="models.html#cb140-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb140-31"><a href="models.html#cb140-31" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb140-32"><a href="models.html#cb140-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-33"><a href="models.html#cb140-33" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb140-34"><a href="models.html#cb140-34" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb140-35"><a href="models.html#cb140-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-36"><a href="models.html#cb140-36" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb140-37"><a href="models.html#cb140-37" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb140-38"><a href="models.html#cb140-38" aria-hidden="true" tabindex="-1"></a>                       <span class="at">first =</span> first,</span>
<span id="cb140-39"><a href="models.html#cb140-39" aria-hidden="true" tabindex="-1"></a>                       <span class="at">last =</span> last)</span>
<span id="cb140-40"><a href="models.html#cb140-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-41"><a href="models.html#cb140-41" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb140-42"><a href="models.html#cb140-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-43"><a href="models.html#cb140-43" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb140-44"><a href="models.html#cb140-44" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb140-45"><a href="models.html#cb140-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-46"><a href="models.html#cb140-46" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(<span class="at">phi =</span> <span class="fu">runif</span>(myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb140-47"><a href="models.html#cb140-47" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">p =</span> <span class="fu">runif</span>(myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb140-48"><a href="models.html#cb140-48" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">z =</span> zinits)</span>
<span id="cb140-49"><a href="models.html#cb140-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-50"><a href="models.html#cb140-50" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>, <span class="st">&quot;p&quot;</span>)  </span>
<span id="cb140-51"><a href="models.html#cb140-51" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb140-52"><a href="models.html#cb140-52" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb140-53"><a href="models.html#cb140-53" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb140-54"><a href="models.html#cb140-54" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb140-55"><a href="models.html#cb140-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-56"><a href="models.html#cb140-56" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb140-57"><a href="models.html#cb140-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-58"><a href="models.html#cb140-58" aria-hidden="true" tabindex="-1"></a>  Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb140-59"><a href="models.html#cb140-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> hmm.phiT_pT, </span>
<span id="cb140-60"><a href="models.html#cb140-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> myConstants,</span>
<span id="cb140-61"><a href="models.html#cb140-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> myData,              </span>
<span id="cb140-62"><a href="models.html#cb140-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb140-63"><a href="models.html#cb140-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb140-64"><a href="models.html#cb140-64" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb140-65"><a href="models.html#cb140-65" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb140-66"><a href="models.html#cb140-66" aria-hidden="true" tabindex="-1"></a>    Rmodel,</span>
<span id="cb140-67"><a href="models.html#cb140-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">monitors =</span> parametersToSave</span>
<span id="cb140-68"><a href="models.html#cb140-68" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb140-69"><a href="models.html#cb140-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-70"><a href="models.html#cb140-70" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb140-71"><a href="models.html#cb140-71" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb140-72"><a href="models.html#cb140-72" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb140-73"><a href="models.html#cb140-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-74"><a href="models.html#cb140-74" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb140-75"><a href="models.html#cb140-75" aria-hidden="true" tabindex="-1"></a>    Cmcmc, </span>
<span id="cb140-76"><a href="models.html#cb140-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> nIter, </span>
<span id="cb140-77"><a href="models.html#cb140-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb140-78"><a href="models.html#cb140-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> thinRate, </span>
<span id="cb140-79"><a href="models.html#cb140-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nChains</span>
<span id="cb140-80"><a href="models.html#cb140-80" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb140-81"><a href="models.html#cb140-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-82"><a href="models.html#cb140-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-83"><a href="models.html#cb140-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-84"><a href="models.html#cb140-84" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb140-85"><a href="models.html#cb140-85" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb140-86"><a href="models.html#cb140-86" aria-hidden="true" tabindex="-1"></a>    toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb140-87"><a href="models.html#cb140-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">mcmc =</span> mcmc.phiT_pT, </span>
<span id="cb140-88"><a href="models.html#cb140-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">elapsed =</span> elapsed_phiT_pT,</span>
<span id="cb140-89"><a href="models.html#cb140-89" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;phiT_pT&quot;</span>,</span>
<span id="cb140-90"><a href="models.html#cb140-90" aria-hidden="true" tabindex="-1"></a>      <span class="at">myConstants =</span> myConstants, </span>
<span id="cb140-91"><a href="models.html#cb140-91" aria-hidden="true" tabindex="-1"></a>      <span class="at">nIter =</span> nIter, </span>
<span id="cb140-92"><a href="models.html#cb140-92" aria-hidden="true" tabindex="-1"></a>      <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb140-93"><a href="models.html#cb140-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">thinRate =</span> thinRate, </span>
<span id="cb140-94"><a href="models.html#cb140-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb140-95"><a href="models.html#cb140-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb140-96"><a href="models.html#cb140-96" aria-hidden="true" tabindex="-1"></a>      <span class="at">nChains =</span> nChains</span>
<span id="cb140-97"><a href="models.html#cb140-97" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb140-98"><a href="models.html#cb140-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb140-99"><a href="models.html#cb140-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_mostRecent.RData&#39;</span>)</span>
<span id="cb140-100"><a href="models.html#cb140-100" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb140-101"><a href="models.html#cb140-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_mostRecent.RData&#39;</span>)</span>
<span id="cb140-102"><a href="models.html#cb140-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb140-103"><a href="models.html#cb140-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-104"><a href="models.html#cb140-104" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (plotMCMCOutput) {  </span>
<span id="cb140-105"><a href="models.html#cb140-105" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCsummary(object = mcmc.phiT_pT, round = 2)</span></span>
<span id="cb140-106"><a href="models.html#cb140-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc)</span>
<span id="cb140-107"><a href="models.html#cb140-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-108"><a href="models.html#cb140-108" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb140-109"><a href="models.html#cb140-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb140-110"><a href="models.html#cb140-110" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb140-111"><a href="models.html#cb140-111" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb140-112"><a href="models.html#cb140-112" aria-hidden="true" tabindex="-1"></a>            <span class="co">#params = c(&quot;phi[1]&quot;, &quot;phi[2]&quot;, &quot;phi[3]&quot;, &quot;phi[4]&quot;, &quot;phi[5]&quot;, &quot;phi[9]&quot;, &quot;phi[10]&quot;,</span></span>
<span id="cb140-113"><a href="models.html#cb140-113" aria-hidden="true" tabindex="-1"></a>            <span class="co">#           &quot;p[1]&quot;, &quot;p[2]&quot;, &quot;p[3]&quot;, &quot;p[4]&quot;, &quot;p[5]&quot;),</span></span>
<span id="cb140-114"><a href="models.html#cb140-114" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>),</span>
<span id="cb140-115"><a href="models.html#cb140-115" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb140-116"><a href="models.html#cb140-116" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb140-117"><a href="models.html#cb140-117" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT-5.png" width="672" /></p>
</div>
<div id="model-phit_pt_isyoy" class="section level3 hasAnchor" number="3.3.3">
<h3><span class="header-section-number">3.3.3</span> Model phiT_pT_isYOY<a href="models.html#model-phit_pt_isyoy" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Add structure for isYOY. This was important for the integrated growth/survival model, but probably not relevant here since we are estimating phi and p for each ageInSamples</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="models.html#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html</span></span>
<span id="cb141-2"><a href="models.html#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb141-3"><a href="models.html#cb141-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-4"><a href="models.html#cb141-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb141-5"><a href="models.html#cb141-5" aria-hidden="true" tabindex="-1"></a>  nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons))</span>
<span id="cb141-6"><a href="models.html#cb141-6" aria-hidden="true" tabindex="-1"></a>  nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts))</span>
<span id="cb141-7"><a href="models.html#cb141-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-8"><a href="models.html#cb141-8" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT_isYOY <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb141-9"><a href="models.html#cb141-9" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>                    <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb141-10"><a href="models.html#cb141-10" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                    <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb141-11"><a href="models.html#cb141-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-12"><a href="models.html#cb141-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb141-13"><a href="models.html#cb141-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb141-14"><a href="models.html#cb141-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">#logit(phi[t,i]) &lt;- betaPhi[t,isYOY[i,t]]           # prior survival</span></span>
<span id="cb141-15"><a href="models.html#cb141-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(phi[t,i]) <span class="ot">&lt;-</span> betaPhi[t]    <span class="co"># prior survival</span></span>
<span id="cb141-16"><a href="models.html#cb141-16" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> phi[t,i]       <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb141-17"><a href="models.html#cb141-17" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi[t,i]   <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb141-18"><a href="models.html#cb141-18" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb141-19"><a href="models.html#cb141-19" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb141-20"><a href="models.html#cb141-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-21"><a href="models.html#cb141-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(p[t,i]) <span class="ot">&lt;-</span> betaP[t]        <span class="co"># prior detection</span></span>
<span id="cb141-22"><a href="models.html#cb141-22" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p[t,i]     <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb141-23"><a href="models.html#cb141-23" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> p[t,i]         <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb141-24"><a href="models.html#cb141-24" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb141-25"><a href="models.html#cb141-25" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb141-26"><a href="models.html#cb141-26" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb141-27"><a href="models.html#cb141-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-28"><a href="models.html#cb141-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-29"><a href="models.html#cb141-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (y <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb141-30"><a href="models.html#cb141-30" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mean values</span></span>
<span id="cb141-31"><a href="models.html#cb141-31" aria-hidden="true" tabindex="-1"></a>      betaPhiIsYOY[y] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb141-32"><a href="models.html#cb141-32" aria-hidden="true" tabindex="-1"></a>      betaPIsYOY[y] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb141-33"><a href="models.html#cb141-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-34"><a href="models.html#cb141-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-35"><a href="models.html#cb141-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># isYOY = 1</span></span>
<span id="cb141-36"><a href="models.html#cb141-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>){ </span>
<span id="cb141-37"><a href="models.html#cb141-37" aria-hidden="true" tabindex="-1"></a>      betaPhi[t] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiIsYOY[<span class="dv">1</span>], <span class="dv">1</span>)</span>
<span id="cb141-38"><a href="models.html#cb141-38" aria-hidden="true" tabindex="-1"></a>      betaP[t] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPIsYOY[<span class="dv">1</span>], <span class="dv">1</span>)</span>
<span id="cb141-39"><a href="models.html#cb141-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-40"><a href="models.html#cb141-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># isYOY = 2, older fish</span></span>
<span id="cb141-41"><a href="models.html#cb141-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">4</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb141-42"><a href="models.html#cb141-42" aria-hidden="true" tabindex="-1"></a>      betaPhi[t] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiIsYOY[<span class="dv">2</span>], <span class="dv">1</span>)</span>
<span id="cb141-43"><a href="models.html#cb141-43" aria-hidden="true" tabindex="-1"></a>      betaP[t] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPIsYOY[<span class="dv">2</span>], <span class="dv">1</span>)</span>
<span id="cb141-44"><a href="models.html#cb141-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-45"><a href="models.html#cb141-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-46"><a href="models.html#cb141-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Backtransform for output</span></span>
<span id="cb141-47"><a href="models.html#cb141-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (y <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb141-48"><a href="models.html#cb141-48" aria-hidden="true" tabindex="-1"></a>        betaPhiIsYOYOut[y] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhiIsYOY[y]))</span>
<span id="cb141-49"><a href="models.html#cb141-49" aria-hidden="true" tabindex="-1"></a>        betaPIsYOYOut[y] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPIsYOY[y]))</span>
<span id="cb141-50"><a href="models.html#cb141-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-51"><a href="models.html#cb141-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb141-52"><a href="models.html#cb141-52" aria-hidden="true" tabindex="-1"></a>      betaPhiOut[t] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhi[t]))</span>
<span id="cb141-53"><a href="models.html#cb141-53" aria-hidden="true" tabindex="-1"></a>      betaPOut[t] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaP[t])) </span>
<span id="cb141-54"><a href="models.html#cb141-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-55"><a href="models.html#cb141-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-56"><a href="models.html#cb141-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-57"><a href="models.html#cb141-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood</span></span>
<span id="cb141-58"><a href="models.html#cb141-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb141-59"><a href="models.html#cb141-59" aria-hidden="true" tabindex="-1"></a>      z[i,first[i]] <span class="sc">~</span> <span class="fu">dcat</span>(delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb141-60"><a href="models.html#cb141-60" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>last[i]){</span>
<span id="cb141-61"><a href="models.html#cb141-61" aria-hidden="true" tabindex="-1"></a>        z[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(gamma[z[i,j<span class="dv">-1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb141-62"><a href="models.html#cb141-62" aria-hidden="true" tabindex="-1"></a>        y[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(omega[z[i,j], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb141-63"><a href="models.html#cb141-63" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb141-64"><a href="models.html#cb141-64" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-65"><a href="models.html#cb141-65" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb141-66"><a href="models.html#cb141-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-67"><a href="models.html#cb141-67" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb141-68"><a href="models.html#cb141-68" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb141-69"><a href="models.html#cb141-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-70"><a href="models.html#cb141-70" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y),</span>
<span id="cb141-71"><a href="models.html#cb141-71" aria-hidden="true" tabindex="-1"></a>                      <span class="at">T =</span> <span class="fu">ncol</span>(y),</span>
<span id="cb141-72"><a href="models.html#cb141-72" aria-hidden="true" tabindex="-1"></a>                      <span class="at">first =</span> first,</span>
<span id="cb141-73"><a href="models.html#cb141-73" aria-hidden="true" tabindex="-1"></a>                      <span class="at">last =</span> last,</span>
<span id="cb141-74"><a href="models.html#cb141-74" aria-hidden="true" tabindex="-1"></a>                      <span class="at">isYOY =</span> eh<span class="sc">$</span>isYOY</span>
<span id="cb141-75"><a href="models.html#cb141-75" aria-hidden="true" tabindex="-1"></a>                      )</span>
<span id="cb141-76"><a href="models.html#cb141-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-77"><a href="models.html#cb141-77" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb141-78"><a href="models.html#cb141-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-79"><a href="models.html#cb141-79" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb141-80"><a href="models.html#cb141-80" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb141-81"><a href="models.html#cb141-81" aria-hidden="true" tabindex="-1"></a>  zInitsNA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(eh<span class="sc">$</span>isYOY), <span class="cn">NA</span>, <span class="dv">1</span>)</span>
<span id="cb141-82"><a href="models.html#cb141-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-83"><a href="models.html#cb141-83" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(</span>
<span id="cb141-84"><a href="models.html#cb141-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb141-85"><a href="models.html#cb141-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb141-86"><a href="models.html#cb141-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">z =</span> zInitsNA,</span>
<span id="cb141-87"><a href="models.html#cb141-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>))),</span>
<span id="cb141-88"><a href="models.html#cb141-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaP =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>))),</span>
<span id="cb141-89"><a href="models.html#cb141-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhiIsYOY =</span> <span class="fu">array</span>(<span class="fu">runif</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(<span class="dv">2</span>)),</span>
<span id="cb141-90"><a href="models.html#cb141-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPIsYOY =</span> <span class="fu">array</span>(<span class="fu">runif</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(<span class="dv">2</span>))</span>
<span id="cb141-91"><a href="models.html#cb141-91" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-92"><a href="models.html#cb141-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-93"><a href="models.html#cb141-93" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiOut&quot;</span>, <span class="st">&quot;betaPOut&quot;</span>, <span class="st">&quot;betaPIsYOYOut&quot;</span>, <span class="st">&quot;betaPhiIsYOYOut&quot;</span>)</span>
<span id="cb141-94"><a href="models.html#cb141-94" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb141-95"><a href="models.html#cb141-95" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb141-96"><a href="models.html#cb141-96" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb141-97"><a href="models.html#cb141-97" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb141-98"><a href="models.html#cb141-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-99"><a href="models.html#cb141-99" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb141-100"><a href="models.html#cb141-100" aria-hidden="true" tabindex="-1"></a>  Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb141-101"><a href="models.html#cb141-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> hmm.phiT_pT_isYOY,</span>
<span id="cb141-102"><a href="models.html#cb141-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> myConstants,</span>
<span id="cb141-103"><a href="models.html#cb141-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> myData,</span>
<span id="cb141-104"><a href="models.html#cb141-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb141-105"><a href="models.html#cb141-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb141-106"><a href="models.html#cb141-106" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-107"><a href="models.html#cb141-107" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb141-108"><a href="models.html#cb141-108" aria-hidden="true" tabindex="-1"></a>    Rmodel,</span>
<span id="cb141-109"><a href="models.html#cb141-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">monitors =</span> parametersToSave</span>
<span id="cb141-110"><a href="models.html#cb141-110" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-111"><a href="models.html#cb141-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-112"><a href="models.html#cb141-112" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb141-113"><a href="models.html#cb141-113" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb141-114"><a href="models.html#cb141-114" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb141-115"><a href="models.html#cb141-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-116"><a href="models.html#cb141-116" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT_isYOY <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb141-117"><a href="models.html#cb141-117" aria-hidden="true" tabindex="-1"></a>    Cmcmc,</span>
<span id="cb141-118"><a href="models.html#cb141-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> nIter,</span>
<span id="cb141-119"><a href="models.html#cb141-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nBurnin,</span>
<span id="cb141-120"><a href="models.html#cb141-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> thinRate,</span>
<span id="cb141-121"><a href="models.html#cb141-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nChains</span>
<span id="cb141-122"><a href="models.html#cb141-122" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb141-123"><a href="models.html#cb141-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-124"><a href="models.html#cb141-124" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb141-125"><a href="models.html#cb141-125" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT_isYOY <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb141-126"><a href="models.html#cb141-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-127"><a href="models.html#cb141-127" aria-hidden="true" tabindex="-1"></a>    toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb141-128"><a href="models.html#cb141-128" aria-hidden="true" tabindex="-1"></a>      <span class="at">mcmc =</span> mcmc.phiT_pT_isYOY,</span>
<span id="cb141-129"><a href="models.html#cb141-129" aria-hidden="true" tabindex="-1"></a>      <span class="at">elapsed =</span> elapsed_phiT_pT_isYOY,</span>
<span id="cb141-130"><a href="models.html#cb141-130" aria-hidden="true" tabindex="-1"></a>      <span class="at">myConstants =</span> myConstants,</span>
<span id="cb141-131"><a href="models.html#cb141-131" aria-hidden="true" tabindex="-1"></a>      <span class="at">nIter =</span> nIter,</span>
<span id="cb141-132"><a href="models.html#cb141-132" aria-hidden="true" tabindex="-1"></a>      <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb141-133"><a href="models.html#cb141-133" aria-hidden="true" tabindex="-1"></a>      <span class="at">thinRate =</span> thinRate,</span>
<span id="cb141-134"><a href="models.html#cb141-134" aria-hidden="true" tabindex="-1"></a>      <span class="at">nSeasons =</span> nSeasons,</span>
<span id="cb141-135"><a href="models.html#cb141-135" aria-hidden="true" tabindex="-1"></a>      <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb141-136"><a href="models.html#cb141-136" aria-hidden="true" tabindex="-1"></a>      <span class="at">nChains =</span> nChains</span>
<span id="cb141-137"><a href="models.html#cb141-137" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb141-138"><a href="models.html#cb141-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_isYOY_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb141-139"><a href="models.html#cb141-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_isYOY_mostRecent.RData&#39;</span>)</span>
<span id="cb141-140"><a href="models.html#cb141-140" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb141-141"><a href="models.html#cb141-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_isYOY_mostRecent.RData&#39;</span>)</span>
<span id="cb141-142"><a href="models.html#cb141-142" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb141-143"><a href="models.html#cb141-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-144"><a href="models.html#cb141-144" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) {</span>
<span id="cb141-145"><a href="models.html#cb141-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCsummary</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">round =</span> <span class="dv">2</span>)</span>
<span id="cb141-146"><a href="models.html#cb141-146" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-147"><a href="models.html#cb141-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaPhiIsYOYOut&quot;</span>)</span>
<span id="cb141-148"><a href="models.html#cb141-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaPhiOut&quot;</span>)</span>
<span id="cb141-149"><a href="models.html#cb141-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaPOut&quot;</span>)<span class="co">#</span></span>
<span id="cb141-150"><a href="models.html#cb141-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-151"><a href="models.html#cb141-151" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span>  <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb141-152"><a href="models.html#cb141-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb141-153"><a href="models.html#cb141-153" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb141-154"><a href="models.html#cb141-154" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE,</span></span>
<span id="cb141-155"><a href="models.html#cb141-155" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiOut&quot;</span>),</span>
<span id="cb141-156"><a href="models.html#cb141-156" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>,</span>
<span id="cb141-157"><a href="models.html#cb141-157" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb141-158"><a href="models.html#cb141-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-159"><a href="models.html#cb141-159" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT_cohortisYOY-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohortisYOY-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohortisYOY-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohortisYOY-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohortisYOY-5.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohortisYOY-6.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohortisYOY-7.png" width="672" /></p>
</div>
<div id="model-phit_pt_cohort" class="section level3 hasAnchor" number="3.3.4">
<h3><span class="header-section-number">3.3.4</span> Model phiT_pT_cohort<a href="models.html#model-phit_pt_cohort" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Phi and p vary by time and there is a cohort effect on phi
#### Set up and run model</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="models.html#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html</span></span>
<span id="cb142-2"><a href="models.html#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb142-3"><a href="models.html#cb142-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-4"><a href="models.html#cb142-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb142-5"><a href="models.html#cb142-5" aria-hidden="true" tabindex="-1"></a>  nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts))</span>
<span id="cb142-6"><a href="models.html#cb142-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-7"><a href="models.html#cb142-7" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT_cohort <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb142-8"><a href="models.html#cb142-8" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>                    <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb142-9"><a href="models.html#cb142-9" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                    <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb142-10"><a href="models.html#cb142-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-11"><a href="models.html#cb142-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb142-12"><a href="models.html#cb142-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb142-13"><a href="models.html#cb142-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(phi[t,i]) <span class="ot">&lt;-</span> betaPhi[t,cohort[i]]           <span class="co"># prior survival</span></span>
<span id="cb142-14"><a href="models.html#cb142-14" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> phi[t,i]         <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb142-15"><a href="models.html#cb142-15" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi[t,i]     <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb142-16"><a href="models.html#cb142-16" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb142-17"><a href="models.html#cb142-17" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb142-18"><a href="models.html#cb142-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb142-19"><a href="models.html#cb142-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(p[t,i]) <span class="ot">&lt;-</span> betaP[t,cohort[i]]             <span class="co"># prior detection</span></span>
<span id="cb142-20"><a href="models.html#cb142-20" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p[t,i]       <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb142-21"><a href="models.html#cb142-21" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> p[t,i]           <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb142-22"><a href="models.html#cb142-22" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb142-23"><a href="models.html#cb142-23" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb142-24"><a href="models.html#cb142-24" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb142-25"><a href="models.html#cb142-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb142-26"><a href="models.html#cb142-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-27"><a href="models.html#cb142-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-28"><a href="models.html#cb142-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb142-29"><a href="models.html#cb142-29" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mean values</span></span>
<span id="cb142-30"><a href="models.html#cb142-30" aria-hidden="true" tabindex="-1"></a>      betaPhiCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb142-31"><a href="models.html#cb142-31" aria-hidden="true" tabindex="-1"></a>      betaPCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb142-32"><a href="models.html#cb142-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb142-33"><a href="models.html#cb142-33" aria-hidden="true" tabindex="-1"></a>        betaPhi[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiCohort[c], <span class="dv">1</span>)</span>
<span id="cb142-34"><a href="models.html#cb142-34" aria-hidden="true" tabindex="-1"></a>        betaP[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPCohort[c], <span class="dv">1</span>)</span>
<span id="cb142-35"><a href="models.html#cb142-35" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb142-36"><a href="models.html#cb142-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb142-37"><a href="models.html#cb142-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-38"><a href="models.html#cb142-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># back-transform for examining output</span></span>
<span id="cb142-39"><a href="models.html#cb142-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb142-40"><a href="models.html#cb142-40" aria-hidden="true" tabindex="-1"></a>        betaPhiCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhiCohort[c]))</span>
<span id="cb142-41"><a href="models.html#cb142-41" aria-hidden="true" tabindex="-1"></a>        betaPCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPCohort[c]))</span>
<span id="cb142-42"><a href="models.html#cb142-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb142-43"><a href="models.html#cb142-43" aria-hidden="true" tabindex="-1"></a>        betaPhiOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhi[t,c]))</span>
<span id="cb142-44"><a href="models.html#cb142-44" aria-hidden="true" tabindex="-1"></a>        betaPOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaP[t,c])) </span>
<span id="cb142-45"><a href="models.html#cb142-45" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb142-46"><a href="models.html#cb142-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb142-47"><a href="models.html#cb142-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-48"><a href="models.html#cb142-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood</span></span>
<span id="cb142-49"><a href="models.html#cb142-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb142-50"><a href="models.html#cb142-50" aria-hidden="true" tabindex="-1"></a>      z[i,first[i]] <span class="sc">~</span> <span class="fu">dcat</span>(delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb142-51"><a href="models.html#cb142-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>last[i]){</span>
<span id="cb142-52"><a href="models.html#cb142-52" aria-hidden="true" tabindex="-1"></a>        z[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(gamma[z[i,j<span class="dv">-1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb142-53"><a href="models.html#cb142-53" aria-hidden="true" tabindex="-1"></a>        y[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(omega[z[i,j], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb142-54"><a href="models.html#cb142-54" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb142-55"><a href="models.html#cb142-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb142-56"><a href="models.html#cb142-56" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb142-57"><a href="models.html#cb142-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-58"><a href="models.html#cb142-58" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb142-59"><a href="models.html#cb142-59" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb142-60"><a href="models.html#cb142-60" aria-hidden="true" tabindex="-1"></a>  cohort <span class="ot">=</span> ((eh<span class="sc">$</span>cohorts) <span class="sc">-</span> <span class="fu">min</span>(eh<span class="sc">$</span>cohorts) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">$</span>cohort <span class="co">#can&#39;t be a data frame or tibble</span></span>
<span id="cb142-61"><a href="models.html#cb142-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-62"><a href="models.html#cb142-62" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb142-63"><a href="models.html#cb142-63" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb142-64"><a href="models.html#cb142-64" aria-hidden="true" tabindex="-1"></a>                       <span class="at">first =</span> first,</span>
<span id="cb142-65"><a href="models.html#cb142-65" aria-hidden="true" tabindex="-1"></a>                       <span class="at">last =</span> last,</span>
<span id="cb142-66"><a href="models.html#cb142-66" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cohort =</span> cohort, </span>
<span id="cb142-67"><a href="models.html#cb142-67" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nCohorts =</span> nCohorts</span>
<span id="cb142-68"><a href="models.html#cb142-68" aria-hidden="true" tabindex="-1"></a>                       )</span>
<span id="cb142-69"><a href="models.html#cb142-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-70"><a href="models.html#cb142-70" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb142-71"><a href="models.html#cb142-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-72"><a href="models.html#cb142-72" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb142-73"><a href="models.html#cb142-73" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb142-74"><a href="models.html#cb142-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-75"><a href="models.html#cb142-75" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(</span>
<span id="cb142-76"><a href="models.html#cb142-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb142-77"><a href="models.html#cb142-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb142-78"><a href="models.html#cb142-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">z =</span> zinits,</span>
<span id="cb142-79"><a href="models.html#cb142-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb142-80"><a href="models.html#cb142-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaP =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb142-81"><a href="models.html#cb142-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhiCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb142-82"><a href="models.html#cb142-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts))</span>
<span id="cb142-83"><a href="models.html#cb142-83" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb142-84"><a href="models.html#cb142-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-85"><a href="models.html#cb142-85" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiOut&quot;</span>, <span class="st">&quot;betaPOut&quot;</span>, <span class="st">&quot;betaPhiCohortOut&quot;</span>, <span class="st">&quot;betaPCohortOut&quot;</span>)  </span>
<span id="cb142-86"><a href="models.html#cb142-86" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb142-87"><a href="models.html#cb142-87" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb142-88"><a href="models.html#cb142-88" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb142-89"><a href="models.html#cb142-89" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb142-90"><a href="models.html#cb142-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-91"><a href="models.html#cb142-91" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb142-92"><a href="models.html#cb142-92" aria-hidden="true" tabindex="-1"></a>  Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb142-93"><a href="models.html#cb142-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> hmm.phiT_pT_cohort, </span>
<span id="cb142-94"><a href="models.html#cb142-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> myConstants,</span>
<span id="cb142-95"><a href="models.html#cb142-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> myData,              </span>
<span id="cb142-96"><a href="models.html#cb142-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb142-97"><a href="models.html#cb142-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb142-98"><a href="models.html#cb142-98" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb142-99"><a href="models.html#cb142-99" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb142-100"><a href="models.html#cb142-100" aria-hidden="true" tabindex="-1"></a>    Rmodel,</span>
<span id="cb142-101"><a href="models.html#cb142-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">monitors =</span> parametersToSave</span>
<span id="cb142-102"><a href="models.html#cb142-102" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb142-103"><a href="models.html#cb142-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-104"><a href="models.html#cb142-104" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb142-105"><a href="models.html#cb142-105" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb142-106"><a href="models.html#cb142-106" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb142-107"><a href="models.html#cb142-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-108"><a href="models.html#cb142-108" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT_cohort <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb142-109"><a href="models.html#cb142-109" aria-hidden="true" tabindex="-1"></a>    Cmcmc, </span>
<span id="cb142-110"><a href="models.html#cb142-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> nIter, </span>
<span id="cb142-111"><a href="models.html#cb142-111" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb142-112"><a href="models.html#cb142-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> thinRate, </span>
<span id="cb142-113"><a href="models.html#cb142-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nChains</span>
<span id="cb142-114"><a href="models.html#cb142-114" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb142-115"><a href="models.html#cb142-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-116"><a href="models.html#cb142-116" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb142-117"><a href="models.html#cb142-117" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT_cohort <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb142-118"><a href="models.html#cb142-118" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-119"><a href="models.html#cb142-119" aria-hidden="true" tabindex="-1"></a>  toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb142-120"><a href="models.html#cb142-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">mcmc =</span> mcmc.phiT_pT_cohort, </span>
<span id="cb142-121"><a href="models.html#cb142-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">elapsed =</span> elapsed_phiT_pT_cohort,</span>
<span id="cb142-122"><a href="models.html#cb142-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;phiT_pT_cohort&quot;</span>,</span>
<span id="cb142-123"><a href="models.html#cb142-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">myConstants =</span> myConstants, </span>
<span id="cb142-124"><a href="models.html#cb142-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">nIter =</span> nIter, </span>
<span id="cb142-125"><a href="models.html#cb142-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb142-126"><a href="models.html#cb142-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">thinRate =</span> thinRate, </span>
<span id="cb142-127"><a href="models.html#cb142-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb142-128"><a href="models.html#cb142-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb142-129"><a href="models.html#cb142-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">nChains =</span> nChains</span>
<span id="cb142-130"><a href="models.html#cb142-130" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb142-131"><a href="models.html#cb142-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-132"><a href="models.html#cb142-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb142-133"><a href="models.html#cb142-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_mostRecent.RData&#39;</span>)</span>
<span id="cb142-134"><a href="models.html#cb142-134" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb142-135"><a href="models.html#cb142-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_mostRecent.RData&#39;</span>)</span>
<span id="cb142-136"><a href="models.html#cb142-136" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb142-137"><a href="models.html#cb142-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-138"><a href="models.html#cb142-138" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) { </span>
<span id="cb142-139"><a href="models.html#cb142-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-140"><a href="models.html#cb142-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiOut&quot;</span>))</span>
<span id="cb142-141"><a href="models.html#cb142-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>))</span>
<span id="cb142-142"><a href="models.html#cb142-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPCohortOut&quot;</span>))</span>
<span id="cb142-143"><a href="models.html#cb142-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb142-144"><a href="models.html#cb142-144" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb142-145"><a href="models.html#cb142-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb142-146"><a href="models.html#cb142-146" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb142-147"><a href="models.html#cb142-147" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb142-148"><a href="models.html#cb142-148" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>, <span class="st">&quot;betaPCohortOut&quot;</span>),</span>
<span id="cb142-149"><a href="models.html#cb142-149" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb142-150"><a href="models.html#cb142-150" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb142-151"><a href="models.html#cb142-151" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT_cohort-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-5.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-6.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-7.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-8.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-9.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-10.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-11.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-12.png" width="672" /></p>
<div id="plot-phi-against-flow-data-phit_pt_cohort" class="section level4 hasAnchor" number="3.3.4.1">
<h4><span class="header-section-number">3.3.4.1</span> Plot phi against flow data phiT_pT_cohort<a href="models.html#plot-phi-against-flow-data-phit_pt_cohort" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="models.html#cb143-1" aria-hidden="true" tabindex="-1"></a>phiOut <span class="ot">&lt;-</span> <span class="fu">MCMCsummary</span>(toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&#39;betaPhiOut&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="model-phit_pt_cohort_flow" class="section level3 hasAnchor" number="3.3.5">
<h3><span class="header-section-number">3.3.5</span> Model phiT_pT_cohort_flow<a href="models.html#model-phit_pt_cohort_flow" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Add mean flow over the interval as a survival effect
#### Set up and run model</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="models.html#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html</span></span>
<span id="cb144-2"><a href="models.html#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb144-3"><a href="models.html#cb144-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-4"><a href="models.html#cb144-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb144-5"><a href="models.html#cb144-5" aria-hidden="true" tabindex="-1"></a>  nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts))</span>
<span id="cb144-6"><a href="models.html#cb144-6" aria-hidden="true" tabindex="-1"></a>  nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons))</span>
<span id="cb144-7"><a href="models.html#cb144-7" aria-hidden="true" tabindex="-1"></a>  seasonArray <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb144-8"><a href="models.html#cb144-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-9"><a href="models.html#cb144-9" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT_cohort_flow <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb144-10"><a href="models.html#cb144-10" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>                    <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb144-11"><a href="models.html#cb144-11" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                    <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb144-12"><a href="models.html#cb144-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-13"><a href="models.html#cb144-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb144-14"><a href="models.html#cb144-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb144-15"><a href="models.html#cb144-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(phi[t,i]) <span class="ot">&lt;-</span> </span>
<span id="cb144-16"><a href="models.html#cb144-16" aria-hidden="true" tabindex="-1"></a>          betaInt <span class="sc">+</span></span>
<span id="cb144-17"><a href="models.html#cb144-17" aria-hidden="true" tabindex="-1"></a>          betaPhi[t,cohort[i]] <span class="sc">+</span> </span>
<span id="cb144-18"><a href="models.html#cb144-18" aria-hidden="true" tabindex="-1"></a>          betaFlow[<span class="dv">1</span>,season[t]] <span class="sc">*</span> flow[i,t] <span class="sc">+</span></span>
<span id="cb144-19"><a href="models.html#cb144-19" aria-hidden="true" tabindex="-1"></a>          betaFlow[<span class="dv">2</span>,season[t]] <span class="sc">*</span> flow[i,t] <span class="sc">*</span> flow[i,t]</span>
<span id="cb144-20"><a href="models.html#cb144-20" aria-hidden="true" tabindex="-1"></a>           <span class="co"># prior survival</span></span>
<span id="cb144-21"><a href="models.html#cb144-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb144-22"><a href="models.html#cb144-22" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> phi[t,i]         <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb144-23"><a href="models.html#cb144-23" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi[t,i]     <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb144-24"><a href="models.html#cb144-24" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb144-25"><a href="models.html#cb144-25" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb144-26"><a href="models.html#cb144-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb144-27"><a href="models.html#cb144-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(p[t,i]) <span class="ot">&lt;-</span> betaP[t,cohort[i]]             <span class="co"># prior detection</span></span>
<span id="cb144-28"><a href="models.html#cb144-28" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p[t,i]       <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb144-29"><a href="models.html#cb144-29" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> p[t,i]           <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb144-30"><a href="models.html#cb144-30" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb144-31"><a href="models.html#cb144-31" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb144-32"><a href="models.html#cb144-32" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb144-33"><a href="models.html#cb144-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb144-34"><a href="models.html#cb144-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-35"><a href="models.html#cb144-35" aria-hidden="true" tabindex="-1"></a>    betaInt <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb144-36"><a href="models.html#cb144-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-37"><a href="models.html#cb144-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb144-38"><a href="models.html#cb144-38" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mean values</span></span>
<span id="cb144-39"><a href="models.html#cb144-39" aria-hidden="true" tabindex="-1"></a>      betaPhiCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb144-40"><a href="models.html#cb144-40" aria-hidden="true" tabindex="-1"></a>      betaPCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb144-41"><a href="models.html#cb144-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb144-42"><a href="models.html#cb144-42" aria-hidden="true" tabindex="-1"></a>        betaPhi[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiCohort[c], <span class="dv">1</span>)</span>
<span id="cb144-43"><a href="models.html#cb144-43" aria-hidden="true" tabindex="-1"></a>        betaP[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPCohort[c], <span class="dv">1</span>)</span>
<span id="cb144-44"><a href="models.html#cb144-44" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb144-45"><a href="models.html#cb144-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb144-46"><a href="models.html#cb144-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-47"><a href="models.html#cb144-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># back-transform for examining output</span></span>
<span id="cb144-48"><a href="models.html#cb144-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb144-49"><a href="models.html#cb144-49" aria-hidden="true" tabindex="-1"></a>        betaPhiCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhiCohort[c]))</span>
<span id="cb144-50"><a href="models.html#cb144-50" aria-hidden="true" tabindex="-1"></a>        betaPCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPCohort[c]))</span>
<span id="cb144-51"><a href="models.html#cb144-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb144-52"><a href="models.html#cb144-52" aria-hidden="true" tabindex="-1"></a>        betaPhiOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhi[t,c]))</span>
<span id="cb144-53"><a href="models.html#cb144-53" aria-hidden="true" tabindex="-1"></a>        betaPOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaP[t,c])) </span>
<span id="cb144-54"><a href="models.html#cb144-54" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb144-55"><a href="models.html#cb144-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb144-56"><a href="models.html#cb144-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-57"><a href="models.html#cb144-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nSeasons){</span>
<span id="cb144-58"><a href="models.html#cb144-58" aria-hidden="true" tabindex="-1"></a>      betaFlow[<span class="dv">1</span>,s] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb144-59"><a href="models.html#cb144-59" aria-hidden="true" tabindex="-1"></a>      betaFlow[<span class="dv">2</span>,s] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb144-60"><a href="models.html#cb144-60" aria-hidden="true" tabindex="-1"></a>    }    </span>
<span id="cb144-61"><a href="models.html#cb144-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-62"><a href="models.html#cb144-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood</span></span>
<span id="cb144-63"><a href="models.html#cb144-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb144-64"><a href="models.html#cb144-64" aria-hidden="true" tabindex="-1"></a>      z[i,first[i]] <span class="sc">~</span> <span class="fu">dcat</span>(delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb144-65"><a href="models.html#cb144-65" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(last[i])){</span>
<span id="cb144-66"><a href="models.html#cb144-66" aria-hidden="true" tabindex="-1"></a>        z[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(gamma[z[i,j<span class="dv">-1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb144-67"><a href="models.html#cb144-67" aria-hidden="true" tabindex="-1"></a>        y[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(omega[z[i,j], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb144-68"><a href="models.html#cb144-68" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb144-69"><a href="models.html#cb144-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb144-70"><a href="models.html#cb144-70" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb144-71"><a href="models.html#cb144-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-72"><a href="models.html#cb144-72" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb144-73"><a href="models.html#cb144-73" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb144-74"><a href="models.html#cb144-74" aria-hidden="true" tabindex="-1"></a>  cohort <span class="ot">=</span> ((eh<span class="sc">$</span>cohorts) <span class="sc">-</span> <span class="fu">min</span>(eh<span class="sc">$</span>cohorts) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">$</span>cohort <span class="co">#can&#39;t be a data frame or tibble</span></span>
<span id="cb144-75"><a href="models.html#cb144-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-76"><a href="models.html#cb144-76" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb144-77"><a href="models.html#cb144-77" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb144-78"><a href="models.html#cb144-78" aria-hidden="true" tabindex="-1"></a>                       <span class="at">first =</span> first,</span>
<span id="cb144-79"><a href="models.html#cb144-79" aria-hidden="true" tabindex="-1"></a>                       <span class="at">last =</span> last,</span>
<span id="cb144-80"><a href="models.html#cb144-80" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cohort =</span> cohort, </span>
<span id="cb144-81"><a href="models.html#cb144-81" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb144-82"><a href="models.html#cb144-82" aria-hidden="true" tabindex="-1"></a>                       <span class="at">season =</span> seasonArray, <span class="co">#eh$seasons$season,</span></span>
<span id="cb144-83"><a href="models.html#cb144-83" aria-hidden="true" tabindex="-1"></a>                       <span class="at">flow =</span> eh<span class="sc">$</span>flow</span>
<span id="cb144-84"><a href="models.html#cb144-84" aria-hidden="true" tabindex="-1"></a>                       )</span>
<span id="cb144-85"><a href="models.html#cb144-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-86"><a href="models.html#cb144-86" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb144-87"><a href="models.html#cb144-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-88"><a href="models.html#cb144-88" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb144-89"><a href="models.html#cb144-89" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb144-90"><a href="models.html#cb144-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-91"><a href="models.html#cb144-91" aria-hidden="true" tabindex="-1"></a>  zInitsNA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(eh<span class="sc">$</span>flow), <span class="cn">NA</span>, <span class="dv">1</span>)</span>
<span id="cb144-92"><a href="models.html#cb144-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-93"><a href="models.html#cb144-93" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(</span>
<span id="cb144-94"><a href="models.html#cb144-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaInt =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb144-95"><a href="models.html#cb144-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb144-96"><a href="models.html#cb144-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb144-97"><a href="models.html#cb144-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">z =</span> zInitsNA,</span>
<span id="cb144-98"><a href="models.html#cb144-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb144-99"><a href="models.html#cb144-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaP =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb144-100"><a href="models.html#cb144-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhiCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb144-101"><a href="models.html#cb144-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPCohort =</span>   <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb144-102"><a href="models.html#cb144-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaFlow =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>))</span>
<span id="cb144-103"><a href="models.html#cb144-103" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb144-104"><a href="models.html#cb144-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-105"><a href="models.html#cb144-105" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;betaInt&quot;</span>, </span>
<span id="cb144-106"><a href="models.html#cb144-106" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhi&quot;</span>, <span class="st">&quot;betaP&quot;</span>, <span class="st">&quot;betaPhiCohort&quot;</span>, <span class="st">&quot;betaPCohort&quot;</span>,</span>
<span id="cb144-107"><a href="models.html#cb144-107" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhiOut&quot;</span>, <span class="st">&quot;betaPOut&quot;</span>, <span class="st">&quot;betaPhiCohortOut&quot;</span>, <span class="st">&quot;betaPCohortOut&quot;</span>, </span>
<span id="cb144-108"><a href="models.html#cb144-108" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaFlow&quot;</span>)  </span>
<span id="cb144-109"><a href="models.html#cb144-109" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">20000</span></span>
<span id="cb144-110"><a href="models.html#cb144-110" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb144-111"><a href="models.html#cb144-111" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb144-112"><a href="models.html#cb144-112" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb144-113"><a href="models.html#cb144-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-114"><a href="models.html#cb144-114" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb144-115"><a href="models.html#cb144-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-116"><a href="models.html#cb144-116" aria-hidden="true" tabindex="-1"></a>  Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb144-117"><a href="models.html#cb144-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> hmm.phiT_pT_cohort_flow, </span>
<span id="cb144-118"><a href="models.html#cb144-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> myConstants,</span>
<span id="cb144-119"><a href="models.html#cb144-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> myData,              </span>
<span id="cb144-120"><a href="models.html#cb144-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb144-121"><a href="models.html#cb144-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb144-122"><a href="models.html#cb144-122" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb144-123"><a href="models.html#cb144-123" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb144-124"><a href="models.html#cb144-124" aria-hidden="true" tabindex="-1"></a>    Rmodel,</span>
<span id="cb144-125"><a href="models.html#cb144-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">monitors =</span> parametersToSave</span>
<span id="cb144-126"><a href="models.html#cb144-126" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb144-127"><a href="models.html#cb144-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-128"><a href="models.html#cb144-128" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb144-129"><a href="models.html#cb144-129" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb144-130"><a href="models.html#cb144-130" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb144-131"><a href="models.html#cb144-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-132"><a href="models.html#cb144-132" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT_cohort_flow <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb144-133"><a href="models.html#cb144-133" aria-hidden="true" tabindex="-1"></a>    Cmcmc, </span>
<span id="cb144-134"><a href="models.html#cb144-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> nIter, </span>
<span id="cb144-135"><a href="models.html#cb144-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb144-136"><a href="models.html#cb144-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> thinRate, </span>
<span id="cb144-137"><a href="models.html#cb144-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nChains</span>
<span id="cb144-138"><a href="models.html#cb144-138" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb144-139"><a href="models.html#cb144-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-140"><a href="models.html#cb144-140" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb144-141"><a href="models.html#cb144-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-142"><a href="models.html#cb144-142" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT_cohort_flow <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb144-143"><a href="models.html#cb144-143" aria-hidden="true" tabindex="-1"></a>  toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb144-144"><a href="models.html#cb144-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">mcmc =</span> mcmc.phiT_pT_cohort_flow, </span>
<span id="cb144-145"><a href="models.html#cb144-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">elapsed =</span> elapsed_phiT_pT_cohort_flow,</span>
<span id="cb144-146"><a href="models.html#cb144-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;phiT_pT_cohort_flow&quot;</span>,</span>
<span id="cb144-147"><a href="models.html#cb144-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">myConstants =</span> myConstants, </span>
<span id="cb144-148"><a href="models.html#cb144-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">nIter =</span> nIter, </span>
<span id="cb144-149"><a href="models.html#cb144-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb144-150"><a href="models.html#cb144-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">thinRate =</span> thinRate, </span>
<span id="cb144-151"><a href="models.html#cb144-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb144-152"><a href="models.html#cb144-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb144-153"><a href="models.html#cb144-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">nChains =</span> nChains</span>
<span id="cb144-154"><a href="models.html#cb144-154" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb144-155"><a href="models.html#cb144-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_flow_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb144-156"><a href="models.html#cb144-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_flow_mostRecent.RData&#39;</span>)</span>
<span id="cb144-157"><a href="models.html#cb144-157" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb144-158"><a href="models.html#cb144-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_flow_mostRecent.RData&#39;</span>)</span>
<span id="cb144-159"><a href="models.html#cb144-159" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb144-160"><a href="models.html#cb144-160" aria-hidden="true" tabindex="-1"></a><span class="co"># could consider forward algo to speed up convergence (https://oliviergimenez.github.io/banana-book/hmmcapturerecapture.html#nimble-implementation-1)</span></span>
<span id="cb144-161"><a href="models.html#cb144-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-162"><a href="models.html#cb144-162" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) {</span>
<span id="cb144-163"><a href="models.html#cb144-163" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCsummary(object = toSave$mcmc, round = 2)</span></span>
<span id="cb144-164"><a href="models.html#cb144-164" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCplot(object = mcmc.phiT_pT_cohort_flow, params = &quot;betaPhiOut&quot;)</span></span>
<span id="cb144-165"><a href="models.html#cb144-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaFlow&quot;</span>)<span class="co"># </span></span>
<span id="cb144-166"><a href="models.html#cb144-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>))</span>
<span id="cb144-167"><a href="models.html#cb144-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPCohortOut&quot;</span>))</span>
<span id="cb144-168"><a href="models.html#cb144-168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-169"><a href="models.html#cb144-169" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb144-170"><a href="models.html#cb144-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb144-171"><a href="models.html#cb144-171" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb144-172"><a href="models.html#cb144-172" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb144-173"><a href="models.html#cb144-173" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>),</span>
<span id="cb144-174"><a href="models.html#cb144-174" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb144-175"><a href="models.html#cb144-175" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb144-176"><a href="models.html#cb144-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-177"><a href="models.html#cb144-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb144-178"><a href="models.html#cb144-178" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb144-179"><a href="models.html#cb144-179" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb144-180"><a href="models.html#cb144-180" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlow&quot;</span>),</span>
<span id="cb144-181"><a href="models.html#cb144-181" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb144-182"><a href="models.html#cb144-182" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb144-183"><a href="models.html#cb144-183" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-5.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-6.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-7.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-8.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-9.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-10.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-11.png" width="672" /></p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="models.html#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run more iterations, if necessary</span></span>
<span id="cb145-2"><a href="models.html#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="co"># nIterAdd &lt;- 5000</span></span>
<span id="cb145-3"><a href="models.html#cb145-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cmcmc$run(nIterAdd, reset = FALSE)</span></span>
<span id="cb145-4"><a href="models.html#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="co"># more_samples &lt;- as.matrix(Cmcmc$mvSamples)</span></span>
<span id="cb145-5"><a href="models.html#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb145-6"><a href="models.html#cb145-6" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMCtrace(object = more_samples,</span></span>
<span id="cb145-7"><a href="models.html#cb145-7" aria-hidden="true" tabindex="-1"></a><span class="co">#           #ISB = FALSE,</span></span>
<span id="cb145-8"><a href="models.html#cb145-8" aria-hidden="true" tabindex="-1"></a><span class="co">#           #exact = TRUE, </span></span>
<span id="cb145-9"><a href="models.html#cb145-9" aria-hidden="true" tabindex="-1"></a><span class="co">#           params = c(&quot;betaFlow&quot;),</span></span>
<span id="cb145-10"><a href="models.html#cb145-10" aria-hidden="true" tabindex="-1"></a><span class="co">#           pdf = FALSE, </span></span>
<span id="cb145-11"><a href="models.html#cb145-11" aria-hidden="true" tabindex="-1"></a><span class="co">#           priors = priors)</span></span></code></pre></div>
<div id="get-flow-effect-estimates" class="section level4 hasAnchor" number="3.3.5.1">
<h4><span class="header-section-number">3.3.5.1</span> Get flow effect estimates<a href="models.html#get-flow-effect-estimates" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Flow effects fixed across cohorts</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="models.html#cb146-1" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaInt +</span></span>
<span id="cb146-2"><a href="models.html#cb146-2" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaPhi[t,cohort[i]] + </span></span>
<span id="cb146-3"><a href="models.html#cb146-3" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[1,season[t]] * flow[i,t] +</span></span>
<span id="cb146-4"><a href="models.html#cb146-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[2,season[t]] * flow[i,t] * flow[i,t]</span></span>
<span id="cb146-5"><a href="models.html#cb146-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-6"><a href="models.html#cb146-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-7"><a href="models.html#cb146-7" aria-hidden="true" tabindex="-1"></a>getPredictionsFlow <span class="ot">&lt;-</span> <span class="cf">function</span>(mcmc, <span class="at">everyNIters =</span> <span class="dv">10</span>, <span class="at">flowStep =</span> <span class="fl">0.5</span>){</span>
<span id="cb146-8"><a href="models.html#cb146-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-9"><a href="models.html#cb146-9" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaInt</span></span>
<span id="cb146-10"><a href="models.html#cb146-10" aria-hidden="true" tabindex="-1"></a>  predictorsBetaInt <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb146-11"><a href="models.html#cb146-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters)</span>
<span id="cb146-12"><a href="models.html#cb146-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb146-13"><a href="models.html#cb146-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaInt)){</span>
<span id="cb146-14"><a href="models.html#cb146-14" aria-hidden="true" tabindex="-1"></a>    predictorsBetaInt<span class="sc">$</span>betaInt[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[ predictorsBetaInt[i, <span class="st">&quot;iter&quot;</span>], <span class="st">&quot;betaInt&quot;</span> ]]</span>
<span id="cb146-15"><a href="models.html#cb146-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb146-16"><a href="models.html#cb146-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-17"><a href="models.html#cb146-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-18"><a href="models.html#cb146-18" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaFlow</span></span>
<span id="cb146-19"><a href="models.html#cb146-19" aria-hidden="true" tabindex="-1"></a>  predictorsBetaFlow <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb146-20"><a href="models.html#cb146-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb146-21"><a href="models.html#cb146-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">season =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nSeasons</span>
<span id="cb146-22"><a href="models.html#cb146-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb146-23"><a href="models.html#cb146-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-24"><a href="models.html#cb146-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaFlow)){</span>
<span id="cb146-25"><a href="models.html#cb146-25" aria-hidden="true" tabindex="-1"></a>    predictorsBetaFlow<span class="sc">$</span>betaFlow1[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaFlow[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb146-26"><a href="models.html#cb146-26" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">paste0</span>(<span class="st">&quot;betaFlow[1, &quot;</span>, predictorsBetaFlow[i, <span class="st">&quot;season&quot;</span>],</span>
<span id="cb146-27"><a href="models.html#cb146-27" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;]&quot;</span>)</span>
<span id="cb146-28"><a href="models.html#cb146-28" aria-hidden="true" tabindex="-1"></a>                                                  ]]</span>
<span id="cb146-29"><a href="models.html#cb146-29" aria-hidden="true" tabindex="-1"></a>    predictorsBetaFlow<span class="sc">$</span>betaFlow2[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaFlow[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb146-30"><a href="models.html#cb146-30" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">paste0</span>(<span class="st">&quot;betaFlow[2, &quot;</span>, predictorsBetaFlow[i, <span class="st">&quot;season&quot;</span>],</span>
<span id="cb146-31"><a href="models.html#cb146-31" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;]&quot;</span>)</span>
<span id="cb146-32"><a href="models.html#cb146-32" aria-hidden="true" tabindex="-1"></a>                                                  ]]</span>
<span id="cb146-33"><a href="models.html#cb146-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb146-34"><a href="models.html#cb146-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-35"><a href="models.html#cb146-35" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaPhi</span></span>
<span id="cb146-36"><a href="models.html#cb146-36" aria-hidden="true" tabindex="-1"></a>  predictorsBetaPhi <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb146-37"><a href="models.html#cb146-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb146-38"><a href="models.html#cb146-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nCohorts</span>
<span id="cb146-39"><a href="models.html#cb146-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb146-40"><a href="models.html#cb146-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaPhi)){</span>
<span id="cb146-41"><a href="models.html#cb146-41" aria-hidden="true" tabindex="-1"></a>    predictorsBetaPhi<span class="sc">$</span>betaPhi[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaPhi[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb146-42"><a href="models.html#cb146-42" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">paste0</span>(<span class="st">&quot;betaPhiCohort[&quot;</span>, predictorsBetaPhi[i, <span class="st">&quot;cohort&quot;</span>],</span>
<span id="cb146-43"><a href="models.html#cb146-43" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;]&quot;</span>)</span>
<span id="cb146-44"><a href="models.html#cb146-44" aria-hidden="true" tabindex="-1"></a>                                                ]]</span>
<span id="cb146-45"><a href="models.html#cb146-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb146-46"><a href="models.html#cb146-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-47"><a href="models.html#cb146-47" aria-hidden="true" tabindex="-1"></a>  predictorsAll <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb146-48"><a href="models.html#cb146-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb146-49"><a href="models.html#cb146-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nCohorts,</span>
<span id="cb146-50"><a href="models.html#cb146-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">season =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nSeasons,</span>
<span id="cb146-51"><a href="models.html#cb146-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">flow =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>, flowStep)</span>
<span id="cb146-52"><a href="models.html#cb146-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb146-53"><a href="models.html#cb146-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-54"><a href="models.html#cb146-54" aria-hidden="true" tabindex="-1"></a>  preds <span class="ot">&lt;-</span> predictorsAll <span class="sc">%&gt;%</span></span>
<span id="cb146-55"><a href="models.html#cb146-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(predictorsBetaInt) <span class="sc">%&gt;%</span></span>
<span id="cb146-56"><a href="models.html#cb146-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(predictorsBetaFlow) <span class="sc">%&gt;%</span></span>
<span id="cb146-57"><a href="models.html#cb146-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(predictorsBetaPhi) <span class="sc">%&gt;%</span></span>
<span id="cb146-58"><a href="models.html#cb146-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">predPhi =</span> <span class="fu">plogis</span>(betaInt <span class="sc">+</span> betaPhi <span class="sc">+</span> betaFlow1 <span class="sc">*</span> flow <span class="sc">+</span> betaFlow2 <span class="sc">*</span> flow<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb146-59"><a href="models.html#cb146-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb146-60"><a href="models.html#cb146-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(preds)</span>
<span id="cb146-61"><a href="models.html#cb146-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb146-62"><a href="models.html#cb146-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-63"><a href="models.html#cb146-63" aria-hidden="true" tabindex="-1"></a>predFlow <span class="ot">&lt;-</span> <span class="fu">getPredictionsFlow</span>(toSave<span class="sc">$</span>mcmc, <span class="at">everyNIters =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="plot-flow-predictions-phit_pt_cohort_flow" class="section level4 hasAnchor" number="3.3.5.2">
<h4><span class="header-section-number">3.3.5.2</span> Plot flow predictions phiT_pT_cohort_flow<a href="models.html#plot-flow-predictions-phit_pt_cohort_flow" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="models.html#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predFlow, <span class="fu">aes</span>(flow, predPhi, <span class="at">group =</span> iter)) <span class="sc">+</span></span>
<span id="cb147-2"><a href="models.html#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.025</span>) <span class="sc">+</span></span>
<span id="cb147-3"><a href="models.html#cb147-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(season <span class="sc">~</span> cohort)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="models.html#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlow %&gt;% filter(season ==1, cohort == 6), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb148-2"><a href="models.html#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.5) +</span></span>
<span id="cb148-3"><a href="models.html#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_grid(cohort ~ season)</span></span>
<span id="cb148-4"><a href="models.html#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb148-5"><a href="models.html#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlow %&gt;% filter(cohort == 3), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb148-6"><a href="models.html#cb148-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.1) +</span></span>
<span id="cb148-7"><a href="models.html#cb148-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap( ~ season)</span></span>
<span id="cb148-8"><a href="models.html#cb148-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb148-9"><a href="models.html#cb148-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlow %&gt;% filter(season ==1), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb148-10"><a href="models.html#cb148-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.1) +</span></span>
<span id="cb148-11"><a href="models.html#cb148-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap(~ cohort)</span></span></code></pre></div>
</div>
</div>
<div id="model-phit_pt_cohort_flowcohort" class="section level3 hasAnchor" number="3.3.6">
<h3><span class="header-section-number">3.3.6</span> Model phiT_pT_cohort_flowCohort<a href="models.html#model-phit_pt_cohort_flowcohort" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Flow effects vary by cohort
#### Set up and run model</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="models.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html</span></span>
<span id="cb149-2"><a href="models.html#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb149-3"><a href="models.html#cb149-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-4"><a href="models.html#cb149-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb149-5"><a href="models.html#cb149-5" aria-hidden="true" tabindex="-1"></a>  nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts))</span>
<span id="cb149-6"><a href="models.html#cb149-6" aria-hidden="true" tabindex="-1"></a>  nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons))</span>
<span id="cb149-7"><a href="models.html#cb149-7" aria-hidden="true" tabindex="-1"></a>  seasonArray <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb149-8"><a href="models.html#cb149-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-9"><a href="models.html#cb149-9" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT_cohort_flowCohort <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb149-10"><a href="models.html#cb149-10" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>                    <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb149-11"><a href="models.html#cb149-11" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                    <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb149-12"><a href="models.html#cb149-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-13"><a href="models.html#cb149-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb149-14"><a href="models.html#cb149-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb149-15"><a href="models.html#cb149-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(phi[t,i]) <span class="ot">&lt;-</span> </span>
<span id="cb149-16"><a href="models.html#cb149-16" aria-hidden="true" tabindex="-1"></a>          betaInt <span class="sc">+</span></span>
<span id="cb149-17"><a href="models.html#cb149-17" aria-hidden="true" tabindex="-1"></a>          betaPhi[t,cohort[i]] <span class="sc">+</span> </span>
<span id="cb149-18"><a href="models.html#cb149-18" aria-hidden="true" tabindex="-1"></a>          betaFlow[<span class="dv">1</span>,season[t],cohort[i]] <span class="sc">*</span> flow[i,t] <span class="sc">+</span></span>
<span id="cb149-19"><a href="models.html#cb149-19" aria-hidden="true" tabindex="-1"></a>          betaFlow[<span class="dv">2</span>,season[t],cohort[i]] <span class="sc">*</span> flow[i,t] <span class="sc">*</span> flow[i,t]</span>
<span id="cb149-20"><a href="models.html#cb149-20" aria-hidden="true" tabindex="-1"></a>           <span class="co"># prior survival</span></span>
<span id="cb149-21"><a href="models.html#cb149-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb149-22"><a href="models.html#cb149-22" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> phi[t,i]         <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb149-23"><a href="models.html#cb149-23" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi[t,i]     <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb149-24"><a href="models.html#cb149-24" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb149-25"><a href="models.html#cb149-25" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb149-26"><a href="models.html#cb149-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb149-27"><a href="models.html#cb149-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(p[t,i]) <span class="ot">&lt;-</span> betaP[t,cohort[i]]             <span class="co"># prior detection</span></span>
<span id="cb149-28"><a href="models.html#cb149-28" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p[t,i]       <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb149-29"><a href="models.html#cb149-29" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> p[t,i]           <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb149-30"><a href="models.html#cb149-30" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb149-31"><a href="models.html#cb149-31" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb149-32"><a href="models.html#cb149-32" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb149-33"><a href="models.html#cb149-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb149-34"><a href="models.html#cb149-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-35"><a href="models.html#cb149-35" aria-hidden="true" tabindex="-1"></a>    betaInt <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb149-36"><a href="models.html#cb149-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-37"><a href="models.html#cb149-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb149-38"><a href="models.html#cb149-38" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mean values</span></span>
<span id="cb149-39"><a href="models.html#cb149-39" aria-hidden="true" tabindex="-1"></a>      betaPhiCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb149-40"><a href="models.html#cb149-40" aria-hidden="true" tabindex="-1"></a>      betaPCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb149-41"><a href="models.html#cb149-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb149-42"><a href="models.html#cb149-42" aria-hidden="true" tabindex="-1"></a>        betaPhi[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiCohort[c], <span class="dv">1</span>)</span>
<span id="cb149-43"><a href="models.html#cb149-43" aria-hidden="true" tabindex="-1"></a>        betaP[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPCohort[c], <span class="dv">1</span>)</span>
<span id="cb149-44"><a href="models.html#cb149-44" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb149-45"><a href="models.html#cb149-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb149-46"><a href="models.html#cb149-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-47"><a href="models.html#cb149-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># back-transform for examining output</span></span>
<span id="cb149-48"><a href="models.html#cb149-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb149-49"><a href="models.html#cb149-49" aria-hidden="true" tabindex="-1"></a>        betaPhiCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhiCohort[c]))</span>
<span id="cb149-50"><a href="models.html#cb149-50" aria-hidden="true" tabindex="-1"></a>        betaPCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPCohort[c]))</span>
<span id="cb149-51"><a href="models.html#cb149-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb149-52"><a href="models.html#cb149-52" aria-hidden="true" tabindex="-1"></a>        betaPhiOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhi[t,c]))</span>
<span id="cb149-53"><a href="models.html#cb149-53" aria-hidden="true" tabindex="-1"></a>        betaPOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaP[t,c])) </span>
<span id="cb149-54"><a href="models.html#cb149-54" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb149-55"><a href="models.html#cb149-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb149-56"><a href="models.html#cb149-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-57"><a href="models.html#cb149-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nSeasons){</span>
<span id="cb149-58"><a href="models.html#cb149-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb149-59"><a href="models.html#cb149-59" aria-hidden="true" tabindex="-1"></a>        betaFlow[<span class="dv">1</span>,s,c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb149-60"><a href="models.html#cb149-60" aria-hidden="true" tabindex="-1"></a>        betaFlow[<span class="dv">2</span>,s,c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb149-61"><a href="models.html#cb149-61" aria-hidden="true" tabindex="-1"></a>      }   </span>
<span id="cb149-62"><a href="models.html#cb149-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb149-63"><a href="models.html#cb149-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-64"><a href="models.html#cb149-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood</span></span>
<span id="cb149-65"><a href="models.html#cb149-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb149-66"><a href="models.html#cb149-66" aria-hidden="true" tabindex="-1"></a>      z[i,first[i]] <span class="sc">~</span> <span class="fu">dcat</span>(delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb149-67"><a href="models.html#cb149-67" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(last[i])){</span>
<span id="cb149-68"><a href="models.html#cb149-68" aria-hidden="true" tabindex="-1"></a>        z[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(gamma[z[i,j<span class="dv">-1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb149-69"><a href="models.html#cb149-69" aria-hidden="true" tabindex="-1"></a>        y[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(omega[z[i,j], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb149-70"><a href="models.html#cb149-70" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb149-71"><a href="models.html#cb149-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb149-72"><a href="models.html#cb149-72" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb149-73"><a href="models.html#cb149-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-74"><a href="models.html#cb149-74" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb149-75"><a href="models.html#cb149-75" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb149-76"><a href="models.html#cb149-76" aria-hidden="true" tabindex="-1"></a>  cohort <span class="ot">=</span> ((eh<span class="sc">$</span>cohorts) <span class="sc">-</span> <span class="fu">min</span>(eh<span class="sc">$</span>cohorts) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">$</span>cohort <span class="co">#can&#39;t be a data frame or tibble</span></span>
<span id="cb149-77"><a href="models.html#cb149-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-78"><a href="models.html#cb149-78" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb149-79"><a href="models.html#cb149-79" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb149-80"><a href="models.html#cb149-80" aria-hidden="true" tabindex="-1"></a>                       <span class="at">first =</span> first,</span>
<span id="cb149-81"><a href="models.html#cb149-81" aria-hidden="true" tabindex="-1"></a>                       <span class="at">last =</span> last,</span>
<span id="cb149-82"><a href="models.html#cb149-82" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cohort =</span> cohort, </span>
<span id="cb149-83"><a href="models.html#cb149-83" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb149-84"><a href="models.html#cb149-84" aria-hidden="true" tabindex="-1"></a>                       <span class="at">season =</span> seasonArray, <span class="co">#eh$seasons$season,</span></span>
<span id="cb149-85"><a href="models.html#cb149-85" aria-hidden="true" tabindex="-1"></a>                       <span class="at">flow =</span> eh<span class="sc">$</span>flow</span>
<span id="cb149-86"><a href="models.html#cb149-86" aria-hidden="true" tabindex="-1"></a>                       )</span>
<span id="cb149-87"><a href="models.html#cb149-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-88"><a href="models.html#cb149-88" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb149-89"><a href="models.html#cb149-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-90"><a href="models.html#cb149-90" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb149-91"><a href="models.html#cb149-91" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb149-92"><a href="models.html#cb149-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-93"><a href="models.html#cb149-93" aria-hidden="true" tabindex="-1"></a>  zInitsNA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(eh<span class="sc">$</span>flow), <span class="cn">NA</span>, <span class="dv">1</span>)</span>
<span id="cb149-94"><a href="models.html#cb149-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-95"><a href="models.html#cb149-95" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(</span>
<span id="cb149-96"><a href="models.html#cb149-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaInt =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb149-97"><a href="models.html#cb149-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb149-98"><a href="models.html#cb149-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb149-99"><a href="models.html#cb149-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">z =</span> zInitsNA,</span>
<span id="cb149-100"><a href="models.html#cb149-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb149-101"><a href="models.html#cb149-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaP =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb149-102"><a href="models.html#cb149-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhiCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb149-103"><a href="models.html#cb149-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPCohort =</span>   <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb149-104"><a href="models.html#cb149-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaFlow =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="dv">4</span> <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, nCohorts))</span>
<span id="cb149-105"><a href="models.html#cb149-105" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb149-106"><a href="models.html#cb149-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-107"><a href="models.html#cb149-107" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;betaInt&quot;</span>, </span>
<span id="cb149-108"><a href="models.html#cb149-108" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhi&quot;</span>, <span class="st">&quot;betaP&quot;</span>, <span class="st">&quot;betaPhiCohort&quot;</span>, <span class="st">&quot;betaPCohort&quot;</span>,</span>
<span id="cb149-109"><a href="models.html#cb149-109" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhiOut&quot;</span>, <span class="st">&quot;betaPOut&quot;</span>, <span class="st">&quot;betaPhiCohortOut&quot;</span>, <span class="st">&quot;betaPCohortOut&quot;</span>, </span>
<span id="cb149-110"><a href="models.html#cb149-110" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaFlow&quot;</span>)  </span>
<span id="cb149-111"><a href="models.html#cb149-111" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">20000</span></span>
<span id="cb149-112"><a href="models.html#cb149-112" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb149-113"><a href="models.html#cb149-113" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb149-114"><a href="models.html#cb149-114" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb149-115"><a href="models.html#cb149-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-116"><a href="models.html#cb149-116" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb149-117"><a href="models.html#cb149-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-118"><a href="models.html#cb149-118" aria-hidden="true" tabindex="-1"></a>  Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb149-119"><a href="models.html#cb149-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> hmm.phiT_pT_cohort_flowCohort, </span>
<span id="cb149-120"><a href="models.html#cb149-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> myConstants,</span>
<span id="cb149-121"><a href="models.html#cb149-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> myData,              </span>
<span id="cb149-122"><a href="models.html#cb149-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb149-123"><a href="models.html#cb149-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb149-124"><a href="models.html#cb149-124" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb149-125"><a href="models.html#cb149-125" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb149-126"><a href="models.html#cb149-126" aria-hidden="true" tabindex="-1"></a>    Rmodel,</span>
<span id="cb149-127"><a href="models.html#cb149-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">monitors =</span> parametersToSave</span>
<span id="cb149-128"><a href="models.html#cb149-128" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb149-129"><a href="models.html#cb149-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-130"><a href="models.html#cb149-130" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb149-131"><a href="models.html#cb149-131" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb149-132"><a href="models.html#cb149-132" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb149-133"><a href="models.html#cb149-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-134"><a href="models.html#cb149-134" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT_cohort_flowCohort <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb149-135"><a href="models.html#cb149-135" aria-hidden="true" tabindex="-1"></a>    Cmcmc, </span>
<span id="cb149-136"><a href="models.html#cb149-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> nIter, </span>
<span id="cb149-137"><a href="models.html#cb149-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb149-138"><a href="models.html#cb149-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> thinRate, </span>
<span id="cb149-139"><a href="models.html#cb149-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nChains</span>
<span id="cb149-140"><a href="models.html#cb149-140" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb149-141"><a href="models.html#cb149-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-142"><a href="models.html#cb149-142" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb149-143"><a href="models.html#cb149-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-144"><a href="models.html#cb149-144" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT_cohort_flowCohort <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb149-145"><a href="models.html#cb149-145" aria-hidden="true" tabindex="-1"></a>  toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb149-146"><a href="models.html#cb149-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">mcmc =</span> mcmc.phiT_pT_cohort_flowCohort, </span>
<span id="cb149-147"><a href="models.html#cb149-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">elapsed =</span> elapsed_phiT_pT_cohort_flowCohort,</span>
<span id="cb149-148"><a href="models.html#cb149-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;phiT_pT_cohort_flowCohort&quot;</span>,</span>
<span id="cb149-149"><a href="models.html#cb149-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">myConstants =</span> myConstants, </span>
<span id="cb149-150"><a href="models.html#cb149-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">nIter =</span> nIter, </span>
<span id="cb149-151"><a href="models.html#cb149-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb149-152"><a href="models.html#cb149-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">thinRate =</span> thinRate, </span>
<span id="cb149-153"><a href="models.html#cb149-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb149-154"><a href="models.html#cb149-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb149-155"><a href="models.html#cb149-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">nChains =</span> nChains</span>
<span id="cb149-156"><a href="models.html#cb149-156" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb149-157"><a href="models.html#cb149-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_flowCohort_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb149-158"><a href="models.html#cb149-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_flowCohort_mostRecent.RData&#39;</span>)</span>
<span id="cb149-159"><a href="models.html#cb149-159" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb149-160"><a href="models.html#cb149-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_flowCohort_mostRecent.RData&#39;</span>)</span>
<span id="cb149-161"><a href="models.html#cb149-161" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb149-162"><a href="models.html#cb149-162" aria-hidden="true" tabindex="-1"></a><span class="co"># could consider forward algo to speed up convergence (https://oliviergimenez.github.io/banana-book/hmmcapturerecapture.html#nimble-implementation-1)</span></span>
<span id="cb149-163"><a href="models.html#cb149-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-164"><a href="models.html#cb149-164" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) {</span>
<span id="cb149-165"><a href="models.html#cb149-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-166"><a href="models.html#cb149-166" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCsummary(object = mcmc.phiT_pT_cohort_flow, round = 2)</span></span>
<span id="cb149-167"><a href="models.html#cb149-167" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCplot(object = mcmc.phiT_pT_cohort_flow, params = &quot;betaPhiOut&quot;)</span></span>
<span id="cb149-168"><a href="models.html#cb149-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaFlow&quot;</span>)<span class="co"># </span></span>
<span id="cb149-169"><a href="models.html#cb149-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>))</span>
<span id="cb149-170"><a href="models.html#cb149-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPCohortOut&quot;</span>))</span>
<span id="cb149-171"><a href="models.html#cb149-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-172"><a href="models.html#cb149-172" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb149-173"><a href="models.html#cb149-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb149-174"><a href="models.html#cb149-174" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb149-175"><a href="models.html#cb149-175" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb149-176"><a href="models.html#cb149-176" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>),</span>
<span id="cb149-177"><a href="models.html#cb149-177" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb149-178"><a href="models.html#cb149-178" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb149-179"><a href="models.html#cb149-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb149-180"><a href="models.html#cb149-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb149-181"><a href="models.html#cb149-181" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb149-182"><a href="models.html#cb149-182" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb149-183"><a href="models.html#cb149-183" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlow&quot;</span>),</span>
<span id="cb149-184"><a href="models.html#cb149-184" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb149-185"><a href="models.html#cb149-185" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb149-186"><a href="models.html#cb149-186" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-5.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-6.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-7.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-8.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-9.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-10.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-11.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-12.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-13.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-14.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-15.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-16.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-17.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-18.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-19.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-20.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-21.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-22.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-23.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-24.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-25.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-26.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-27.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-28.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-29.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-30.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-31.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-32.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-33.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-34.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-35.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-36.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-37.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-38.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-39.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-40.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-41.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-42.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-43.png" width="672" /></p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="models.html#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run more iterations, if necessary</span></span>
<span id="cb150-2"><a href="models.html#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="co"># nIterAdd &lt;- 5000</span></span>
<span id="cb150-3"><a href="models.html#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cmcmc$run(nIterAdd, reset = FALSE)</span></span>
<span id="cb150-4"><a href="models.html#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="co"># more_samples &lt;- as.matrix(Cmcmc$mvSamples)</span></span>
<span id="cb150-5"><a href="models.html#cb150-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb150-6"><a href="models.html#cb150-6" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMCtrace(object = more_samples,</span></span>
<span id="cb150-7"><a href="models.html#cb150-7" aria-hidden="true" tabindex="-1"></a><span class="co">#           #ISB = FALSE,</span></span>
<span id="cb150-8"><a href="models.html#cb150-8" aria-hidden="true" tabindex="-1"></a><span class="co">#           #exact = TRUE, </span></span>
<span id="cb150-9"><a href="models.html#cb150-9" aria-hidden="true" tabindex="-1"></a><span class="co">#           params = c(&quot;betaFlow&quot;),</span></span>
<span id="cb150-10"><a href="models.html#cb150-10" aria-hidden="true" tabindex="-1"></a><span class="co">#           pdf = FALSE, </span></span>
<span id="cb150-11"><a href="models.html#cb150-11" aria-hidden="true" tabindex="-1"></a><span class="co">#           priors = priors)</span></span></code></pre></div>
<div id="get-flow-effect-estimates-1" class="section level4 hasAnchor" number="3.3.6.1">
<h4><span class="header-section-number">3.3.6.1</span> Get flow effect estimates<a href="models.html#get-flow-effect-estimates-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Flow effects vary across cohorts</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="models.html#cb151-1" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaInt +</span></span>
<span id="cb151-2"><a href="models.html#cb151-2" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaPhi[t,cohort[i]] + </span></span>
<span id="cb151-3"><a href="models.html#cb151-3" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[1,season[t],cohort[i]] * flow[i,t] +</span></span>
<span id="cb151-4"><a href="models.html#cb151-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[2,season[t],cohort[i]] * flow[i,t] * flow[i,t]</span></span>
<span id="cb151-5"><a href="models.html#cb151-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-6"><a href="models.html#cb151-6" aria-hidden="true" tabindex="-1"></a><span class="co"># load current flow model</span></span>
<span id="cb151-7"><a href="models.html#cb151-7" aria-hidden="true" tabindex="-1"></a><span class="co">#load(&quot;C:/Users/bletcher/OneDrive - DOI/projects/westBrook-book/models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_flow_2022-05-12 10.RData&quot;)</span></span>
<span id="cb151-8"><a href="models.html#cb151-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-9"><a href="models.html#cb151-9" aria-hidden="true" tabindex="-1"></a>getPredictionsFlowCohort <span class="ot">&lt;-</span> <span class="cf">function</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">10</span>, <span class="at">flowStep =</span> <span class="fl">0.5</span>){</span>
<span id="cb151-10"><a href="models.html#cb151-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-11"><a href="models.html#cb151-11" aria-hidden="true" tabindex="-1"></a>  mcmc <span class="ot">&lt;-</span> toSave<span class="sc">$</span>mcmc</span>
<span id="cb151-12"><a href="models.html#cb151-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaInt</span></span>
<span id="cb151-13"><a href="models.html#cb151-13" aria-hidden="true" tabindex="-1"></a>  predictorsBetaInt <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb151-14"><a href="models.html#cb151-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters)</span>
<span id="cb151-15"><a href="models.html#cb151-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb151-16"><a href="models.html#cb151-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaInt)){</span>
<span id="cb151-17"><a href="models.html#cb151-17" aria-hidden="true" tabindex="-1"></a>    predictorsBetaInt<span class="sc">$</span>betaInt[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[ predictorsBetaInt[i, <span class="st">&quot;iter&quot;</span>], <span class="st">&quot;betaInt&quot;</span> ]]</span>
<span id="cb151-18"><a href="models.html#cb151-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-19"><a href="models.html#cb151-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-20"><a href="models.html#cb151-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-21"><a href="models.html#cb151-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaFlow</span></span>
<span id="cb151-22"><a href="models.html#cb151-22" aria-hidden="true" tabindex="-1"></a>  predictorsBetaFlow <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb151-23"><a href="models.html#cb151-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb151-24"><a href="models.html#cb151-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">season =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nSeasons,</span>
<span id="cb151-25"><a href="models.html#cb151-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nCohorts</span>
<span id="cb151-26"><a href="models.html#cb151-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb151-27"><a href="models.html#cb151-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-28"><a href="models.html#cb151-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaFlow)){</span>
<span id="cb151-29"><a href="models.html#cb151-29" aria-hidden="true" tabindex="-1"></a>    predictorsBetaFlow<span class="sc">$</span>betaFlow1[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaFlow[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb151-30"><a href="models.html#cb151-30" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">paste0</span>(<span class="st">&quot;betaFlow[1, &quot;</span>, predictorsBetaFlow[i, <span class="st">&quot;season&quot;</span>],</span>
<span id="cb151-31"><a href="models.html#cb151-31" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;, &quot;</span>,           predictorsBetaFlow[i, <span class="st">&quot;cohort&quot;</span>],</span>
<span id="cb151-32"><a href="models.html#cb151-32" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;]&quot;</span>)</span>
<span id="cb151-33"><a href="models.html#cb151-33" aria-hidden="true" tabindex="-1"></a>                                                  ]]</span>
<span id="cb151-34"><a href="models.html#cb151-34" aria-hidden="true" tabindex="-1"></a>    predictorsBetaFlow<span class="sc">$</span>betaFlow2[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaFlow[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb151-35"><a href="models.html#cb151-35" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">paste0</span>(<span class="st">&quot;betaFlow[2, &quot;</span>, predictorsBetaFlow[i, <span class="st">&quot;season&quot;</span>],</span>
<span id="cb151-36"><a href="models.html#cb151-36" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;, &quot;</span>,           predictorsBetaFlow[i, <span class="st">&quot;cohort&quot;</span>],</span>
<span id="cb151-37"><a href="models.html#cb151-37" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;]&quot;</span>)</span>
<span id="cb151-38"><a href="models.html#cb151-38" aria-hidden="true" tabindex="-1"></a>                                                  ]]</span>
<span id="cb151-39"><a href="models.html#cb151-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-40"><a href="models.html#cb151-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-41"><a href="models.html#cb151-41" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaPhi</span></span>
<span id="cb151-42"><a href="models.html#cb151-42" aria-hidden="true" tabindex="-1"></a>  predictorsBetaPhi <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb151-43"><a href="models.html#cb151-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb151-44"><a href="models.html#cb151-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nCohorts</span>
<span id="cb151-45"><a href="models.html#cb151-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb151-46"><a href="models.html#cb151-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-47"><a href="models.html#cb151-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this step is very slow for some reason......</span></span>
<span id="cb151-48"><a href="models.html#cb151-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaPhi)){</span>
<span id="cb151-49"><a href="models.html#cb151-49" aria-hidden="true" tabindex="-1"></a>    predictorsBetaPhi<span class="sc">$</span>betaPhi[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaPhi[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb151-50"><a href="models.html#cb151-50" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">paste0</span>(<span class="st">&quot;betaPhiCohort[&quot;</span>, predictorsBetaPhi[i, <span class="st">&quot;cohort&quot;</span>],</span>
<span id="cb151-51"><a href="models.html#cb151-51" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;]&quot;</span>)</span>
<span id="cb151-52"><a href="models.html#cb151-52" aria-hidden="true" tabindex="-1"></a>                                                ]]</span>
<span id="cb151-53"><a href="models.html#cb151-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-54"><a href="models.html#cb151-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-55"><a href="models.html#cb151-55" aria-hidden="true" tabindex="-1"></a>  predictorsAll <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb151-56"><a href="models.html#cb151-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb151-57"><a href="models.html#cb151-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nCohorts,</span>
<span id="cb151-58"><a href="models.html#cb151-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">season =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nSeasons,</span>
<span id="cb151-59"><a href="models.html#cb151-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">flow =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>, flowStep)</span>
<span id="cb151-60"><a href="models.html#cb151-60" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb151-61"><a href="models.html#cb151-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-62"><a href="models.html#cb151-62" aria-hidden="true" tabindex="-1"></a>  preds <span class="ot">&lt;-</span> predictorsAll <span class="sc">%&gt;%</span></span>
<span id="cb151-63"><a href="models.html#cb151-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(predictorsBetaInt) <span class="sc">%&gt;%</span></span>
<span id="cb151-64"><a href="models.html#cb151-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(predictorsBetaFlow) <span class="sc">%&gt;%</span></span>
<span id="cb151-65"><a href="models.html#cb151-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(predictorsBetaPhi) <span class="sc">%&gt;%</span></span>
<span id="cb151-66"><a href="models.html#cb151-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">predPhi =</span> <span class="fu">plogis</span>(betaInt <span class="sc">+</span> betaPhi <span class="sc">+</span> betaFlow1 <span class="sc">*</span> flow <span class="sc">+</span> betaFlow2 <span class="sc">*</span> flow<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb151-67"><a href="models.html#cb151-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-68"><a href="models.html#cb151-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(preds)</span>
<span id="cb151-69"><a href="models.html#cb151-69" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb151-70"><a href="models.html#cb151-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-71"><a href="models.html#cb151-71" aria-hidden="true" tabindex="-1"></a>predFlowCohort <span class="ot">&lt;-</span> <span class="fu">getPredictionsFlowCohort</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="plot-flow-predictions-phit_pt_cohort_flowcohort" class="section level4 hasAnchor" number="3.3.6.2">
<h4><span class="header-section-number">3.3.6.2</span> Plot flow predictions phiT_pT_cohort_flowCohort<a href="models.html#plot-flow-predictions-phit_pt_cohort_flowcohort" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="models.html#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predFlowCohort, <span class="fu">aes</span>(flow, predPhi, <span class="at">group =</span> iter)) <span class="sc">+</span></span>
<span id="cb152-2"><a href="models.html#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.025</span>) <span class="sc">+</span></span>
<span id="cb152-3"><a href="models.html#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(season <span class="sc">~</span> cohort)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="models.html#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohort %&gt;% filter(season ==1, cohort == 6), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb153-2"><a href="models.html#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.5) +</span></span>
<span id="cb153-3"><a href="models.html#cb153-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_grid(cohort ~ season)</span></span>
<span id="cb153-4"><a href="models.html#cb153-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb153-5"><a href="models.html#cb153-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohort %&gt;% filter(cohort == 3), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb153-6"><a href="models.html#cb153-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.1) +</span></span>
<span id="cb153-7"><a href="models.html#cb153-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap( ~ season)</span></span>
<span id="cb153-8"><a href="models.html#cb153-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb153-9"><a href="models.html#cb153-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohort %&gt;% filter(season ==1), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb153-10"><a href="models.html#cb153-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.1) +</span></span>
<span id="cb153-11"><a href="models.html#cb153-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap(~ cohort)</span></span></code></pre></div>
</div>
</div>
<div id="model-phit_pt_cohort_flowcohorthier" class="section level3 hasAnchor" number="3.3.7">
<h3><span class="header-section-number">3.3.7</span> Model phiT_pT_cohort_flowCohortHier<a href="models.html#model-phit_pt_cohort_flowcohorthier" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Flow effects vary by cohort, hierarchical across cohorts
#### Set up and run model</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="models.html#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html</span></span>
<span id="cb154-2"><a href="models.html#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb154-3"><a href="models.html#cb154-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-4"><a href="models.html#cb154-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb154-5"><a href="models.html#cb154-5" aria-hidden="true" tabindex="-1"></a>  nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts))</span>
<span id="cb154-6"><a href="models.html#cb154-6" aria-hidden="true" tabindex="-1"></a>  nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons))</span>
<span id="cb154-7"><a href="models.html#cb154-7" aria-hidden="true" tabindex="-1"></a>  seasonArray <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb154-8"><a href="models.html#cb154-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-9"><a href="models.html#cb154-9" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT_cohort_flowCohortHier <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb154-10"><a href="models.html#cb154-10" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>                    <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb154-11"><a href="models.html#cb154-11" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                    <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb154-12"><a href="models.html#cb154-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-13"><a href="models.html#cb154-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb154-14"><a href="models.html#cb154-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb154-15"><a href="models.html#cb154-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(phi[t,i]) <span class="ot">&lt;-</span> </span>
<span id="cb154-16"><a href="models.html#cb154-16" aria-hidden="true" tabindex="-1"></a>          betaInt <span class="sc">+</span></span>
<span id="cb154-17"><a href="models.html#cb154-17" aria-hidden="true" tabindex="-1"></a>          betaPhi[t,cohort[i]] <span class="sc">+</span> </span>
<span id="cb154-18"><a href="models.html#cb154-18" aria-hidden="true" tabindex="-1"></a>          betaFlow[<span class="dv">1</span>,season[t],cohort[i]] <span class="sc">*</span> flow[i,t] <span class="sc">+</span></span>
<span id="cb154-19"><a href="models.html#cb154-19" aria-hidden="true" tabindex="-1"></a>          betaFlow[<span class="dv">2</span>,season[t],cohort[i]] <span class="sc">*</span> flow[i,t] <span class="sc">*</span> flow[i,t]</span>
<span id="cb154-20"><a href="models.html#cb154-20" aria-hidden="true" tabindex="-1"></a>           <span class="co"># prior survival</span></span>
<span id="cb154-21"><a href="models.html#cb154-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb154-22"><a href="models.html#cb154-22" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> phi[t,i]         <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb154-23"><a href="models.html#cb154-23" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi[t,i]     <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb154-24"><a href="models.html#cb154-24" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb154-25"><a href="models.html#cb154-25" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb154-26"><a href="models.html#cb154-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb154-27"><a href="models.html#cb154-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(p[t,i]) <span class="ot">&lt;-</span> betaP[t,cohort[i]]             <span class="co"># prior detection</span></span>
<span id="cb154-28"><a href="models.html#cb154-28" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p[t,i]       <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb154-29"><a href="models.html#cb154-29" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> p[t,i]           <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb154-30"><a href="models.html#cb154-30" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb154-31"><a href="models.html#cb154-31" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb154-32"><a href="models.html#cb154-32" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb154-33"><a href="models.html#cb154-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb154-34"><a href="models.html#cb154-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-35"><a href="models.html#cb154-35" aria-hidden="true" tabindex="-1"></a>    betaInt <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb154-36"><a href="models.html#cb154-36" aria-hidden="true" tabindex="-1"></a>    betaFlowTop[<span class="dv">1</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb154-37"><a href="models.html#cb154-37" aria-hidden="true" tabindex="-1"></a>    betaFlowTop[<span class="dv">2</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb154-38"><a href="models.html#cb154-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-39"><a href="models.html#cb154-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb154-40"><a href="models.html#cb154-40" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mean values</span></span>
<span id="cb154-41"><a href="models.html#cb154-41" aria-hidden="true" tabindex="-1"></a>      betaPhiCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb154-42"><a href="models.html#cb154-42" aria-hidden="true" tabindex="-1"></a>      betaPCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb154-43"><a href="models.html#cb154-43" aria-hidden="true" tabindex="-1"></a>      betaFlowCohort[<span class="dv">1</span>,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowTop[<span class="dv">1</span>],<span class="dv">1</span>)</span>
<span id="cb154-44"><a href="models.html#cb154-44" aria-hidden="true" tabindex="-1"></a>      betaFlowCohort[<span class="dv">2</span>,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowTop[<span class="dv">2</span>],<span class="dv">1</span>)</span>
<span id="cb154-45"><a href="models.html#cb154-45" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb154-46"><a href="models.html#cb154-46" aria-hidden="true" tabindex="-1"></a>        betaPhi[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiCohort[c],<span class="dv">1</span>)</span>
<span id="cb154-47"><a href="models.html#cb154-47" aria-hidden="true" tabindex="-1"></a>        betaP[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPCohort[c],<span class="dv">1</span>)</span>
<span id="cb154-48"><a href="models.html#cb154-48" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb154-49"><a href="models.html#cb154-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb154-50"><a href="models.html#cb154-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-51"><a href="models.html#cb154-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># back-transform for examining output</span></span>
<span id="cb154-52"><a href="models.html#cb154-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb154-53"><a href="models.html#cb154-53" aria-hidden="true" tabindex="-1"></a>        betaPhiCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhiCohort[c]))</span>
<span id="cb154-54"><a href="models.html#cb154-54" aria-hidden="true" tabindex="-1"></a>        betaPCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPCohort[c]))</span>
<span id="cb154-55"><a href="models.html#cb154-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb154-56"><a href="models.html#cb154-56" aria-hidden="true" tabindex="-1"></a>        betaPhiOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhi[t,c]))</span>
<span id="cb154-57"><a href="models.html#cb154-57" aria-hidden="true" tabindex="-1"></a>        betaPOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaP[t,c])) </span>
<span id="cb154-58"><a href="models.html#cb154-58" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb154-59"><a href="models.html#cb154-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb154-60"><a href="models.html#cb154-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-61"><a href="models.html#cb154-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nSeasons){</span>
<span id="cb154-62"><a href="models.html#cb154-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb154-63"><a href="models.html#cb154-63" aria-hidden="true" tabindex="-1"></a>        betaFlow[<span class="dv">1</span>,s,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowCohort[<span class="dv">1</span>,c],<span class="dv">1</span>)</span>
<span id="cb154-64"><a href="models.html#cb154-64" aria-hidden="true" tabindex="-1"></a>        betaFlow[<span class="dv">2</span>,s,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowCohort[<span class="dv">2</span>,c],<span class="dv">1</span>)</span>
<span id="cb154-65"><a href="models.html#cb154-65" aria-hidden="true" tabindex="-1"></a>      }   </span>
<span id="cb154-66"><a href="models.html#cb154-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb154-67"><a href="models.html#cb154-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-68"><a href="models.html#cb154-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood</span></span>
<span id="cb154-69"><a href="models.html#cb154-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb154-70"><a href="models.html#cb154-70" aria-hidden="true" tabindex="-1"></a>      z[i,first[i]] <span class="sc">~</span> <span class="fu">dcat</span>(delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb154-71"><a href="models.html#cb154-71" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(last[i])){</span>
<span id="cb154-72"><a href="models.html#cb154-72" aria-hidden="true" tabindex="-1"></a>        z[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(gamma[z[i,j<span class="dv">-1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb154-73"><a href="models.html#cb154-73" aria-hidden="true" tabindex="-1"></a>        y[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(omega[z[i,j], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb154-74"><a href="models.html#cb154-74" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb154-75"><a href="models.html#cb154-75" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb154-76"><a href="models.html#cb154-76" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb154-77"><a href="models.html#cb154-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb154-78"><a href="models.html#cb154-78" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb154-79"><a href="models.html#cb154-79" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb154-80"><a href="models.html#cb154-80" aria-hidden="true" tabindex="-1"></a>  cohort <span class="ot">=</span> ((eh<span class="sc">$</span>cohorts) <span class="sc">-</span> <span class="fu">min</span>(eh<span class="sc">$</span>cohorts) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">$</span>cohort <span class="co">#can&#39;t be a data frame or tibble</span></span>
<span id="cb154-81"><a href="models.html#cb154-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-82"><a href="models.html#cb154-82" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb154-83"><a href="models.html#cb154-83" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb154-84"><a href="models.html#cb154-84" aria-hidden="true" tabindex="-1"></a>                       <span class="at">first =</span> first,</span>
<span id="cb154-85"><a href="models.html#cb154-85" aria-hidden="true" tabindex="-1"></a>                       <span class="at">last =</span> last,</span>
<span id="cb154-86"><a href="models.html#cb154-86" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cohort =</span> cohort, </span>
<span id="cb154-87"><a href="models.html#cb154-87" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb154-88"><a href="models.html#cb154-88" aria-hidden="true" tabindex="-1"></a>                       <span class="at">season =</span> seasonArray, <span class="co">#eh$seasons$season,</span></span>
<span id="cb154-89"><a href="models.html#cb154-89" aria-hidden="true" tabindex="-1"></a>                       <span class="at">flow =</span> eh<span class="sc">$</span>flow</span>
<span id="cb154-90"><a href="models.html#cb154-90" aria-hidden="true" tabindex="-1"></a>                       )</span>
<span id="cb154-91"><a href="models.html#cb154-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-92"><a href="models.html#cb154-92" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb154-93"><a href="models.html#cb154-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-94"><a href="models.html#cb154-94" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb154-95"><a href="models.html#cb154-95" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb154-96"><a href="models.html#cb154-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-97"><a href="models.html#cb154-97" aria-hidden="true" tabindex="-1"></a>  zInitsNA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(eh<span class="sc">$</span>flow), <span class="cn">NA</span>, <span class="dv">1</span>)</span>
<span id="cb154-98"><a href="models.html#cb154-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-99"><a href="models.html#cb154-99" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(</span>
<span id="cb154-100"><a href="models.html#cb154-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaInt =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb154-101"><a href="models.html#cb154-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb154-102"><a href="models.html#cb154-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb154-103"><a href="models.html#cb154-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">z =</span> zInitsNA,</span>
<span id="cb154-104"><a href="models.html#cb154-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb154-105"><a href="models.html#cb154-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaP =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb154-106"><a href="models.html#cb154-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhiCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb154-107"><a href="models.html#cb154-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPCohort =</span>   <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb154-108"><a href="models.html#cb154-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaFlow =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="dv">4</span> <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, nCohorts)),</span>
<span id="cb154-109"><a href="models.html#cb154-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaFlowCohort =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(<span class="dv">2</span> <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">2</span>, nCohorts)),</span>
<span id="cb154-110"><a href="models.html#cb154-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaFlowTop =</span> <span class="fu">rnorm</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb154-111"><a href="models.html#cb154-111" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb154-112"><a href="models.html#cb154-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-113"><a href="models.html#cb154-113" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;betaInt&quot;</span>, </span>
<span id="cb154-114"><a href="models.html#cb154-114" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhi&quot;</span>, <span class="st">&quot;betaP&quot;</span>, <span class="st">&quot;betaPhiCohort&quot;</span>, <span class="st">&quot;betaPCohort&quot;</span>,</span>
<span id="cb154-115"><a href="models.html#cb154-115" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhiOut&quot;</span>, <span class="st">&quot;betaPOut&quot;</span>, <span class="st">&quot;betaPhiCohortOut&quot;</span>, <span class="st">&quot;betaPCohortOut&quot;</span>, </span>
<span id="cb154-116"><a href="models.html#cb154-116" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaFlow&quot;</span>,</span>
<span id="cb154-117"><a href="models.html#cb154-117" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaFlowCohort&quot;</span>, <span class="st">&quot;betaFlowTop&quot;</span>)  </span>
<span id="cb154-118"><a href="models.html#cb154-118" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">30000</span></span>
<span id="cb154-119"><a href="models.html#cb154-119" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">15000</span></span>
<span id="cb154-120"><a href="models.html#cb154-120" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb154-121"><a href="models.html#cb154-121" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb154-122"><a href="models.html#cb154-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-123"><a href="models.html#cb154-123" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb154-124"><a href="models.html#cb154-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-125"><a href="models.html#cb154-125" aria-hidden="true" tabindex="-1"></a>  Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb154-126"><a href="models.html#cb154-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> hmm.phiT_pT_cohort_flowCohortHier, </span>
<span id="cb154-127"><a href="models.html#cb154-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> myConstants,</span>
<span id="cb154-128"><a href="models.html#cb154-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> myData,              </span>
<span id="cb154-129"><a href="models.html#cb154-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb154-130"><a href="models.html#cb154-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb154-131"><a href="models.html#cb154-131" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb154-132"><a href="models.html#cb154-132" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb154-133"><a href="models.html#cb154-133" aria-hidden="true" tabindex="-1"></a>    Rmodel,</span>
<span id="cb154-134"><a href="models.html#cb154-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">monitors =</span> parametersToSave</span>
<span id="cb154-135"><a href="models.html#cb154-135" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb154-136"><a href="models.html#cb154-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-137"><a href="models.html#cb154-137" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb154-138"><a href="models.html#cb154-138" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb154-139"><a href="models.html#cb154-139" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb154-140"><a href="models.html#cb154-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-141"><a href="models.html#cb154-141" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT_cohort_flowCohortHier <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb154-142"><a href="models.html#cb154-142" aria-hidden="true" tabindex="-1"></a>    Cmcmc, </span>
<span id="cb154-143"><a href="models.html#cb154-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> nIter, </span>
<span id="cb154-144"><a href="models.html#cb154-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb154-145"><a href="models.html#cb154-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> thinRate, </span>
<span id="cb154-146"><a href="models.html#cb154-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nChains</span>
<span id="cb154-147"><a href="models.html#cb154-147" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb154-148"><a href="models.html#cb154-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-149"><a href="models.html#cb154-149" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb154-150"><a href="models.html#cb154-150" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-151"><a href="models.html#cb154-151" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT_cohort_flowCohortHier <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb154-152"><a href="models.html#cb154-152" aria-hidden="true" tabindex="-1"></a>  toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb154-153"><a href="models.html#cb154-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">mcmc =</span> mcmc.phiT_pT_cohort_flowCohortHier, </span>
<span id="cb154-154"><a href="models.html#cb154-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">elapsed =</span> elapsed_phiT_pT_cohort_flowCohortHier,</span>
<span id="cb154-155"><a href="models.html#cb154-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;phiT_pT_cohort_flowCohortHier&quot;</span>,</span>
<span id="cb154-156"><a href="models.html#cb154-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">myConstants =</span> myConstants, </span>
<span id="cb154-157"><a href="models.html#cb154-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">nIter =</span> nIter, </span>
<span id="cb154-158"><a href="models.html#cb154-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb154-159"><a href="models.html#cb154-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">thinRate =</span> thinRate, </span>
<span id="cb154-160"><a href="models.html#cb154-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb154-161"><a href="models.html#cb154-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb154-162"><a href="models.html#cb154-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">nChains =</span> nChains</span>
<span id="cb154-163"><a href="models.html#cb154-163" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb154-164"><a href="models.html#cb154-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_flowCohortHier_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb154-165"><a href="models.html#cb154-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_flowCohortHier_mostRecent.RData&#39;</span>)</span>
<span id="cb154-166"><a href="models.html#cb154-166" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb154-167"><a href="models.html#cb154-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_flowCohortHier_mostRecent.RData&#39;</span>)</span>
<span id="cb154-168"><a href="models.html#cb154-168" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb154-169"><a href="models.html#cb154-169" aria-hidden="true" tabindex="-1"></a><span class="co"># could consider forward algo to speed up convergence (https://oliviergimenez.github.io/banana-book/hmmcapturerecapture.html#nimble-implementation-1)</span></span>
<span id="cb154-170"><a href="models.html#cb154-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-171"><a href="models.html#cb154-171" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) {</span>
<span id="cb154-172"><a href="models.html#cb154-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-173"><a href="models.html#cb154-173" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCsummary(object = mcmc.phiT_pT_cohort_flowHier, round = 2)</span></span>
<span id="cb154-174"><a href="models.html#cb154-174" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCplot(object = mcmc.phiT_pT_cohort_flowHier, params = &quot;betaPhiOut&quot;)</span></span>
<span id="cb154-175"><a href="models.html#cb154-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaFlowTop&quot;</span>)</span>
<span id="cb154-176"><a href="models.html#cb154-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaFlow&quot;</span>)<span class="co"># </span></span>
<span id="cb154-177"><a href="models.html#cb154-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>))</span>
<span id="cb154-178"><a href="models.html#cb154-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPCohortOut&quot;</span>))</span>
<span id="cb154-179"><a href="models.html#cb154-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlowCohort&quot;</span>))</span>
<span id="cb154-180"><a href="models.html#cb154-180" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-181"><a href="models.html#cb154-181" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb154-182"><a href="models.html#cb154-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb154-183"><a href="models.html#cb154-183" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb154-184"><a href="models.html#cb154-184" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb154-185"><a href="models.html#cb154-185" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlowTop&quot;</span>),</span>
<span id="cb154-186"><a href="models.html#cb154-186" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb154-187"><a href="models.html#cb154-187" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb154-188"><a href="models.html#cb154-188" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-189"><a href="models.html#cb154-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb154-190"><a href="models.html#cb154-190" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb154-191"><a href="models.html#cb154-191" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb154-192"><a href="models.html#cb154-192" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>),</span>
<span id="cb154-193"><a href="models.html#cb154-193" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb154-194"><a href="models.html#cb154-194" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb154-195"><a href="models.html#cb154-195" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-196"><a href="models.html#cb154-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb154-197"><a href="models.html#cb154-197" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb154-198"><a href="models.html#cb154-198" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb154-199"><a href="models.html#cb154-199" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlow&quot;</span>),</span>
<span id="cb154-200"><a href="models.html#cb154-200" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb154-201"><a href="models.html#cb154-201" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb154-202"><a href="models.html#cb154-202" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-5.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-6.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-7.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-8.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-9.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-10.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-11.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-12.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-13.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-14.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-15.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-16.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-17.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-18.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-19.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-20.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-21.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-22.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-23.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-24.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-25.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-26.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-27.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-28.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-29.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-30.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-31.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-32.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-33.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-34.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-35.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-36.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-37.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-38.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-39.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-40.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-41.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-42.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-43.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-44.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-45.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-46.png" width="672" /></p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="models.html#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run more iterations, if necessary</span></span>
<span id="cb155-2"><a href="models.html#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="co"># nIterAdd &lt;- 5000</span></span>
<span id="cb155-3"><a href="models.html#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cmcmc$run(nIterAdd, reset = FALSE)</span></span>
<span id="cb155-4"><a href="models.html#cb155-4" aria-hidden="true" tabindex="-1"></a><span class="co"># more_samples &lt;- as.matrix(Cmcmc$mvSamples)</span></span>
<span id="cb155-5"><a href="models.html#cb155-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb155-6"><a href="models.html#cb155-6" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMCtrace(object = more_samples,</span></span>
<span id="cb155-7"><a href="models.html#cb155-7" aria-hidden="true" tabindex="-1"></a><span class="co">#           #ISB = FALSE,</span></span>
<span id="cb155-8"><a href="models.html#cb155-8" aria-hidden="true" tabindex="-1"></a><span class="co">#           #exact = TRUE, </span></span>
<span id="cb155-9"><a href="models.html#cb155-9" aria-hidden="true" tabindex="-1"></a><span class="co">#           params = c(&quot;betaFlow&quot;),</span></span>
<span id="cb155-10"><a href="models.html#cb155-10" aria-hidden="true" tabindex="-1"></a><span class="co">#           pdf = FALSE, </span></span>
<span id="cb155-11"><a href="models.html#cb155-11" aria-hidden="true" tabindex="-1"></a><span class="co">#           priors = priors)</span></span></code></pre></div>
<div id="get-flow-effect-estimates-2" class="section level4 hasAnchor" number="3.3.7.1">
<h4><span class="header-section-number">3.3.7.1</span> Get flow effect estimates<a href="models.html#get-flow-effect-estimates-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Flow effects vary across cohorts - hierarchical</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="models.html#cb156-1" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaInt +</span></span>
<span id="cb156-2"><a href="models.html#cb156-2" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaPhi[t,cohort[i]] + </span></span>
<span id="cb156-3"><a href="models.html#cb156-3" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[1,season[t],cohort[i]] * flow[i,t] +</span></span>
<span id="cb156-4"><a href="models.html#cb156-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[2,season[t],cohort[i]] * flow[i,t] * flow[i,t]</span></span>
<span id="cb156-5"><a href="models.html#cb156-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-6"><a href="models.html#cb156-6" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowWB/runsOut/mcmc_phiT_pT_cohort_flowCohortHier_mostRecent.RData&#39;</span>)</span>
<span id="cb156-7"><a href="models.html#cb156-7" aria-hidden="true" tabindex="-1"></a>predFlowCohortHier <span class="ot">&lt;-</span> <span class="fu">getPredictionsFlowCohort</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="plot-predictions" class="section level4 hasAnchor" number="3.3.7.2">
<h4><span class="header-section-number">3.3.7.2</span> Plot predictions<a href="models.html#plot-predictions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="models.html#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predFlowCohortHier, <span class="fu">aes</span>(flow, predPhi, <span class="at">group =</span> iter)) <span class="sc">+</span></span>
<span id="cb157-2"><a href="models.html#cb157-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.025</span>) <span class="sc">+</span></span>
<span id="cb157-3"><a href="models.html#cb157-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(season <span class="sc">~</span> cohort)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="models.html#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohortHier %&gt;% filter(season ==1, cohort == 6), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb158-2"><a href="models.html#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.5) +</span></span>
<span id="cb158-3"><a href="models.html#cb158-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_grid(cohort ~ season)</span></span>
<span id="cb158-4"><a href="models.html#cb158-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb158-5"><a href="models.html#cb158-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohortHier %&gt;% filter(cohort == 3), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb158-6"><a href="models.html#cb158-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.1) +</span></span>
<span id="cb158-7"><a href="models.html#cb158-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap( ~ season)</span></span>
<span id="cb158-8"><a href="models.html#cb158-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb158-9"><a href="models.html#cb158-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohortHier %&gt;% filter(season ==3), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb158-10"><a href="models.html#cb158-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_line(alpha = 0.1) +</span></span>
<span id="cb158-11"><a href="models.html#cb158-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># facet_wrap(~ cohort)</span></span></code></pre></div>
</div>
<div id="betaflowtop-predictions" class="section level4 hasAnchor" number="3.3.7.3">
<h4><span class="header-section-number">3.3.7.3</span> BetaflowTop predictions<a href="models.html#betaflowtop-predictions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="models.html#cb159-1" aria-hidden="true" tabindex="-1"></a>getPredictionsFlowTop <span class="ot">&lt;-</span> <span class="cf">function</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">10</span>, <span class="at">flowStep =</span> <span class="fl">0.5</span>){</span>
<span id="cb159-2"><a href="models.html#cb159-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-3"><a href="models.html#cb159-3" aria-hidden="true" tabindex="-1"></a>  mcmc <span class="ot">&lt;-</span> toSave<span class="sc">$</span>mcmc</span>
<span id="cb159-4"><a href="models.html#cb159-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-5"><a href="models.html#cb159-5" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaFlow</span></span>
<span id="cb159-6"><a href="models.html#cb159-6" aria-hidden="true" tabindex="-1"></a>  predictorsBetaFlowTop <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb159-7"><a href="models.html#cb159-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb159-8"><a href="models.html#cb159-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,</span>
<span id="cb159-9"><a href="models.html#cb159-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">flow =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>, flowStep)</span>
<span id="cb159-10"><a href="models.html#cb159-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb159-11"><a href="models.html#cb159-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-12"><a href="models.html#cb159-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaFlowTop)){</span>
<span id="cb159-13"><a href="models.html#cb159-13" aria-hidden="true" tabindex="-1"></a>    predictorsBetaFlowTop<span class="sc">$</span>betaFlowTop1[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaFlowTop[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb159-14"><a href="models.html#cb159-14" aria-hidden="true" tabindex="-1"></a>                                                         <span class="dv">1</span></span>
<span id="cb159-15"><a href="models.html#cb159-15" aria-hidden="true" tabindex="-1"></a>                                                        ]]</span>
<span id="cb159-16"><a href="models.html#cb159-16" aria-hidden="true" tabindex="-1"></a>    predictorsBetaFlowTop<span class="sc">$</span>betaFlowTop2[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaFlowTop[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb159-17"><a href="models.html#cb159-17" aria-hidden="true" tabindex="-1"></a>                                                         <span class="dv">2</span></span>
<span id="cb159-18"><a href="models.html#cb159-18" aria-hidden="true" tabindex="-1"></a>                                                        ]]</span>
<span id="cb159-19"><a href="models.html#cb159-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb159-20"><a href="models.html#cb159-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-21"><a href="models.html#cb159-21" aria-hidden="true" tabindex="-1"></a>  preds <span class="ot">&lt;-</span> predictorsBetaFlowTop <span class="sc">%&gt;%</span></span>
<span id="cb159-22"><a href="models.html#cb159-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">predPhi =</span> <span class="fu">plogis</span>(betaFlowTop1 <span class="sc">*</span> flow <span class="sc">+</span> betaFlowTop2 <span class="sc">*</span> flow <span class="sc">*</span> flow))</span>
<span id="cb159-23"><a href="models.html#cb159-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb159-24"><a href="models.html#cb159-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(preds)</span>
<span id="cb159-25"><a href="models.html#cb159-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb159-26"><a href="models.html#cb159-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-27"><a href="models.html#cb159-27" aria-hidden="true" tabindex="-1"></a>predBetaFlowTop <span class="ot">&lt;-</span> <span class="fu">getPredictionsFlowTop</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">10</span>)</span>
<span id="cb159-28"><a href="models.html#cb159-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-29"><a href="models.html#cb159-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predBetaFlowTop, <span class="fu">aes</span>(flow, predPhi, <span class="at">group =</span> iter)) <span class="sc">+</span></span>
<span id="cb159-30"><a href="models.html#cb159-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="co">#+</span></span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="models.html#cb160-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#facet_wrap(~iter)</span></span>
<span id="cb160-2"><a href="models.html#cb160-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-3"><a href="models.html#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predBetaFlowTop, <span class="fu">aes</span>(betaFlowTop1, betaFlowTop2)) <span class="sc">+</span></span>
<span id="cb160-4"><a href="models.html#cb160-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-18-2.png" width="672" /></p>
</div>
</div>
<div id="compare-models" class="section level3 hasAnchor" number="3.3.8">
<h3><span class="header-section-number">3.3.8</span> Compare models<a href="models.html#compare-models" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="models.html#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co">#data.frame(model = c(&quot;(phi,p)&quot;,</span></span>
<span id="cb161-2"><a href="models.html#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="co">#                     &quot;(phit,pt)&quot;),</span></span>
<span id="cb161-3"><a href="models.html#cb161-3" aria-hidden="true" tabindex="-1"></a><span class="co">#           WAIC = c(mcmc.phi_p, </span></span>
<span id="cb161-4"><a href="models.html#cb161-4" aria-hidden="true" tabindex="-1"></a><span class="co">#                    mcmc.phiT_pT))</span></span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="getData.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="final-words.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["westBrook-book.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
